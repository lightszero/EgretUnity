var egret3d;!function(t){var e=function(){function t(){}return t}();t.DrawMode=e;var i=function(){function i(){}return i.requstContext3D=function(a,r,s){if(console.log("requst GPU Config",a),!this.context3D||this.context3D&&!this.context3D.isLost)switch(a){case i.OpenGLES_2_0:var n=i.requestWEBGL(r);i.context3D=new t.Context3DChild_OpenGLES_2_0(n);var o=n.getExtension("WEBGL_compressed_texture_s3tc");n.getExtension("OES_texture_float_linear"),n.getExtension("OES_texture_float"),n.getExtension("OES_texture_half_float"),n.getExtension("OES_texture_half_float_linear"),n.getExtension("OES_standard_derivatives"),n.getExtension("WEBGL_draw_buffers"),n.getExtension("WEBGL_depth_texture");i.BLEND=n.BLEND,e.TRIANGLES=n.TRIANGLES,e.POINTS=n.POINTS,e.LINES=n.LINES,e.LINE_STRIP=n.LINE_STRIP,i.FLOAT=n.FLOAT,i.VERTEX_SHADER=n.VERTEX_SHADER,i.FRAGMENT_SHADER=n.FRAGMENT_SHADER,i.canvasRectangle=r,i.FRONT=n.FRONT,i.BACK=n.BACK,i.DEPTH_BUFFER_BIT=n.DEPTH_BUFFER_BIT,i.ELEMENT_ARRAY_BUFFER=n.ELEMENT_ARRAY_BUFFER,i.UNSIGNED_SHORT=n.UNSIGNED_SHORT,i.NEAREST=n.NEAREST,i.REPEAT=n.REPEAT,i.ONE=n.ONE,i.ZERO=n.ZERO,i.SRC_ALPHA=n.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA=n.ONE_MINUS_SRC_ALPHA,i.SRC_COLOR=n.SRC_COLOR,i.ONE_MINUS_SRC_COLOR=n.ONE_MINUS_SRC_COLOR,i.ColorFormat_RGB565=n.RGB565,i.ColorFormat_RGBA5551=n.RGB5_A1,i.ColorFormat_RGBA4444=n.RGBA4,i.ColorFormat_RGBA8888=n.RGBA,i.DEPTH_TEST=n.DEPTH_TEST,i.CULL_FACE=n.CULL_FACE,i.BLEND=n.BLEND,o&&(i.ColorFormat_DXT1_RGB=o.COMPRESSED_RGB_S3TC_DXT1_EXT,i.ColorFormat_DXT1_RGBA=o.COMPRESSED_RGBA_S3TC_DXT1_EXT,i.ColorFormat_DXT3_RGBA=o.COMPRESSED_RGBA_S3TC_DXT3_EXT,i.ColorFormat_DXT5_RGBA=o.COMPRESSED_RGBA_S3TC_DXT5_EXT),t.ContextSamplerType.TEXTURE_0=n.TEXTURE0,t.ContextSamplerType.TEXTURE_1=n.TEXTURE1,t.ContextSamplerType.TEXTURE_2=n.TEXTURE2,t.ContextSamplerType.TEXTURE_3=n.TEXTURE3,t.ContextSamplerType.TEXTURE_4=n.TEXTURE4,t.ContextSamplerType.TEXTURE_5=n.TEXTURE5,t.ContextSamplerType.TEXTURE_6=n.TEXTURE6,t.ContextSamplerType.TEXTURE_7=n.TEXTURE7,t.ContextSamplerType.TEXTURE_8=n.TEXTURE8}t.CheckerboardTexture.texture.upload(i.context3D),console.log("requst GPU Config",i.context3D),t.ShaderSystemTool.regist(s)},i.requestWEBGL=function(t,e){void 0===e&&(e=!1),i.canvas=document.createElement("canvas"),i.canvas.style.position="absolute",i.canvas.style.zIndex="0",i.canvas.style.left="0px",i.canvas.style.top="0px",document.getElementsByClassName("egret-player").length>0?document.getElementsByClassName("egret-player")[0].appendChild(this.canvas):document.body.appendChild(this.canvas),i.canvas.id="egret3D",i.canvas.x=t.x,i.canvas.y=t.y,i.canvas.width=t.width,i.canvas.height=t.height,i.clientRect=i.canvas.getBoundingClientRect(),i.canvas.oncontextmenu=function(){return!1};var a=this.canvas.getContext("experimental-webgl");return a||(a=this.canvas.getContext("webgl")),console.log("this.context3D ==>",this.context3D),a||alert("you drivers not suport webgl"),a},i.requestFullScreen=function(){var t=document.documentElement;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()},i.exitFullscreen=function(){var t=document;t.exitFullscreen?t.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()},i.Direct3D_Opengl_Auto="Direct3D_Opengl_Auto",i.Direct3D_9_0="Direct3D_9_0",i.Direct3D_10_0="Direct3D_10_0",i.Direct3D_11_0="Direct3D_11_0",i.OpenGLES_2_0="OpenGLES_2_0",i.OpenGLES_3_0="OpenGLES_3_0",i.OpenGL="OpenGL",i.ColorFormat_DXT1_RGB=0,i.ColorFormat_DXT1_RGBA=0,i.ColorFormat_DXT3_RGBA=0,i.ColorFormat_DXT5_RGBA=0,i}();t.Egret3DDrive=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,i){this.data=t,this.width=e,this.height=i}return t}();t.MipmapData=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.PixelArray=0]="PixelArray",t[t.CompressData=1]="CompressData",t[t.ImageData=2]="ImageData"}(t.InternalFormat||(t.InternalFormat={}));t.InternalFormat}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(t){this.buffer=t}return t}();t.IndexBuffer3D=e}(e=t.openGLES||(t.openGLES={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(t){this.vertextAttribActive=!1,this.program=t}return t}();t.Program3D=e}(e=t.openGLES||(t.openGLES={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(t){this._shader=t}return Object.defineProperty(t.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),t.ID_COUNT=0,t}();t.Shader=e}(e=t.openGLES||(t.openGLES={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(t,e){this.width=0,this.height=0,this.gpu_texture=t,this.context3D=e,this.mipmapDatas=new Array}return t}();t.Texture2D=e}(e=t.openGLES||(t.openGLES={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(t){this.gpu_texture=t}return t}();t.CubeTexture=e}(e=t.openGLES||(t.openGLES={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(t){this.buffer=t}return t}();t.VertexBuffer3D=e}(e=t.openGLES||(t.openGLES={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.FrameBuffer=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.gl=e,t.ContextSamplerType.LINEAR=this.gl.LINEAR,t.ContextSamplerType.NEAREST=this.gl.NEAREST,t.ContextSamplerType.REPEAT=this.gl.REPEAT}return Object.defineProperty(e.prototype,"version",{get:function(){return""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLost",{get:function(){return!1},enumerable:!0,configurable:!0}),e.prototype.viewPort=function(t,e,i,a){this.gl.viewport(t,e,i,a)},e.prototype.creatProgram=function(e,i){var a=this.gl.createProgram();this.gl.attachShader(a,e.shader),this.gl.attachShader(a,i.shader),this.gl.linkProgram(a);var r=this.gl.getProgramParameter(a,this.gl.LINK_STATUS);r||(alert("vsShader error"+this.gl.getShaderInfoLog(e.shader)),alert("fsShader error"+this.gl.getShaderInfoLog(i.shader)));var s=new t.openGLES.Program3D(a);return s},e.prototype.creatIndexBuffer=function(e){var i=new Uint16Array(e),a=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW),new t.openGLES.IndexBuffer3D(a)},e.prototype.creatVertexBuffer=function(e){var i=new Float32Array(e),a=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.STATIC_DRAW),new t.openGLES.VertexBuffer3D(a)},e.prototype.setTexture2DSamplerState=function(t,e,i,a){this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,i),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,a)},e.prototype.upLoadTextureData=function(e,i){this.gl.bindTexture(this.gl.TEXTURE_2D,i.gpu_texture),i.gpu_internalformat==t.InternalFormat.ImageData?(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i.image),this.gl.generateMipmap(this.gl.TEXTURE_2D)):i.gpu_internalformat==t.InternalFormat.CompressData?this.upLoadCompressedTexture2D(e,i):i.gpu_internalformat==t.InternalFormat.PixelArray&&(this.gl.texImage2D(this.gl.TEXTURE_2D,e,i.gpu_colorformat,i.mipmapDatas[e].width,i.mipmapDatas[e].height,i.gpu_border,i.gpu_colorformat,this.gl.UNSIGNED_BYTE,i.mipmapDatas[e].data),this.gl.generateMipmap(this.gl.TEXTURE_2D)),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT)},e.prototype.upLoadCompressedTexture2D=function(t,e){this.gl.bindTexture(this.gl.TEXTURE_2D,e.gpu_texture),this.gl.compressedTexImage2D(this.gl.TEXTURE_2D,t,e.gpu_colorformat,e.mipmapDatas[t].width,e.mipmapDatas[t].height,e.gpu_border,e.mipmapDatas[t].data)},e.prototype.creatTexture2D=function(){var e=new t.openGLES.Texture2D(this.gl.createTexture(),this);return e},e.prototype.creatCubeTexture=function(){return new t.openGLES.CubeTexture(this.gl.createTexture())},e.prototype.uploadCubetexture=function(t){this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t.gpu_texture),this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_right.imageData),this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_left.imageData),this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_up.imageData),this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_down.imageData),this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_back.imageData),this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t.image_front.imageData),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE)},e.prototype.createFramebuffer=function(e,i,a){var r=this.gl.createFramebuffer(),s=this.creatTexture2D(),n=this.gl.createRenderbuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.gl.bindTexture(this.gl.TEXTURE_2D,s.gpu_texture);for(var o=new Float32Array(4096),h=0;1024>h;h++)o[h]=1,o[h+1]=1,o[h+2]=1,o[h+3]=1;switch(a){case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,e,i,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,null);break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,i,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);break;case t.FrameBufferFormat.FLOAT_RGB:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,e,i,0,this.gl.RGB,this.gl.FLOAT,o);break;case t.FrameBufferFormat.FLOAT_RGBA:this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,i,0,this.gl.RGBA,this.gl.FLOAT,o)}return this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,s.gpu_texture,0),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,e,i),s.width=e,s.height=i,s.frameBuffer=r,s.renderbuffer=n,this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),s},e.prototype.setRenderToTexture=function(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=0),this.gl.viewport(0,0,t.width,t.height),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t.frameBuffer),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,t.gpu_texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,t.renderbuffer)},e.prototype.setRenderToBackBuffer=function(){this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)},e.prototype.creatVertexShader=function(e){var i=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(i,e),this.gl.compileShader(i);var a=new t.openGLES.Shader(i);return a.id=t.openGLES.Shader.ID_COUNT++,a},e.prototype.creatFragmentShader=function(e){var i=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(i,e),this.gl.compileShader(i);var a=new t.openGLES.Shader(i);return a.id=t.openGLES.Shader.ID_COUNT++,a},e.prototype.clear=function(t,e,i,a){this.gl.clearColor(t,e,i,a),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},e.prototype.clearDepth=function(t){this.gl.clearDepth(t),this.gl.clear(this.gl.DEPTH_BUFFER_BIT)},e.prototype.clearStencil=function(t){this.gl.clearStencil(t)},e.prototype.setProgram=function(t){this.gl.useProgram(t.program)},e.prototype.getUniformLocation=function(t,e){return this.gl.getUniformLocation(t.program,e)},e.prototype.uniform1f=function(t,e){this.gl.uniform1f(t,e)},e.prototype.uniform1fv=function(t,e){this.gl.uniform1fv(t,e)},e.prototype.uniform1i=function(t,e){this.gl.uniform1i(t,e)},e.prototype.uniform1iv=function(t,e){this.gl.uniform1iv(t,e)},e.prototype.uniform2f=function(t,e,i){this.gl.uniform2f(t,e,i)},e.prototype.uniform2fv=function(t,e){this.gl.uniform2fv(t,e)},e.prototype.uniform2i=function(t,e,i){this.gl.uniform2i(t,e,i)},e.prototype.uniform2iv=function(t,e){this.gl.uniform2iv(t,e)},e.prototype.uniform3f=function(t,e,i,a){this.gl.uniform3f(t,e,i,a)},e.prototype.uniform3fv=function(t,e){this.gl.uniform3fv(t,e)},e.prototype.uniform3i=function(t,e,i,a){this.gl.uniform3i(t,e,i,a)},e.prototype.uniform3iv=function(t,e){this.gl.uniform3iv(t,e)},e.prototype.uniform4f=function(t,e,i,a,r){this.gl.uniform4f(t,e,i,a,r)},e.prototype.uniform4fv=function(t,e){this.gl.uniform4fv(t,e)},e.prototype.uniform4i=function(t,e,i,a,r){this.gl.uniform4i(t,e,i,a,r)},e.prototype.uniform4iv=function(t,e){this.gl.uniform4iv(t,e)},e.prototype.uniformMatrix2fv=function(t,e,i){this.gl.uniformMatrix2fv(t,e,i)},e.prototype.uniformMatrix3fv=function(t,e,i){this.gl.uniformMatrix3fv(t,e,i)},e.prototype.uniformMatrix4fv=function(t,e,i){this.gl.uniformMatrix4fv(t,e,i)},e.prototype.setBlendFactors=function(t,e){this.gl.blendFunc(t,e)},e.prototype.setCulling=function(t){this.gl.cullFace(t)},e.prototype.enbable=function(t){this.gl.enable(t)},e.prototype.disable=function(t){this.gl.disable(t)},e.prototype.enableDepthTest=function(t,e){void 0===e&&(e=0),t&&this.gl.enable(this.gl.DEPTH_TEST)},e.prototype.getShaderAttribLocation=function(t,e){return this.gl.getAttribLocation(t.program,e)},e.prototype.vertexAttribPointer=function(t,e,i,a,r,s,n){this.gl.vertexAttribPointer(e,i,a,r,s,n),this.gl.enableVertexAttribArray(e)},e.prototype.setVertexShaderConstData=function(t,e,i){this.gl.vertexAttrib4fv(e,t.subarray(e,i))},e.prototype.setFragmentShaderConstData=function(t,e,i){},e.prototype.setTexture2DAt=function(t,e,i,a){this.gl.activeTexture(t),this.gl.bindTexture(this.gl.TEXTURE_2D,a.gpu_texture),this.gl.uniform1i(e,i)},e.prototype.setCubeTextureAt=function(t,e,i,a){this.gl.activeTexture(t),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,a.gpu_texture),this.gl.uniform1i(e,i)},e.prototype.setScissorRectangle=function(t){},e.prototype.setStencilReferenceValue=function(){},e.prototype.setStencilActions=function(t,e,i,a,r){},e.prototype.bindVertexBuffer=function(t){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t.buffer)},e.prototype.drawArrays=function(t,e,i){this.gl.drawArrays(t,e,i)},e.prototype.drawElement=function(t,e,i,a){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e.buffer),this.gl.drawElements(t,a,this.gl.UNSIGNED_SHORT,i)},e.prototype.flush=function(){this.gl.flush()},e}();t.Context3DChild_OpenGLES_2_0=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.ALPHA=0]="ALPHA",t[t.LAYER=1]="LAYER",t[t.NORMAL=2]="NORMAL",t[t.MULTIPLY=3]="MULTIPLY",t[t.ADD=4]="ADD",t[t.SUB=5]="SUB",t[t.DIV=6]="DIV",t[t.SCREEN=7]="SCREEN"}(t.BlendMode||(t.BlendMode={}));var e=(t.BlendMode,function(){function t(){}return t}());t.ContextSamplerType=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.u=0,this.v=0,this.u=t,this.v=e}return t}();t.UV=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!0,configurable:!0}),t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},t.prototype.normalize=function(t){if(void 0===t&&(t=1),0!=this.length){var e=t/this.length;return this.x*=e,void(this.y*=e)}throw"Cannot divide by zero length."},t.prototype.offset=function(t,e){this.x+=t,this.y+=e},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.toString=function(){return"[Point] (x="+this.x+", y="+this.y+")"},t.distance=function(t,e){var i=e.x-t.x,a=e.y-t.y;return Math.sqrt(i*i+a*a)},t}();t.Point=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0),this.x=t,this.y=e,this.z=i,this.w=a}return Object.defineProperty(t.prototype,"a",{get:function(){return this.w},set:function(t){this.w=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this.x},set:function(t){this.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this.y},set:function(t){this.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this.z},set:function(t){this.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.lengthSquared)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lengthSquared",{get:function(){return this.x*this.x+this.y*this.y+this.z*this.z},enumerable:!0,configurable:!0}),t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},t.prototype.crossProduct=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x,1)},t.prototype.decrementBy=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},t.distance=function(t,e){var i=t.x-e.x,a=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+a*a+r*r)},t.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.equals=function(t,e){return void 0===e&&(e=!1),this.x==t.x&&this.y==t.y&&this.z==t.z&&(!e||this.w==t.w)},t.prototype.incrementBy=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},t.prototype.negate=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},t.prototype.normalize=function(t){if(void 0===t&&(t=1),0!=this.length){var e=t/this.length;return this.x*=e,this.y*=e,void(this.z*=e)}},t.prototype.scaleBy=function(t){this.x*=t,this.y*=t,this.z*=t},t.prototype.setTo=function(t,e,i){this.x=t,this.y=e,this.z=i},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z)},t.prototype.lerp=function(t,e,i){var a=t.x,r=t.y,s=t.z,n=t.w,o=e.x,h=e.y,u=e.z,l=e.w;this.x=(o-a)*i+a,this.y=(h-r)*i+r,this.z=(u-s)*i+s,this.w=(l-n)*i+n},t.prototype.toString=function(){return"<"+this.x+", "+this.y+", "+this.z+">"},t.prototype.parsing=function(t){var e=t.split(" ");e.length<3||(this.x=parseFloat(e[0]),this.y=parseFloat(e[1]),this.z=parseFloat(e[2]))},t.X_AXIS=new t(1,0,0),t.Y_AXIS=new t(0,1,0),t.Z_AXIS=new t(0,0,1),t}();t.Vector3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=32),void 0===a&&(a=32),this.x=0,this.y=0,this.width=0,this.height=0,this.x=t,this.y=e,this.width=i,this.height=a}return t}();t.Rectangle=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=a}return Object.defineProperty(e.prototype,"magnitude",{get:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:!0,configurable:!0}),e.prototype.multiply=function(t,e){var i=t.w,a=t.x,r=t.y,s=t.z,n=e.w,o=e.x,h=e.y,u=e.z;this.w=i*n-a*o-r*h-s*u,this.x=i*o+a*n+r*u-s*h,this.y=i*h-a*u+r*n+s*o,this.z=i*u+a*h-r*o+s*n},e.prototype.multiplyVector=function(t,i){void 0===i&&(i=null),null===i&&(i=new e);var a=t.x,r=t.y,s=t.z;return i.w=-this.x*a-this.y*r-this.z*s,i.x=this.w*a+this.y*s-this.z*r,i.y=this.w*r-this.x*s+this.z*a,i.z=this.w*s+this.x*r-this.y*a,i},e.prototype.fromAxisAngle=function(t,e){e*=Math.PI/180;var i=.5*e,a=Math.sin(i);this.w=Math.cos(i),this.x=t.x*a,this.y=t.y*a,this.z=t.z*a,this.normalize()},e.prototype.toAxisAngle=function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z,i=0;return e>0?(i=2*Math.acos(this.w),e=1/Math.sqrt(e),t.x=this.x*e,t.y=this.y*e,t.z=this.z*e):(i=0,t.x=1,t.y=0,t.z=0),i/=Math.PI/180},e.prototype.slerp=function(t,e,i){var a=t.w,r=t.x,s=t.y,n=t.z,o=e.w,h=e.x,u=e.y,l=e.z,c=a*o+r*h+s*u+n*l;if(0>c&&(c=-c,o=-o,h=-h,u=-u,l=-l),.95>c){var d=Math.acos(c),f=1/Math.sin(d),p=Math.sin(d*(1-i))*f,g=Math.sin(d*i)*f;this.w=a*p+o*g,this.x=r*p+h*g,this.y=s*p+u*g,this.z=n*p+l*g}else{this.w=a+i*(o-a),this.x=r+i*(h-r),this.y=s+i*(u-s),this.z=n+i*(l-n);var m=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=m,this.x*=m,this.y*=m,this.z*=m}},e.prototype.lerp=function(t,e,i){var a,r=t.w,s=t.x,n=t.y,o=t.z,h=e.w,u=e.x,l=e.y,c=e.z;0>r*h+s*u+n*l+o*c&&(h=-h,u=-u,l=-l,c=-c),this.w=r+i*(h-r),this.x=s+i*(u-s),this.y=n+i*(l-n),this.z=o+i*(c-o),a=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z),this.w*=a,this.x*=a,this.y*=a,this.z*=a},e.prototype.fromEulerAngles=function(e,i,a){e*=t.Matrix3DUtils.DEGREES_TO_RADIANS,i*=t.Matrix3DUtils.DEGREES_TO_RADIANS,a*=t.Matrix3DUtils.DEGREES_TO_RADIANS;var r=.5*e,s=.5*i,n=.5*a,o=Math.cos(r),h=Math.sin(r),u=Math.cos(s),l=Math.sin(s),c=Math.cos(n),d=Math.sin(n);return this.w=o*u*c+h*l*d,this.x=h*u*c-o*l*d,this.y=o*l*c+h*u*d,this.z=o*u*d-h*l*c,this},e.prototype.toEulerAngles=function(e){void 0===e&&(e=null),null===e&&(e=new t.Vector3D),e.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));var i=2*(this.w*this.y-this.z*this.x);return i=t.Matrix3DUtils.clampf(i,-1,1),e.y=Math.asin(i),e.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z)),e.x/=t.Matrix3DUtils.DEGREES_TO_RADIANS,e.y/=t.Matrix3DUtils.DEGREES_TO_RADIANS,e.z/=t.Matrix3DUtils.DEGREES_TO_RADIANS,e},e.prototype.normalize=function(t){void 0===t&&(t=1);var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e,this.y*=e,this.z*=e,this.w*=e},e.prototype.toString=function(){return"{x:"+this.x+" y:"+this.y+" z:"+this.z+" w:"+this.w+"}"},e.prototype.toMatrix3D=function(e){void 0===e&&(e=null);var i=t.Matrix3DUtils.RAW_DATA_CONTAINER,a=2*this.x*this.y,r=2*this.x*this.z,s=2*this.x*this.w,n=2*this.y*this.z,o=2*this.y*this.w,h=2*this.z*this.w,u=this.x*this.x,l=this.y*this.y,c=this.z*this.z,d=this.w*this.w;return i[0]=u-l-c+d,i[4]=a-h,i[8]=r+o,i[12]=0,i[1]=a+h,i[5]=-u+l-c+d,i[9]=n-s,i[13]=0,i[2]=r-o,i[6]=n+s,i[10]=-u-l+c+d,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1,e?(e.copyRawDataFrom(i),e):new t.Matrix4_4(new Float32Array(i))},e.prototype.fromMatrix=function(e){var i=e.decompose(t.Orientation3D.QUATERNION)[1];this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.rotatePoint=function(e,i){void 0===i&&(i=null);var a,r,s,n,o=e.x,h=e.y,u=e.z;return null===i&&(i=new t.Vector3D),n=-this.x*o-this.y*h-this.z*u,a=this.w*o+this.y*u-this.z*h,r=this.w*h-this.x*u+this.z*o,s=this.w*u+this.x*h-this.y*o,i.x=-n*this.x+a*this.w-r*this.z+s*this.y,i.y=-n*this.y+a*this.z+r*this.w-s*this.x,i.z=-n*this.z-a*this.y+r*this.x+s*this.w,i},e.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},e}();t.Quaternion=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.AXIS_ANGLE="axisAngle",t.EULER_ANGLES="eulerAngles",t.QUATERNION="quaternion",t}();t.Orientation3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0),this.a=t,this.b=e,this.c=i,this.d=a}return e.prototype.setTo=function(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0),this.a=t,this.b=e,this.c=i,this.d=a},e.prototype.fromPoints=function(t,e,i){var a=e.x-t.x,r=e.y-t.y,s=e.z-t.z,n=i.x-t.x,o=i.y-t.y,h=i.z-t.z;this.a=r*h-s*o,this.b=s*n-a*h,this.c=a*o-r*n,this.d=-(this.a*t.x+this.b*t.y+this.c*t.z)},e.prototype.fromNormalAndPoint=function(t,e){this.a=t.x,this.b=t.y,this.c=t.z,this.d=-(this.a*e.x+this.b*e.y+this.c*e.z)},e.prototype.normalize=function(){var t=Math.sqrt(this.a*this.a+this.b*this.b+this.c*this.c);if(t>0){var e=1/t;this.a*=e,this.b*=e,this.c*=e,this.d*=e}return t},e.prototype.distance=function(t){return this.a*t.x+this.b*t.y+this.c*t.z+this.d},e.prototype.classifyPoint=function(e,i){void 0===i&&(i=.01);var a=this.distance(e);return-i>a?t.PlaneClassification.BACK:a>i?t.PlaneClassification.FRONT:t.PlaneClassification.INTERSECT},e.prototype.toString=function(){return"Plane3D [a:"+this.a+", b:"+this.b+", c:"+this.c+", d:"+this.d+"]"},e.ALIGN_ANY=0,e.ALIGN_XY_AXIS=1,e.ALIGN_YZ_AXIS=2,e.ALIGN_XZ_AXIS=3,e}();t.Plane3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===e&&(e=new t.Vector3D),void 0===i&&(i=new t.Vector3D),this.min=new t.Vector3D,this.max=new t.Vector3D,this.vexData=new Array,this.indexData=new Array,this.width=0,this.heigth=0,this.depth=0,this.volume=0,this.center=new t.Vector3D,this.radius=0,this.matTransform=new t.Matrix4_4,this.min.copyFrom(e),this.max.copyFrom(i),this.calculateBox()}return e.prototype.copyFrom=function(t){this.min.copyFrom(t.min),this.max.copyFrom(t.max),this.calculateBox()},e.prototype.fillBox=function(t,e){this.min.copyFrom(t),this.max.copyFrom(e),this.calculateBox()},e.prototype.inBox=function(t){return t.x<=this.max.x&&t.x>=this.min.x&&t.y<=this.max.y&&t.y>=this.min.y&&t.z<=this.max.z&&t.z>=this.min.z?!0:!1},e.prototype.intersectAABBs=function(t,e){return this.min.x>t.max.x?!1:this.max.x<t.min.x?!1:this.min.y>t.max.y?!1:this.max.y<t.min.y?!1:this.min.z>t.max.z?!1:this.max.z<t.min.z?!1:(null!=e&&(e.min.x=Math.max(this.min.x,t.min.x),e.max.x=Math.min(this.max.x,t.max.x),e.min.y=Math.max(this.min.y,t.min.y),e.max.y=Math.min(this.max.y,t.max.y),e.min.z=Math.max(this.min.z,t.min.z),e.max.z=Math.min(this.max.z,t.max.z)),!0)},Object.defineProperty(e.prototype,"Transform",{get:function(){return this.matTransform},set:function(t){this.matTransform.copyFrom(t)},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return"CubeBoxBound [min:("+this.min.x+", "+this.min.y+", "+this.min.z+") max:("+this.max.x+", "+this.max.y+", "+this.max.z+")]"},e.prototype.calculateBox=function(){this.vexData.length=0,this.indexData.length=0;var t=this.max.subtract(this.min);this.vexData.push(this.min.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z),this.vexData.push(this.min.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z+t.z),this.vexData.push(this.min.x+t.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z+t.z),this.vexData.push(this.min.x+t.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z),this.vexData.push(this.max.x-t.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z-t.z),this.vexData.push(this.max.x-t.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z),this.vexData.push(this.max.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z),this.vexData.push(this.max.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z-t.z),this.indexData.push(0,4,7,0,7,3,2,6,5,2,5,1,4,5,6,4,6,7,0,3,2,0,2,1,0,1,5,0,5,4,3,7,6,3,6,2),this.width=this.max.x-this.min.x,this.heigth=this.max.y-this.min.y,this.depth=this.max.z-this.min.z,this.volume=this.width*this.heigth*this.depth;var e=this.max.subtract(this.min);e.scaleBy(.5),this.radius=e.length,this.center.copyFrom(this.min);var i=this.center.add(e);this.center.copyFrom(i)},e}();t.CubeBoxBound=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){void 0===t&&(t=null),this.oRawData=new Float32Array(16),t?this.rawData=t:this.rawData=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return e.prototype.lookAt=function(t,e,i){var a=e.subtract(t);a.normalize();var r=i.crossProduct(a);r.normalize();var s=a.crossProduct(r);this.rawData[0]=r.x,this.rawData[1]=s.x,this.rawData[2]=a.x,this.rawData[3]=0,this.rawData[4]=r.y,this.rawData[5]=s.y,this.rawData[6]=a.y,this.rawData[7]=0,this.rawData[8]=r.z,this.rawData[9]=s.z,this.rawData[10]=a.z,this.rawData[11]=0,this.rawData[12]=-r.dotProduct(t),this.rawData[13]=-s.dotProduct(t),this.rawData[14]=-a.dotProduct(t),this.rawData[15]=1},e.prototype.perspective=function(t,e,i,a){var r=t*(Math.PI/180),s=Math.tan((Math.PI-r)/2),n=s/e;this.rawData[0]=n,this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[5]=s,this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=a/(a-i),this.rawData[11]=1,this.rawData[12]=0,this.rawData[13]=0,this.rawData[14]=-i*a/(a-i),this.rawData[15]=0},e.prototype.ortho=function(t,e,i,a){this.rawData[0]=2/t,this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[5]=2/e,this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=1/(a-i),this.rawData[11]=0,this.rawData[12]=0,this.rawData[13]=0,this.rawData[14]=i/(i-a),this.rawData[15]=1},e.prototype.orthoOffCenter=function(t,e,i,a,r,s){this.rawData[0]=2/(e-1),this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[5]=2/(a-i),this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=1/(s-r),this.rawData[11]=0,this.rawData[12]=(1+e)/(1-e),this.rawData[13]=(a+i)/(i-a),this.rawData[14]=r/(r-s),this.rawData[15]=1},e.prototype.append=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],s=this.rawData[1],n=this.rawData[5],o=this.rawData[9],h=this.rawData[13],u=this.rawData[2],l=this.rawData[6],c=this.rawData[10],d=this.rawData[14],f=this.rawData[3],p=this.rawData[7],g=this.rawData[11],m=this.rawData[15],_=t.rawData[0],D=t.rawData[4],y=t.rawData[8],v=t.rawData[12],x=t.rawData[1],w=t.rawData[5],b=t.rawData[9],T=t.rawData[13],A=t.rawData[2],E=t.rawData[6],L=t.rawData[10],S=t.rawData[14],M=t.rawData[3],P=t.rawData[7],R=t.rawData[11],C=t.rawData[15];this.rawData[0]=e*_+s*D+u*y+f*v,this.rawData[1]=e*x+s*w+u*b+f*T,this.rawData[2]=e*A+s*E+u*L+f*S,this.rawData[3]=e*M+s*P+u*R+f*C,this.rawData[4]=i*_+n*D+l*y+p*v,this.rawData[5]=i*x+n*w+l*b+p*T,this.rawData[6]=i*A+n*E+l*L+p*S,this.rawData[7]=i*M+n*P+l*R+p*C,this.rawData[8]=a*_+o*D+c*y+g*v,this.rawData[9]=a*x+o*w+c*b+g*T,this.rawData[10]=a*A+o*E+c*L+g*S,this.rawData[11]=a*M+o*P+c*R+g*C,this.rawData[12]=r*_+h*D+d*y+m*v,this.rawData[13]=r*x+h*w+d*b+m*T,this.rawData[14]=r*A+h*E+d*L+m*S,this.rawData[15]=r*M+h*P+d*R+m*C},e.prototype.add=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],s=this.rawData[1],n=this.rawData[5],o=this.rawData[9],h=this.rawData[13],u=this.rawData[2],l=this.rawData[6],c=this.rawData[10],d=this.rawData[14],f=this.rawData[3],p=this.rawData[7],g=this.rawData[11],m=this.rawData[15],_=t.rawData[0],D=t.rawData[4],y=t.rawData[8],v=t.rawData[12],x=t.rawData[1],w=t.rawData[5],b=t.rawData[9],T=t.rawData[13],A=t.rawData[2],E=t.rawData[6],L=t.rawData[10],S=t.rawData[14],M=t.rawData[3],P=t.rawData[7],R=t.rawData[11],C=t.rawData[15];
return this.rawData[0]=e+_,this.rawData[1]=s+x,this.rawData[2]=u+A,this.rawData[3]=f+M,this.rawData[4]=i+D,this.rawData[5]=n+w,this.rawData[6]=l+E,this.rawData[7]=p+P,this.rawData[8]=a+y,this.rawData[9]=o+b,this.rawData[10]=c+L,this.rawData[11]=g+R,this.rawData[12]=r+v,this.rawData[13]=h+T,this.rawData[14]=d+S,this.rawData[15]=m+C,this},e.prototype.sub=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],s=this.rawData[1],n=this.rawData[5],o=this.rawData[9],h=this.rawData[13],u=this.rawData[2],l=this.rawData[6],c=this.rawData[10],d=this.rawData[14],f=this.rawData[3],p=this.rawData[7],g=this.rawData[11],m=this.rawData[15],_=t.rawData[0],D=t.rawData[4],y=t.rawData[8],v=t.rawData[12],x=t.rawData[1],w=t.rawData[5],b=t.rawData[9],T=t.rawData[13],A=t.rawData[2],E=t.rawData[6],L=t.rawData[10],S=t.rawData[14],M=t.rawData[3],P=t.rawData[7],R=t.rawData[11],C=t.rawData[15];return this.rawData[0]=e-_,this.rawData[1]=s-x,this.rawData[2]=u-A,this.rawData[3]=f-M,this.rawData[4]=i-D,this.rawData[5]=n-w,this.rawData[6]=l-E,this.rawData[7]=p-P,this.rawData[8]=a-y,this.rawData[9]=o-b,this.rawData[10]=c-L,this.rawData[11]=g-R,this.rawData[12]=r-v,this.rawData[13]=h-T,this.rawData[14]=d-S,this.rawData[15]=m-C,this},e.prototype.mult=function(t){return this.rawData[0]*=t,this.rawData[1]*=t,this.rawData[2]*=t,this.rawData[3]*=t,this.rawData[4]*=t,this.rawData[5]*=t,this.rawData[6]*=t,this.rawData[7]*=t,this.rawData[8]*=t,this.rawData[9]*=t,this.rawData[10]*=t,this.rawData[11]*=t,this.rawData[12]*=t,this.rawData[13]*=t,this.rawData[14]*=t,this.rawData[15]*=t,this},e.prototype.rotation=function(e,i,a){this.appendRotation(e,t.Vector3D.X_AXIS),this.appendRotation(i,t.Vector3D.Y_AXIS),this.appendRotation(a,t.Vector3D.Z_AXIS)},e.prototype.appendRotation=function(i,a){var r,s,n=(e.getAxisRotation(a.x,a.y,a.z,i),new e),o=i*t.Matrix3DUtils.DEGREES_TO_RADIANS;r=Math.sin(o),s=Math.cos(o),1==a.x&&(n.rawData[0]=1,n.rawData[1]=0,n.rawData[2]=0,n.rawData[3]=0,n.rawData[4]=0,n.rawData[5]=s,n.rawData[6]=r,n.rawData[7]=0,n.rawData[8]=0,n.rawData[9]=-r,n.rawData[10]=s,n.rawData[7]=0,n.rawData[12]=0,n.rawData[13]=0,n.rawData[14]=0,n.rawData[15]=1),1==a.y&&(n.rawData[0]=s,n.rawData[1]=0,n.rawData[2]=-r,n.rawData[3]=0,n.rawData[4]=0,n.rawData[5]=1,n.rawData[6]=0,n.rawData[7]=0,n.rawData[8]=r,n.rawData[9]=0,n.rawData[10]=s,n.rawData[11]=0,n.rawData[12]=0,n.rawData[13]=0,n.rawData[14]=0,n.rawData[15]=1),1==a.z&&(n.rawData[0]=s,n.rawData[1]=r,n.rawData[2]=0,n.rawData[3]=0,n.rawData[4]=-r,n.rawData[5]=s,n.rawData[6]=0,n.rawData[7]=0,n.rawData[8]=0,n.rawData[9]=0,n.rawData[10]=1,n.rawData[11]=0,n.rawData[12]=0,n.rawData[13]=0,n.rawData[14]=0,n.rawData[15]=1),this.append(n)},e.prototype.appendScale=function(t,e,i){this.rawData[0]=t,this.rawData[1]=0,this.rawData[2]=0,this.rawData[4]=0,this.rawData[5]=e,this.rawData[6]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=i},e.prototype.appendTranslation=function(t,e,i){this.rawData[12]+=t,this.rawData[13]+=e,this.rawData[14]+=i},e.prototype.clone=function(){var t=new e;return t.copyFrom(this),t},e.prototype.copyColumnFrom=function(t,e){switch(t){case 0:this.rawData[0]=e.x,this.rawData[1]=e.y,this.rawData[2]=e.z,this.rawData[3]=e.w;break;case 1:this.rawData[4]=e.x,this.rawData[5]=e.y,this.rawData[6]=e.z,this.rawData[7]=e.w;break;case 2:this.rawData[8]=e.x,this.rawData[9]=e.y,this.rawData[10]=e.z,this.rawData[11]=e.w;break;case 3:this.rawData[12]=e.x,this.rawData[13]=e.y,this.rawData[14]=e.z,this.rawData[15]=e.w}},e.prototype.copyRowTo=function(t,e){switch(t){case 0:e.x=this.rawData[0],e.y=this.rawData[1],e.z=this.rawData[2],e.w=this.rawData[3];break;case 1:e.x=this.rawData[4],e.y=this.rawData[5],e.z=this.rawData[6],e.w=this.rawData[7];break;case 2:e.x=this.rawData[8],e.y=this.rawData[9],e.z=this.rawData[10],e.w=this.rawData[11];break;case 3:e.x=this.rawData[12],e.y=this.rawData[13],e.z=this.rawData[14],e.w=this.rawData[15]}},e.prototype.copyFrom=function(t){for(var e=t.rawData.length,i=0;e>i;i++)this.rawData[i]=t.rawData[i];return this},e.prototype.copyRawDataFrom=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!1),i&&this.transpose();for(var a=t.length-e,r=0;a>r;r++)this.rawData[r]=t[r+e];i&&this.transpose()},e.prototype.copyRawDataTo=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!1),i&&this.transpose();for(var a=this.rawData.length,r=0;a>r;r++)t[r+e]=this.rawData[r];i&&this.transpose()},e.prototype.copyColFrom=function(t,e){switch(t){case 0:this.rawData[0]=e.x,this.rawData[4]=e.y,this.rawData[8]=e.z,this.rawData[12]=e.w;break;case 1:this.rawData[1]=e.x,this.rawData[5]=e.y,this.rawData[9]=e.z,this.rawData[13]=e.w;break;case 2:this.rawData[2]=e.x,this.rawData[6]=e.y,this.rawData[10]=e.z,this.rawData[14]=e.w;break;case 3:this.rawData[3]=e.x,this.rawData[7]=e.y,this.rawData[11]=e.z,this.rawData[15]=e.w;break;default:new Error("no more raw!")}},e.prototype.copyColTo=function(t,e){switch(t){case 0:e.x=this.rawData[0],e.y=this.rawData[4],e.z=this.rawData[8],e.w=this.rawData[12];break;case 1:e.x=this.rawData[1],e.y=this.rawData[5],e.z=this.rawData[9],e.w=this.rawData[13];break;case 2:e.x=this.rawData[2],e.y=this.rawData[6],e.z=this.rawData[10],e.w=this.rawData[14];break;case 3:e.x=this.rawData[3],e.y=this.rawData[7],e.z=this.rawData[11],e.w=this.rawData[15];break;default:new Error("no more raw!")}},e.prototype.copyToMatrix3D=function(t){t.rawData=this.rawData.slice(0)},e.prototype.decompose=function(e){void 0===e&&(e="eulerAngles");var i=[],a=this.clone(),r=a.rawData,s=new t.Vector3D(r[12],r[13],r[14]);r[12]=0,r[13]=0,r[14]=0;var n=new t.Vector3D;n.x=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),n.y=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),n.z=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),r[0]*(r[5]*r[10]-r[6]*r[9])-r[1]*(r[4]*r[10]-r[6]*r[8])+r[2]*(r[4]*r[9]-r[5]*r[8])<0&&(n.z=-n.z),r[0]/=n.x,r[1]/=n.x,r[2]/=n.x,r[4]/=n.y,r[5]/=n.y,r[6]/=n.y,r[8]/=n.z,r[9]/=n.z,r[10]/=n.z;var o=new t.Vector3D;switch(e){case t.Orientation3D.AXIS_ANGLE:o.w=Math.acos((r[0]+r[5]+r[10]-1)/2);var h=Math.sqrt((r[6]-r[9])*(r[6]-r[9])+(r[8]-r[2])*(r[8]-r[2])+(r[1]-r[4])*(r[1]-r[4]));o.x=(r[6]-r[9])/h,o.y=(r[8]-r[2])/h,o.z=(r[1]-r[4])/h;break;case t.Orientation3D.QUATERNION:var u=r[0]+r[5]+r[10];u>0?(o.w=Math.sqrt(1+u)/2,o.x=(r[6]-r[9])/(4*o.w),o.y=(r[8]-r[2])/(4*o.w),o.z=(r[1]-r[4])/(4*o.w)):r[0]>r[5]&&r[0]>r[10]?(o.x=Math.sqrt(1+r[0]-r[5]-r[10])/2,o.w=(r[6]-r[9])/(4*o.x),o.y=(r[1]+r[4])/(4*o.x),o.z=(r[8]+r[2])/(4*o.x)):r[5]>r[10]?(o.y=Math.sqrt(1+r[5]-r[0]-r[10])/2,o.x=(r[1]+r[4])/(4*o.y),o.w=(r[8]-r[2])/(4*o.y),o.z=(r[6]+r[9])/(4*o.y)):(o.z=Math.sqrt(1+r[10]-r[0]-r[5])/2,o.x=(r[8]+r[2])/(4*o.z),o.y=(r[6]+r[9])/(4*o.z),o.w=(r[1]-r[4])/(4*o.z));break;case t.Orientation3D.EULER_ANGLES:o.y=Math.asin(-r[2]),1!=r[2]&&-1!=r[2]?(o.x=Math.atan2(r[6],r[10]),o.z=Math.atan2(r[1],r[0])):(o.z=0,o.x=Math.atan2(r[4],r[5]))}return i.push(s),i.push(o),i.push(n),i},e.prototype.deltaTransformVector=function(e){var i=e.x,a=e.y,r=e.z;return new t.Vector3D(i*this.rawData[0]+a*this.rawData[4]+r*this.rawData[8],i*this.rawData[1]+a*this.rawData[5]+r*this.rawData[9],i*this.rawData[2]+a*this.rawData[6]+r*this.rawData[10],i*this.rawData[3]+a*this.rawData[7]+r*this.rawData[11])},e.prototype.identity=function(){this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[11]=0,this.rawData[12]=0,this.rawData[13]=0,this.rawData[14]=0,this.rawData[0]=1,this.rawData[5]=1,this.rawData[10]=1,this.rawData[15]=1},e.prototype.fill=function(t){this.rawData[1]=t,this.rawData[2]=t,this.rawData[3]=t,this.rawData[4]=t,this.rawData[6]=t,this.rawData[7]=t,this.rawData[8]=t,this.rawData[9]=t,this.rawData[11]=t,this.rawData[12]=t,this.rawData[13]=t,this.rawData[14]=t,this.rawData[0]=t,this.rawData[5]=t,this.rawData[10]=t,this.rawData[15]=t},e.prototype.invers33=function(){var t=this.rawData[5]*this.rawData[10]-this.rawData[9]*this.rawData[6],e=this.rawData[8]*this.rawData[6]-this.rawData[4]*this.rawData[10],i=this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5],a=this.rawData[9]*this.rawData[2]-this.rawData[1]*this.rawData[10],r=this.rawData[0]*this.rawData[10]-this.rawData[8]*this.rawData[2],s=this.rawData[8]*this.rawData[1]-this.rawData[0]*this.rawData[9],n=this.rawData[1]*this.rawData[6]-this.rawData[5]*this.rawData[2],o=this.rawData[4]*this.rawData[2]-this.rawData[0]*this.rawData[6],h=this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1],u=this.rawData[0]*t+this.rawData[4]*a+this.rawData[8]*n;if(Math.abs(u)>1e-11){var l=1/u;this.rawData[0]=l*t,this.rawData[4]=l*e,this.rawData[8]=l*i,this.rawData[1]=l*a,this.rawData[5]=l*r,this.rawData[9]=l*s,this.rawData[2]=l*n,this.rawData[6]=l*o,this.rawData[10]=l*h}},e.prototype.invert=function(){var t=this.determinant,e=Math.abs(t)>1e-11;if(e){t=1/t;var i=this.rawData[0],a=this.rawData[4],r=this.rawData[8],s=this.rawData[12],n=this.rawData[1],o=this.rawData[5],h=this.rawData[9],u=this.rawData[13],l=this.rawData[2],c=this.rawData[6],d=this.rawData[10],f=this.rawData[14],p=this.rawData[3],g=this.rawData[7],m=this.rawData[11],_=this.rawData[15];this.rawData[0]=t*(o*(d*_-f*m)-h*(c*_-f*g)+u*(c*m-d*g)),this.rawData[1]=-t*(n*(d*_-f*m)-h*(l*_-f*p)+u*(l*m-d*p)),this.rawData[2]=t*(n*(c*_-f*g)-o*(l*_-f*p)+u*(l*g-c*p)),this.rawData[3]=-t*(n*(c*m-d*g)-o*(l*m-d*p)+h*(l*g-c*p)),this.rawData[4]=-t*(a*(d*_-f*m)-r*(c*_-f*g)+s*(c*m-d*g)),this.rawData[5]=t*(i*(d*_-f*m)-r*(l*_-f*p)+s*(l*m-d*p)),this.rawData[6]=-t*(i*(c*_-f*g)-a*(l*_-f*p)+s*(l*g-c*p)),this.rawData[7]=t*(i*(c*m-d*g)-a*(l*m-d*p)+r*(l*g-c*p)),this.rawData[8]=t*(a*(h*_-u*m)-r*(o*_-u*g)+s*(o*m-h*g)),this.rawData[9]=-t*(i*(h*_-u*m)-r*(n*_-u*p)+s*(n*m-h*p)),this.rawData[10]=t*(i*(o*_-u*g)-a*(n*_-u*p)+s*(n*g-o*p)),this.rawData[11]=-t*(i*(o*m-h*g)-a*(n*m-h*p)+r*(n*g-o*p)),this.rawData[12]=-t*(a*(h*f-u*d)-r*(o*f-u*c)+s*(o*d-h*c)),this.rawData[13]=t*(i*(h*f-u*d)-r*(n*f-u*l)+s*(n*d-h*l)),this.rawData[14]=-t*(i*(o*f-u*c)-a*(n*f-u*l)+s*(n*c-o*l)),this.rawData[15]=t*(i*(o*d-h*c)-a*(n*d-h*l)+r*(n*c-o*l))}return e},e.prototype.makeTransform=function(e,i,a){a.toMatrix3D(t.Matrix3DUtils.CALCULATION_MATRIX),this.rawData[0]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[0]*i.x,this.rawData[1]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[1]*i.y,this.rawData[2]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[2]*i.z,this.rawData[3]=0,this.rawData[4]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[4]*i.x,this.rawData[5]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[5]*i.y,this.rawData[6]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[6]*i.z,this.rawData[7]=0,this.rawData[8]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[8]*i.x,this.rawData[9]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[9]*i.y,this.rawData[10]=t.Matrix3DUtils.CALCULATION_MATRIX.rawData[10]*i.z,this.rawData[11]=0,this.rawData[12]=e.x,this.rawData[13]=e.y,this.rawData[14]=e.z,this.rawData[15]=1},e.prototype.recompose=function(e){if(e.length<3)return!1;this.identity(),this.appendScale(e[2].x,e[2].y,e[2].z);var i;return i=-e[1].x*t.Matrix3DUtils.DEGREES_TO_RADIANS,t.Matrix3DUtils.CALCULATION_MATRIX.copyRawDataFrom(new Float32Array([1,0,0,0,0,Math.cos(i),-Math.sin(i),0,0,Math.sin(i),Math.cos(i),0,0,0,0,0])),this.append(t.Matrix3DUtils.CALCULATION_MATRIX),i=-e[1].y*t.Matrix3DUtils.DEGREES_TO_RADIANS,t.Matrix3DUtils.CALCULATION_MATRIX.copyRawDataFrom(new Float32Array([Math.cos(i),0,Math.sin(i),0,0,1,0,0,-Math.sin(i),0,Math.cos(i),0,0,0,0,0])),this.append(t.Matrix3DUtils.CALCULATION_MATRIX),i=-e[1].z*t.Matrix3DUtils.DEGREES_TO_RADIANS,t.Matrix3DUtils.CALCULATION_MATRIX.copyRawDataFrom(new Float32Array([Math.cos(i),-Math.sin(i),0,0,Math.sin(i),Math.cos(i),0,0,0,0,1,0,0,0,0,0])),this.append(t.Matrix3DUtils.CALCULATION_MATRIX),this.rawData[12]=e[0].x,this.rawData[13]=e[0].y,this.rawData[14]=e[0].z,this.rawData[15]=1,!0},e.prototype.transformVector=function(e){if(null==e)return new t.Vector3D;var i=e.x,a=e.y,r=e.z,s=new t.Vector3D;return s.x=i*this.rawData[0]+a*this.rawData[4]+r*this.rawData[8]+this.rawData[12],s.y=i*this.rawData[1]+a*this.rawData[5]+r*this.rawData[9]+this.rawData[13],s.z=i*this.rawData[2]+a*this.rawData[6]+r*this.rawData[10]+this.rawData[14],s.w=i*this.rawData[3]+a*this.rawData[7]+r*this.rawData[11]+this.rawData[15],s},e.prototype.transformPlane=function(i){var a=new e;a.copyFrom(this),a.invert(),a.transpose();var r=new t.Vector3D(i.a,i.b,i.c,i.d);r.copyFrom(a.transformVector(r));var s=new t.Plane3D;return s.a=r.x,s.b=r.y,s.c=r.z,s.d=r.w/Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z),s},e.prototype.transpose=function(){for(var t=0;t<this.oRawData.length;t++)this.oRawData[t]=this.rawData[t];this.rawData[1]=this.oRawData[4],this.rawData[2]=this.oRawData[8],this.rawData[3]=this.oRawData[12],this.rawData[4]=this.oRawData[1],this.rawData[6]=this.oRawData[9],this.rawData[7]=this.oRawData[13],this.rawData[8]=this.oRawData[2],this.rawData[9]=this.oRawData[6],this.rawData[11]=this.oRawData[14],this.rawData[12]=this.oRawData[3],this.rawData[13]=this.oRawData[7],this.rawData[14]=this.oRawData[11]},e.getAxisRotation=function(t,i,a,r){var s,n,o=new e,h=r*(Math.PI/180),u=Math.cos(h),l=Math.sin(h),c=1-u;return o.rawData[0]=u+t*t*c,o.rawData[5]=u+i*i*c,o.rawData[10]=u+a*a*c,s=t*i*c,n=a*l,o.rawData[1]=s+n,o.rawData[4]=s-n,s=t*a*c,n=i*l,o.rawData[8]=s+n,o.rawData[2]=s-n,s=i*a*c,n=t*l,o.rawData[9]=s-n,o.rawData[6]=s+n,o},Object.defineProperty(e.prototype,"determinant",{get:function(){return(this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1])*(this.rawData[10]*this.rawData[15]-this.rawData[14]*this.rawData[11])-(this.rawData[0]*this.rawData[9]-this.rawData[8]*this.rawData[1])*(this.rawData[6]*this.rawData[15]-this.rawData[14]*this.rawData[7])+(this.rawData[0]*this.rawData[13]-this.rawData[12]*this.rawData[1])*(this.rawData[6]*this.rawData[11]-this.rawData[10]*this.rawData[7])+(this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5])*(this.rawData[2]*this.rawData[15]-this.rawData[14]*this.rawData[3])-(this.rawData[4]*this.rawData[13]-this.rawData[12]*this.rawData[5])*(this.rawData[2]*this.rawData[11]-this.rawData[10]*this.rawData[3])+(this.rawData[8]*this.rawData[13]-this.rawData[12]*this.rawData[9])*(this.rawData[2]*this.rawData[7]-this.rawData[6]*this.rawData[3])},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"position",{get:function(){return new t.Vector3D(this.rawData[12],this.rawData[13],this.rawData[14])},set:function(t){this.rawData[12]=t.x,this.rawData[13]=t.y,this.rawData[14]=t.z},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return new t.Vector3D(this.rawData[0],this.rawData[5],this.rawData[10])},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return"matrix3d("+Math.round(1e3*this.rawData[0])/1e3+","+Math.round(1e3*this.rawData[1])/1e3+","+Math.round(1e3*this.rawData[2])/1e3+","+Math.round(1e3*this.rawData[3])/1e3+","+Math.round(1e3*this.rawData[4])/1e3+","+Math.round(1e3*this.rawData[5])/1e3+","+Math.round(1e3*this.rawData[6])/1e3+","+Math.round(1e3*this.rawData[7])/1e3+","+Math.round(1e3*this.rawData[8])/1e3+","+Math.round(1e3*this.rawData[9])/1e3+","+Math.round(1e3*this.rawData[10])/1e3+","+Math.round(1e3*this.rawData[11])/1e3+","+Math.round(1e3*this.rawData[12])/1e3+","+Math.round(1e3*this.rawData[13])/1e3+","+Math.round(1e3*this.rawData[14])/1e3+","+Math.round(1e3*this.rawData[15])/1e3+")"},e.prototype.lerp=function(t,e,i){this.copyFrom(e).sub(t).mult(i).add(t)},e}();t.Matrix4_4=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.eyePosition=new t.Vector3D,this.eyeRotation=new t.Vector3D(0,1,0),this.eyeSpace=1,this.eyeFocalLength=180,this.leftPos=new t.Vector3D,this.rightPos=new t.Vector3D,this.targetPos=new t.Vector3D(0,0,this.eyeFocalLength),this.lookAtPos=new t.Vector3D,this.quaternion=new t.Quaternion,this.leftEyeMatrix=new t.Matrix4_4,this.rightEyeMatrix=new t.Matrix4_4}return e.prototype.updte=function(t){this.targetPos.z=this.eyeFocalLength,this.eyePosition=t.position,this.quaternion.fromMatrix(t),this.leftEyeMatrix.copyRawDataFrom(t.rawData),this.rightEyeMatrix.copyRawDataFrom(t.rawData),this.leftEyeMatrix.appendTranslation(.5*-this.eyeSpace,0,0),this.rightEyeMatrix.appendTranslation(.5*this.eyeSpace,0,0)},e}();t.EyesMatrix=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.BACK=0,t.FRONT=1,t.IN=0,t.OUT=1,t.INTERSECT=2,t}();t.PlaneClassification=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.RADIANS_TO_DEGREES=180/Math.PI,t.DEGREES_TO_RADIANS=Math.PI/180,t}();t.MathUtil=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.quaternion2matrix=function(i,a){void 0===a&&(a=null);var r=i.x,s=i.y,n=i.z,o=i.w,h=r*r,u=r*s,l=r*n,c=r*o,d=s*s,f=s*n,p=s*o,g=n*n,m=n*o,_=e.RAW_DATA_CONTAINER;return _[0]=1-2*(d+g),_[1]=2*(u+m),_[2]=2*(l-p),_[4]=2*(u-m),_[5]=1-2*(h+g),_[6]=2*(f+c),_[8]=2*(l+p),_[9]=2*(f-c),_[10]=1-2*(h+d),_[3]=_[7]=_[11]=_[12]=_[13]=_[14]=0,_[15]=1,a?(a.copyRawDataFrom(_),a):new t.Matrix4_4(new Float32Array(_))},e.getForward=function(e,i){return void 0===i&&(i=null),null===i&&(i=new t.Vector3D(0,0,0)),e.copyRowTo(2,i),i.normalize(),i},e.getUp=function(e,i){return void 0===i&&(i=null),null===i&&(i=new t.Vector3D(0,0,0)),e.copyRowTo(1,i),i.normalize(),i},e.getRight=function(e,i){return void 0===i&&(i=null),null===i&&(i=new t.Vector3D(0,0,0)),e.copyRowTo(0,i),i.normalize(),i},e.compare=function(t,i){var a=e.RAW_DATA_CONTAINER,r=i.rawData;t.copyRawDataTo(a);for(var s=0;16>s;++s)if(a[s]!=r[s])return!1;return!0},e.reflection=function(i,a){void 0===a&&(a=null),null===a&&(a=new t.Matrix4_4);var r=i.a,s=i.b,n=i.c,o=i.d,h=e.RAW_DATA_CONTAINER,u=-2*r*s,l=-2*r*n,c=-2*s*n;return h[0]=1-2*r*r,h[4]=u,h[8]=l,h[12]=-2*r*o,h[1]=u,h[5]=1-2*s*s,h[9]=c,h[13]=-2*s*o,h[2]=l,h[6]=c,h[10]=1-2*n*n,h[14]=-2*n*o,h[3]=0,h[7]=0,h[11]=0,h[15]=1,a.copyRawDataFrom(h),a},e.getTranslation=function(e,i){return void 0===i&&(i=null),i||(i=new t.Vector3D),e.copyRowTo(3,i),i},e.clampf=function(t,e,i){if(e>i){var a=e;e=i,i=a}return e>t?e:i>t?t:i},e.RADIANS_TO_DEGREES=180/Math.PI,e.DEGREES_TO_RADIANS=Math.PI/180,e.RAW_DATA_CONTAINER=new Float32Array(16),e.CALCULATION_MATRIX=new t.Matrix4_4,e}();t.Matrix3DUtils=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===e&&(e=new t.Vector3D),void 0===i&&(i=new t.Vector3D),this.origin=new t.Vector3D,this.dir=new t.Vector3D,this.invViewMat=new t.Matrix4_4,this.origin.copyFrom(e),this.dir.copyFrom(i)}return e.prototype.IntersectTriangle=function(t,e,i,a){void 0===a&&(a=null);var r,s=e.subtract(t),n=i.subtract(t),o=this.dir.crossProduct(n),h=s.dotProduct(o);if(h>0?r=this.origin.subtract(t):(r=t.subtract(this.origin),h=-h),1e-4>h)return!1;var u=r.dotProduct(o);if(null!=a&&(a[1]=u),0>u||u>h)return!1;var l=r.crossProduct(s),c=this.dir.dotProduct(l);if(null!=a&&(a[2]=c),0>c||u+c>h)return!1;var d=n.dotProduct(l),f=1/h;return d*=f,u*=f,c*=f,null!=a&&(a[0]=d,a[1]=u,a[2]=c),0>d?!1:!0},e.prototype.IntersectMeshEx=function(t,e,i){return this.IntersectMesh(t.geometry.verticesData,t.geometry.indexData,t.geometry.vertexAttLength,t.geometry.indexData.length/3,e,t.modelMatrix,i)},e.prototype.IntersectMesh=function(e,i,a,r,s,n,o){var h=new Array;h.push(new t.Vector3D),h.push(new t.Vector3D),h.push(new t.Vector3D);var u=new Array;u.push(new t.Vector3D),u.push(new t.Vector3D),u.push(new t.Vector3D);var l=new Array,c=new t.Vector3D,d=new t.Vector3D,f=new t.Vector3D;l.push(c),l.push(d),l.push(f);var p=new t.Vector3D,g=new t.Point,m=new Array;m.push(0),m.push(0),m.push(0);for(var _=-1,D=Number.MAX_VALUE,y=0,v=0,x=0;r>x;++x){for(var w=0;3>w;++w){var b=i[3*x+w];p.setTo(e[a*b+0],e[a*b+1],e[a*b+2]),p.copyFrom(n.transformVector(p)),l[w].x=p.x,l[w].y=p.y,l[w].z=p.z}this.IntersectTriangle(c,d,f,m)&&m[0]<D&&(_=x,D=m[0],y=m[1],v=m[2])}if(r>_&&_>=0){for(var x=0;3>x;++x){var b=i[3*_+x];p.setTo(e[a*b+0],e[a*b+1],e[a*b+2]),h[x].copyFrom(p),s>0&&(g.x=e[a*b+0+s],g.y=e[a*b+1+s],u[x].x=g.x,u[x].y=g.y),p.copyFrom(n.transformVector(p)),l[x].x=p.x,l[x].y=p.y,l[x].z=p.z}var T=d.subtract(c);T.scaleBy(y);var A=f.subtract(c);return A.scaleBy(v),o.globalPosition.copyFrom(c.add(T.add(A))),T=h[1].subtract(h[0]),T.scaleBy(y),A=h[2].subtract(h[0]),A.scaleBy(v),o.localPosition.copyFrom(h[0].add(T.add(A))),s>0&&(T=u[1].subtract(u[0]),T.scaleBy(y),A=u[2].subtract(u[0]),A.scaleBy(v),o.uv.copyFrom(u[0].add(T.add(A)))),!0}return!1},e.prototype.CalculateAndTransformRay=function(t,e,i,a,r,s){this.reset(),this.dir.x=(2*r/t-1)/a.rawData[0],this.dir.y=(-2*s/e+1)/a.rawData[5],this.dir.z=1,this.invViewMat.copyFrom(i),this.origin.copyFrom(this.invViewMat.transformVector(this.origin)),this.dir.copyFrom(this.invViewMat.deltaTransformVector(this.dir)),this.dir.normalize()},e.prototype.reset=function(){this.origin.setTo(0,0,0),this.dir.setTo(0,0,0)},e}();t.Ray=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=255),this.a=255,this.r=255,this.g=255,this.b=255,this.a=a,this.r=t,this.g=e,this.b=i}return e.white=function(){return new e(255,255,255,255)},e.black=function(){return new e(0,0,0,255)},e.red=function(){return new e(255,0,0,255)},e.green=function(){return new e(0,255,0,255)},e.blue=function(){return new e(0,0,255,255)},e.prototype.getColor=function(e){return void 0===e&&(e=t.Egret3DDrive.ColorFormat_RGBA8888),e==t.Egret3DDrive.ColorFormat_RGB565?0:e==t.Egret3DDrive.ColorFormat_RGBA5551?0:e==t.Egret3DDrive.ColorFormat_RGBA4444?0:this.r<<24|this.g<<16|this.b<<8|this.a},e.prototype.lerp=function(t,e,i){this.a=i*(e.a-t.a)+t.a,this.r=i*(e.r-t.r)+t.r,this.g=i*(e.g-t.g)+t.g,this.b=i*(e.b-t.b)+t.b},e}();t.Color=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.localPosition=new t.Vector3D,this.globalPosition=new t.Vector3D,this.uv=new t.Vector3D}return e}();t.PickResult=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.listeners={}}return t.prototype.dispatchEvent=function(t){var e,i;if(t instanceof a?(i=t.type,e=t):(i=t,e=new a(i)),null!=this.listeners[i]){e.currentTarget=this;for(var r=0;r<this.listeners[i].length;r++){var s=this.listeners[i][r];try{s.handler(e)}catch(n){window.console&&console.error(n.stack)}}}},t.prototype.addEventListener=function(t,e,a){void 0===a&&(a=0),null==this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].push(new i(t,e,a)),this.listeners[t].sort(function(t,e){return e.priolity-t.priolity})},t.prototype.removeEventListener=function(t,e){if(this.hasEventListener(t,e))for(var i=0;i<this.listeners[t].length;i++){var a=this.listeners[t][i];if(a.equalCurrentListener(t,e))return a.handler=null,void this.listeners[t].splice(i,1)}},t.prototype.clearEventListener=function(){this.listeners={}},t.prototype.containEventListener=function(t){return null==this.listeners[t]?!1:this.listeners[t].length>0},t.prototype.hasEventListener=function(t,e){if(null==this.listeners[t])return!1;for(var i=0;i<this.listeners[t].length;i++){var a=this.listeners[t][i];if(a.equalCurrentListener(t,e))return!0}return!1},t}();t.EventDispatcher=e;var i=function(){function t(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=0),this.type=t,this.handler=e,this.priolity=i}return t.prototype.equalCurrentListener=function(t,e){return this.type==t&&this.handler==e?!0:!1},t}(),a=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this._type=t,this._data=e}return Object.defineProperty(t.prototype,"currentTarget",{get:function(){return this._currentTarget},set:function(t){this._currentTarget=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:!0,configurable:!0}),t.EVENT_LOAD_COMPLETE="load_complete",t.EVENT_LOAD_PROGRESS="onLoadProgress",t.MOUSE_CLICK="onClick",t.MOUSE_DOWN="onMouseDown",t.MOUSE_UP="onMouseUp",t.MOUSE_MOVE="onMouseMove",t.TOUCH_MOVE="onTouchMove",t.TOUCH_START="onTouchStart",t.TOUCH_END="onTouchEnd",t.COMPLETE="complete",t.CHANGE_PROPERTY="changeProperty",t}();t.Event3D=a}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){var i=this;this._camera=e,t.Input.instance.addListenerKeyClick(function(t){return i.onMouseClick(t)}),t.Input.instance.addListenerKeyDown(function(t){return i.onMouseDown(t)}),t.Input.instance.addListenerKeyUp(function(t){return i.onMouseUp(t)}),t.Input.instance.addListenerMouseMove(function(t){return i.onMouseMove(t)}),t.Input.instance.addTouchStartCallback(function(t){return i.onTouchStart(t)}),t.Input.instance.addTouchEndCallback(function(t){return i.onTouchEnd(t)}),t.Input.instance.addTouchMoveCallback(function(t){return i.onTouchMove(t)})}return e.prototype.onTouchMove=function(e){if(this._collect)for(var i,a=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList),r=0;r<a.length;r++)i=new t.Event3D(t.Event3D.TOUCH_MOVE),i.currentTarget=a[r],i.data=e,a[r].dispatchEvent(i)},e.prototype.onTouchEnd=function(e){if(this._collect)for(var i,a=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList),r=0;r<a.length;r++)i=new t.Event3D(t.Event3D.TOUCH_END),i.currentTarget=a[r],i.data=e,a[r].dispatchEvent(i)},e.prototype.onTouchStart=function(e){if(this._collect)for(var i,a=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList),r=0;r<a.length;r++)i=new t.Event3D(t.Event3D.TOUCH_START),i.currentTarget=a[r],i.data=e,a[r].dispatchEvent(i)},e.prototype.onMouseClick=function(e){if(this._collect)for(var i,a=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList),r=0;r<a.length;r++)i=new t.Event3D(t.Event3D.MOUSE_CLICK),i.data=e,i.currentTarget=a[r],a[r].dispatchEvent(i)},e.prototype.onMouseDown=function(e){if(this._collect)for(var i,a=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList),r=0;r<a.length;r++)i=new t.Event3D(t.Event3D.MOUSE_DOWN),i.currentTarget=a[r],i.data=e,a[r].dispatchEvent(i)},e.prototype.onMouseUp=function(e){if(this._collect)for(var i,a=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList),r=0;r<a.length;r++)i=new t.Event3D(t.Event3D.MOUSE_UP),i.currentTarget=a[r],i.data=e,a[r].dispatchEvent(i)},e.prototype.onMouseMove=function(e){if(this._collect)for(var i,a=t.Picker.pickObject3DList(this._camera,this._collect.mousePickList),r=0;r<a.length;r++)i=new t.Event3D(t.Event3D.MOUSE_MOVE),i.currentTarget=a[r],i.data=e,a[r].dispatchEvent(i)},e.prototype.update=function(t){this._collect=t},e.left_mouse_over="left_mouse_over",e.left_mouse_down="left_mouse_down",e.left_mouse_up="left_mouse_up",e.left_mouse_click="left_mouse_click",e.right_mouse_over="right_mouse_over",e.right_mouse_down="right_mouse_down",e.right_mouse_up="right_mouse_up",e.right_mouse_click="right_mouse_click",e.middle_mouse_over="middle_mouse_over",e.middle_mouse_down="middle_mouse_down",e.middle_mouse_up="middle_mouse_up",e.middle_mouse_click="middle_mouse_click",e.mouse_move="mouse_move",e}();t.Mouse3DManager=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.border=0,this.useMipmap=!0,this.imageData=null,this.colorFormat=t.Egret3DDrive.ColorFormat_RGBA8888,this.internalFormat=t.InternalFormat.PixelArray,this.mimapData=new Array}return e.prototype.upload=function(t){if(!this.texture)if(this.texture=t.creatTexture2D(),this.texture.gpu_internalformat=this.internalFormat,this.texture.gpu_colorformat=this.colorFormat,this.texture.mipmapDatas=this.mimapData,this.texture.image=this.imageData,this.texture.gpu_border=0,this.useMipmap)for(var e=0;e<this.mimapData.length;e++)t.upLoadTextureData(e,this.texture);else t.upLoadTextureData(0,this.texture)},e.prototype.uploadForcing=function(t){if(this.texture=t.creatTexture2D(),this.texture.gpu_internalformat=this.internalFormat,this.texture.gpu_colorformat=this.colorFormat,this.texture.mipmapDatas=this.mimapData,this.texture.image=this.imageData,this.texture.gpu_border=0,this.useMipmap)for(var e=0;e<this.mimapData.length;e++)t.upLoadTextureData(e,this.texture);else t.upLoadTextureData(0,this.texture)},Object.defineProperty(e.prototype,"width",{get:function(){return this.imageData?this.imageData.width:this.mimapData.length>0?this.mimapData[0].width:0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.imageData?this.imageData.height:this.mimapData.length>0?this.mimapData[0].height:0},enumerable:!0,configurable:!0}),e}();t.TextureBase=e}(egret3d||(egret3d={}));var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},egret3d;!function(t){var e=function(t){function e(e,i){var a=this;void 0===e&&(e=256),void 0===i&&(i=256),t.call(this),this.canUpdataTexture=!1,this._width=e,this._height=i,this.tmpCanvas=document.createElement("canvas"),this.tmpCanvas.width=e,this.tmpCanvas.height=i,this.context=this.tmpCanvas.getContext("2d"),this.video=document.createElement("video"),this.video.msZoom=!0,this.video.width=e,this.video.height=i,this.video.videoWidth=e,this.video.videoHeight=i,this.video.controls=!1,this.video.autoplay=!0,this.video.addEventListener("canplaythrough",function(){return a.loadReady()},!0),this.tmpCanvas.hidden=!0}return __extends(e,t),e.prototype.loadReady=function(){this.canUpdataTexture=!0},Object.defineProperty(e.prototype,"source",{get:function(){return this.video.src},set:function(t){this.video.src=t},enumerable:!0,configurable:!0}),e.prototype.play=function(){this.video.play()},e.prototype.pause=function(){this.video.pause()},e.prototype.upload=function(t){this.texture||(this.texture=t.creatTexture2D(),this.texture.gpu_internalformat=this.internalFormat,this.texture.gpu_colorformat=this.colorFormat,this.texture.mipmapDatas=this.mimapData,this.texture.image=this.imageData,this.texture.gpu_border=0,t.gl.bindTexture(t.gl.TEXTURE_2D,this.texture.gpu_texture),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.LINEAR),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST)),this.canUpdataTexture&&(this.context.drawImage(this.video,0,0,this._width,this._height),t.gl.pixelStorei(t.gl.UNPACK_ALIGNMENT,1),t.gl.bindTexture(t.gl.TEXTURE_2D,this.texture.gpu_texture),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGB,t.gl.RGB,t.gl.UNSIGNED_BYTE,this.tmpCanvas))},e}(t.TextureBase);t.VideoTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e){t.call(this),this.useMipmap=!1,this.texture=e}return __extends(e,t),e}(t.TextureBase);t.RenderTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i,a,r,s,n){t.call(this),HTMLImageElement,this.image_front=e,this.image_back=i,this.image_left=a,this.image_right=r,this.image_up=s,this.image_down=n}return __extends(e,t),e.prototype.upload=function(t){this.cubeTexture||(this.cubeTexture=t.creatCubeTexture(),this.cubeTexture.image_front=this.image_front,this.cubeTexture.image_back=this.image_back,this.cubeTexture.image_left=this.image_left,this.cubeTexture.image_right=this.image_right,this.cubeTexture.image_up=this.image_up,this.cubeTexture.image_down=this.image_down,t.uploadCubetexture(this.cubeTexture))},e}(t.TextureBase);t.SkyTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this),this.imageData=t}return __extends(i,e),i.prototype.upload=function(e){this.texture||(this.texture=e.creatTexture2D(),this.texture.gpu_internalformat=t.InternalFormat.ImageData,this.texture.gpu_colorformat=t.Egret3DDrive.ColorFormat_RGBA8888,this.texture.image=this.imageData,this.useMipmap=!1,e.upLoadTextureData(0,this.texture))},i}(t.TextureBase);t.ImageTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._width=32,this._height=32,this.buildCheckerboard(),this.mimapData=new Array,this.mimapData.push(new t.MipmapData(this._pixelArray,this._width,this._height))
}return __extends(i,e),i.prototype.upload=function(e){this.texture||(this.texture=e.creatTexture2D(),this.texture.gpu_border=0,this.texture.gpu_internalformat=t.InternalFormat.PixelArray,this.texture.gpu_colorformat=t.Egret3DDrive.ColorFormat_RGBA8888,this.texture.mipmapDatas=this.mimapData,this.useMipmap=!1,e.upLoadTextureData(0,this.texture))},i.prototype.buildCheckerboard=function(){if(!this._pixelArray){this._pixelArray=new Uint8Array(this._width*this._height*4);for(var e=[t.Color.white(),t.Color.black()],i=0,a=4,r=0;r<this._height;r++)for(var s=0;s<this._width;s++){if(s%a==0&&(i=(i+1)%2),r%a==0&&0==s){var n=e[0];e[0]=e[1],e[1]=n,i=0}this._pixelArray[r*(4*this._width)+4*s+0]=e[i].r,this._pixelArray[r*(4*this._width)+4*s+1]=e[i].g,this._pixelArray[r*(4*this._width)+4*s+2]=e[i].b,this._pixelArray[r*(4*this._width)+4*s+3]=e[i].a}}},i.texture=new i,i}(t.TextureBase);t.CheckerboardTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.prototype.fillGeomtryData=function(t){},t}();t.AnimNodeBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.nodes=new Array,this._vertexAttributes={},this.nodes=new Array}return t.prototype.addNode=function(t){this.nodes.push(t)},t.prototype.removeNode=function(t){var e=this.nodes.indexOf(t);-1!=e&&this.nodes.splice(e,1)},t.prototype.getNodes=function(){return this.nodes},t.prototype.getNodesVertexShaders=function(){for(var t=[],e=0;e<this.nodes.length;e++)""!=this.nodes[e].vertexShader&&void 0!=this.nodes[e].vertexShader&&null!=this.nodes[e].vertexShader&&t.push(this.nodes[e].vertexShader);return t},t.prototype.getNodesFragmentShaders=function(){for(var t=[],e=0;e<this.nodes.length;e++)""!=this.nodes[e].fragmentShader&&void 0!=this.nodes[e].fragmentShader&&null!=this.nodes[e].fragmentShader&&t.push(this.nodes[e].fragmentShader);return t},t.prototype.calculateNode=function(){for(var t=9,e=0;e<this.nodes.length;e++)this.nodes[e].usageAttributeLen>0&&(this.nodes[e].offset=t,this.nodes[e].offsetBytes=t*Float32Array.BYTES_PER_ELEMENT,t+=this.nodes[e].usageAttributeLen);this.numberOfVertices=t,this.vertexSizeInBytes=t*Float32Array.BYTES_PER_ELEMENT},t}();t.AnimaNodeCollection=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.jointMatrixValid=!1,this.worldMatrixValid=!1,this.jointMatrix=new t.Matrix4_4,this.worldMatrix=new t.Matrix4_4,this.name=null,this.parent=null,this.parentIndex=-1,this.inverseBindPose=null,this.scale=null,this.orientation=null,this.translation=null,this.localMatrix=null,this.name=e}return e.prototype.clone=function(){var i=new e(this.name);return i.parent=this.parent,i.parentIndex=this.parentIndex,this.inverseBindPose&&(i.inverseBindPose=new t.Matrix4_4,i.inverseBindPose.copyFrom(this.inverseBindPose)),this.scale&&(i.scale=new t.Vector3D,i.scale.copyFrom(this.scale)),this.orientation&&(i.orientation=new t.Quaternion,i.orientation.copyFrom(this.orientation)),this.translation&&(i.translation=new t.Vector3D,i.translation.copyFrom(this.translation)),this.scale&&this.orientation&&this.translation&&i.setLocalTransform(i.orientation,i.scale,i.translation),i},e.prototype.setInverseBindPose=function(e,i,a){this.inverseBindPose||(this.inverseBindPose=new t.Matrix4_4),this.inverseBindPose.recompose([e,i,a])},e.prototype.setLocalTransform=function(e,i,a){this.translation=a,this.orientation=e,this.scale=i,this.localMatrix||(this.localMatrix=new t.Matrix4_4),this.localMatrix.makeTransform(this.translation,this.scale,this.orientation)},e}();t.Joint=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=null),this.frameTime=0,this.joints=[],this.skeletonMatrixValid=!1,this._skeletonMatrix=null,this._initialSkeleton=null,this._temp_q0=new t.Quaternion,this._temp_q1=new t.Quaternion,this._temp_q2=new t.Quaternion,this._temp_v0=new t.Vector3D,this._temp_v1=new t.Vector3D,this._temp_v2=new t.Vector3D,e&&(this.initialSkeleton=e)}return e.prototype.clone=function(){var t=new e(this.initialSkeleton);t.frameTime=this.frameTime;for(var i=0;i<this.joints.length;i++)t.joints.push(this.joints[i].clone());return t},e.prototype.reset=function(){for(var t=0;t<this.joints.length;t++)this.joints[t].jointMatrix.identity(),this.joints[t].jointMatrixValid=!1,this.joints[t].worldMatrix.identity(),this.joints[t].worldMatrixValid=!1,this.joints[t].orientation.x=this.joints[t].orientation.y=this.joints[t].orientation.z=this.joints[t].orientation.w=0,this.joints[t].scale.x=this.joints[t].scale.y=this.joints[t].scale.z=this.joints[t].scale.w=0,this.joints[t].translation.x=this.joints[t].translation.y=this.joints[t].translation.z=this.joints[t].translation.w=0},Object.defineProperty(e.prototype,"initialSkeleton",{get:function(){return this._initialSkeleton},set:function(t){this._initialSkeleton=t,this._skeletonMatrix||(this._skeletonMatrix=new Float32Array(8*this._initialSkeleton.numJoint),this.skeletonMatrixValid=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skeletonMatrix",{get:function(){return this._skeletonMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numJoint",{get:function(){return this.joints.length},enumerable:!0,configurable:!0}),e.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},e.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},e.prototype.skeletonLerp=function(t,e,i){this.frameTime=i;var a=(i-t.frameTime)/Math.abs(e.frameTime-t.frameTime);this.lerp(t,e,a)},e.prototype.lerp=function(e,i,a){for(var r=0;r<e.joints.length;r++){r>=this.joints.length&&this.joints.push(new t.Joint(null));var s=this.joints[r];s.name=e.joints[r].name,s.worldMatrixValid=!0,this._temp_q0.fromMatrix(e.joints[r].worldMatrix),this._temp_q1.fromMatrix(i.joints[r].worldMatrix),this._temp_q2.lerp(this._temp_q0,this._temp_q1,a),e.joints[r].worldMatrix.copyRowTo(3,this._temp_v0),i.joints[r].worldMatrix.copyRowTo(3,this._temp_v1),this._temp_v2.lerp(this._temp_v0,this._temp_v1,a),this._temp_q2.toMatrix3D(s.worldMatrix),s.worldMatrix.rawData[12]=this._temp_v2.x,s.worldMatrix.rawData[13]=this._temp_v2.y,s.worldMatrix.rawData[14]=this._temp_v2.z,s.jointMatrixValid=!1,this.skeletonMatrixValid=!1}},e.prototype.toMatrixData=function(t){void 0===t&&(t=null);var e=this._initialSkeleton.joints;t||(t=new Float32Array(8*this.joints.length));for(var i=0;i<e.length;i++)for(var a=0;a<this.joints.length;a++)if(this.joints[a].name==e[i].name){this._temp_q0.fromMatrix(this.joints[a].jointMatrix),t[8*i+0]=this._temp_q0.x,t[8*i+1]=this._temp_q0.y,t[8*i+2]=this._temp_q0.z,t[8*i+3]=this._temp_q0.w,t[8*i+4]=this.joints[a].jointMatrix.rawData[12],t[8*i+5]=this.joints[a].jointMatrix.rawData[13],t[8*i+6]=this.joints[a].jointMatrix.rawData[14],t[8*i+7]=1;break}return t},e.prototype.updateSkeletonMatrix=function(){this.skeletonMatrixValid||(this.toMatrixData(this._skeletonMatrix),this.skeletonMatrixValid=!0)},e.prototype.calculateJointWorldMatrix=function(e){for(var i=0;i<this.joints.length;i++){var a=this.joints[i];this.calculateAbsoluteMatrix(this.joints,i,e)}for(var i=0;i<this.joints.length;i++){var a=this.joints[i];a.jointMatrixValid||(a.jointMatrix=new t.Matrix4_4,e.joints[i].inverseBindPose&&(a.jointMatrix.copyFrom(e.joints[i].inverseBindPose),a.jointMatrix.append(a.worldMatrix)),a.jointMatrixValid=!0)}this.skeletonMatrixValid=!1},e.prototype.calculateAbsoluteMatrix=function(t,e,i){var a=t[e],r=i.joints[e].parentIndex;r>=0&&this.calculateAbsoluteMatrix(t,r,i),a.worldMatrixValid||(a.worldMatrix.copyFrom(a.localMatrix),r>=0&&a.worldMatrix.append(t[r].worldMatrix),a.worldMatrixValid=!0)},e}();t.Skeleton=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.frameCount=0,this._animName=null,this._sampling=1,this._loop=!0,this._playing=!0,this._enabled=!0,this._weight=1,this._length=0,this._parent=null,this._poseArray=null,this._animName=t}return Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"poseArray",{get:function(){return this._poseArray},set:function(t){this._poseArray=t,this._length=t[t.length-1].frameTime},enumerable:!0,configurable:!0}),e.prototype.clone=function(){var t=new e(this.animationName);return t.frameCount=this.frameCount,t.poseArray=this._poseArray,t},e.prototype.hasEnded=function(){return this._timePosition>=this._length&&!this._loop},e.prototype.addTime=function(t){this.timePosition+=t},Object.defineProperty(e.prototype,"currentFrameIndex",{get:function(){var t=Math.floor(this._timePosition/80)%this._poseArray.length;return t},set:function(t){t=Math.abs(t)%this._poseArray.length,this.timePosition=80*t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nextFrameIndex",{get:function(){return(this.currentFrameIndex+1)%this._poseArray.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"animationName",{get:function(){return this._animName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this._length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sampling",{get:function(){return this._sampling},set:function(t){this._sampling=Math.max(t,1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"play",{get:function(){return this._playing},set:function(t){this._playing=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"weight",{get:function(){return this._weight},set:function(t){this._weight=t,this._enabled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timePosition",{get:function(){return this._timePosition},set:function(t){t!=this._timePosition&&(this._timePosition=t,this._loop?(this._timePosition=t%this._length,this._timePosition<0&&(this._timePosition+=this._length)):this._timePosition<0?this._timePosition=0:this._timePosition>this._length&&(this._timePosition=this._length,this._playing=!1),this.enabled)},enumerable:!0,configurable:!0}),e.prototype.fillFrame=function(e){for(var i=0;i<this._poseArray.length;i++)this._poseArray[i].calculateJointWorldMatrix(e);if(this.frameCount!=this._poseArray.length-1){var a=new Array,r=60,s=1e3/r;a.push(this._poseArray[0]);for(var n=1;n<=this.frameCount;n++){var o=a[n-1],h=this._poseArray[(Math.floor(n/this.sampling)+1)%this._poseArray.length],u=new t.Skeleton;u.skeletonLerp(o,h,n*s),a.push(u)}this.poseArray=a}},e}();t.SkeletonAnimationClip=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),this.smooth=!1,this._initialSkeleton=null,this._animList=[],this._animationSkeleton=new t.Skeleton,this._bindList={},this._enabledSkeletonAnimationClips=[],this._eventCallbackList=[],this._skeletonAnimationClips={},this._blendSkeleton=null,this._useCache=!0,this._playSpeed=1,this._playing=!1,this._currentFrame=0,this._temp_smooth=new t.Skeleton,this._temp_quat=new t.Quaternion,this._temp_vec3=new t.Vector3D,this._initialSkeleton=i,this._skeletonMatrix=new Float32Array(8*this._initialSkeleton.numJoint)}return __extends(i,e),Object.defineProperty(i.prototype,"skeletonAnimationController",{get:function(){return this},enumerable:!0,configurable:!0}),i.prototype.initShader=function(t,e){t.maxBone=2*this.jointNumber},i.prototype.clone=function(){var t=new i(this._initialSkeleton);for(var e in this._skeletonAnimationClips)t._skeletonAnimationClips[e]=this._skeletonAnimationClips[e].clone();return t._animationSkeleton=this._animationSkeleton,t._animList=this._animList,t._blendSkeleton=this._blendSkeleton.clone(),t},Object.defineProperty(i.prototype,"currentSkeletonMatrixData",{get:function(){return this._skeletonMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"jointNumber",{get:function(){return this._initialSkeleton.numJoint},enumerable:!0,configurable:!0}),i.prototype.addSkeletonAnimationClip=function(e){if(this._skeletonAnimationClips[e.animationName])return this._skeletonAnimationClips[e.animationName];if(this._animationSkeleton.numJoint<e.poseArray[0].joints.length&&this._animationSkeleton.numJoint!=e.poseArray[0].joints.length){this._animationSkeleton.joints=[];for(var i=e.poseArray[0].joints,a=0;a<i.length;a++){var r=new t.Joint(i[a].name);r.parentIndex=e.poseArray[0].findJointIndex(i[a].parent);var s=this._initialSkeleton.findJoint(r.name);s?r.inverseBindPose=s.inverseBindPose:r.inverseBindPose=null,this._animationSkeleton.joints.push(r)}}e.fillFrame(this._animationSkeleton),e.parent=this;for(var a=0;a<e.poseArray.length;a++)e.poseArray[a].initialSkeleton=this._initialSkeleton;return this._skeletonAnimationClips[e.animationName]=e,this._animList.push(e.animationName),this._blendSkeleton||(this._blendSkeleton=e.poseArray[0].clone()),e},i.prototype.updata=function(t,e){if(!(this._enabledSkeletonAnimationClips.length<=0)){var i=null,a=null,r=null,s=null;this._blendSkeleton.reset();for(var n=e/300*1,o=0;o<this._enabledSkeletonAnimationClips.length;o++){if(a=this._enabledSkeletonAnimationClips[o],o!=this._enabledSkeletonAnimationClips.length-1){if(a.weight=Math.max(0,a.weight-n),a.weight<=0){this._enabledSkeletonAnimationClips.splice(o,1),o--;continue}}else a.weight=Math.min(1,a.weight+n);a.addTime(e*this._playSpeed*5)}if(this._enabledSkeletonAnimationClips.length>1){a=this._enabledSkeletonAnimationClips[0],i=a.poseArray[a.currentFrameIndex],i.skeletonMatrixValid||i.calculateJointWorldMatrix(this._animationSkeleton),s=this._enabledSkeletonAnimationClips[1],r=s.poseArray[s.currentFrameIndex],r.skeletonMatrixValid||r.calculateJointWorldMatrix(this._animationSkeleton);for(var o=0;o<this._blendSkeleton.numJoint;o++)this._blendSkeleton.joints[o].orientation.lerp(i.joints[o].orientation,r.joints[o].orientation,s.weight),this._blendSkeleton.joints[o].scale.lerp(i.joints[o].scale,r.joints[o].scale,s.weight),this._blendSkeleton.joints[o].translation.lerp(i.joints[o].translation,r.joints[o].translation,s.weight),this._blendSkeleton.joints[o].setLocalTransform(this._blendSkeleton.joints[o].orientation,this._blendSkeleton.joints[o].scale,this._blendSkeleton.joints[o].translation);this._blendSkeleton.calculateJointWorldMatrix(this._animationSkeleton),this._blendSkeleton.toMatrixData(this._skeletonMatrix)}else a=this._enabledSkeletonAnimationClips[0],i=a.poseArray[a.currentFrameIndex],i.skeletonMatrixValid||i.calculateJointWorldMatrix(this._animationSkeleton),i.toMatrixData(this._skeletonMatrix)}},i.prototype.play=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=1),this._skeletonAnimationClips[t]?(this._enabledSkeletonAnimationClips.push(this._skeletonAnimationClips[t]),this._enabledSkeletonAnimationClips[this._enabledSkeletonAnimationClips.length-1].weight=this._enabledSkeletonAnimationClips.length>1?0:1,this._enabledSkeletonAnimationClips[this._enabledSkeletonAnimationClips.length-1].play=!0,this._enabledSkeletonAnimationClips[this._enabledSkeletonAnimationClips.length-1].timePosition=0,this._currentFrame=0,this._playSpeed=e,this._playing=!0,!0):!1},i.prototype.playOnce=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=1),this.currentAnim!=t){if(!this._skeletonAnimationClips[t])return!1;this.currentAnim=t,this._enabledSkeletonAnimationClips=[],this._enabledSkeletonAnimationClips.push(this._skeletonAnimationClips[t])}return this._currentFrame=0,this._enabledSkeletonAnimationClips[0].play=!0,this._enabledSkeletonAnimationClips[0].timePosition=0,this._enabledSkeletonAnimationClips[0].loop=!1,this._playSpeed=e,this._playing=!0,!0},Object.defineProperty(i.prototype,"currentFrame",{get:function(){return this._currentFrame},set:function(t){this._enabledSkeletonAnimationClips.length<=0||(this._enabledSkeletonAnimationClips[0].timePosition=160*t)},enumerable:!0,configurable:!0}),i.prototype.getTotalNumberOfFrame=function(t){void 0===t&&(t=null),t=t?t:this.currentAnim;var e=this._skeletonAnimationClips[t];return e?e.poseArray.length:0},i.prototype.stop=function(){this._playing=!1},i.prototype.isPlay=function(){return 0==this._enabledSkeletonAnimationClips[0].play?!1:this._playing&&this._enabledSkeletonAnimationClips.length>0},i.prototype.setPlaySpeed=function(t){this._playSpeed=t},i.prototype.bindToJointPose=function(t,e){var i=this._animationSkeleton.findJointIndex(t);if(0>i)return!1;var a=null;return this._bindList[i]?a=this._bindList[i]:(a=new Array,this._bindList[i]=a),a.push(e),!0},i.prototype.updateBindList=function(t){var e=null,i=null,a=null;for(var r in this._bindList)if(e=this._bindList[r],!(e.length<=0)&&(i=t.joints[r]))for(var s=0;s<e.length;s++)a=e[s],this._temp_quat.fromMatrix(i.worldMatrix),this._temp_quat.toEulerAngles(this._temp_vec3),a.rotationX=this._temp_vec3.x,a.rotationY=this._temp_vec3.y,a.rotationZ=this._temp_vec3.z,a.x=i.worldMatrix.position.x,a.y=i.worldMatrix.position.y,a.z=i.worldMatrix.position.z},i.prototype.getAnimList=function(){return this._animList},i.prototype.getAnimNode=function(){return null},Object.defineProperty(i.prototype,"dirtyFrameNumber",{get:function(){return this._dirtyFrameNumber},enumerable:!0,configurable:!0}),i.prototype.getAnimationState=function(t){return this._skeletonAnimationClips[t]},i.prototype.removeAnimationState=function(t){this._skeletonAnimationClips[t]||console.log("animation named: "+t+"not exists. SkeletonAnimationClip::removeAnimationState"),delete this._skeletonAnimationClips[t]},i.prototype.removeAllAnimationStates=function(){this._skeletonAnimationClips={},this._enabledSkeletonAnimationClips=[]},i.EVENT_PLAY_COMPLETE="event_play_complete",i.EVENT_FRAME_CHANGE="event_frame_change",i}(t.EventDispatcher);t.SkeletonAnimation=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t.attribute_position="attribute_position",t.attribute_normal="attribute_normal",t.attribute_tangent="attribute_tangent",t.attribute_vertexColor="attribute_vertexColor",t.attribute_uv0="attribute_uv0",t.attribute_uv1="attribute_uv1",t.varying_pos="varying_pos",t.varying_normal="varying_normal",t.varying_tangent="varying_tangent",t.varying_color="varying_color",t.varying_uv0="varying_uv0",t.varying_uv1="varying_uv1",t.varying_globalPos="varying_globalPos",t.varying_lightDir="varying_lightDir",t.varying_eye="varying_eye",t.uniform_floatv_0="uniform_floatv_0",t.uniform_floatv_1="uniform_floatv_1",t.uniform_floatv_2="uniform_floatv_2",t.uniform_iv_0="uniform_iv_0",t.uniform_iv_1="uniform_iv_1",t.uniform_iv_2="uniform_iv_2",t.uniform_bv_0="uniform_bv_0",t.uniform_bv_1="uniform_bv_1",t.uniform_bv_2="uniform_bv_2",t.uniform_vec2fv_0="uniform_vec2fv_0",t.uniform_vec2fv_1="uniform_vec2fv_1",t.uniform_vec2fv_2="uniform_vec2fv_2",t.uniform_vec3fv_0="uniform_vec3fv_0",t.uniform_vec3fv_1="uniform_vec3fv_1",t.uniform_vec3fv_2="uniform_vec3fv_2",t.uniform_vec4fv_0="uniform_vec4fv_0",t.uniform_vec4fv_1="uniform_vec4fv_1",t.uniform_vec4fv_2="uniform_vec4fv_2",t.uniform_vec2iv_0="uniform_vec2iv_0",t.uniform_vec2iv_1="uniform_vec2iv_1",t.uniform_vec2iv_2="uniform_vec2iv_2",t.uniform_vec3iv_0="uniform_vec3iv_0",t.uniform_vec3iv_1="uniform_vec3iv_1",t.uniform_vec3iv_2="uniform_vec3iv_2",t.uniform_vec4iv_0="uniform_vec4iv_0",t.uniform_vec4iv_1="uniform_vec4iv_1",t.uniform_vec4iv_2="uniform_vec4iv_2",t.uniform_vec2bv_0="uniform_vec2bv_0",t.uniform_vec2bv_1="uniform_vec2bv_1",t.uniform_vec2bv_2="uniform_vec2bv_2",t.uniform_vec3bv_0="uniform_vec3bv_0",t.uniform_vec3bv_1="uniform_vec3bv_1",t.uniform_vec3bv_2="uniform_vec3bv_2",t.uniform_vec4bv_0="uniform_vec4bv_0",t.uniform_vec4bv_1="uniform_vec4bv_1",t.uniform_vec4bv_2="uniform_vec4bv_2",t.uniform_modelMatrix="uniform_modelMatrix",t.uniform_projectionMatrix="uniform_projectionMatrix",t.uniform_normalMatrix="uniform_normalMatrix",t.uniform_eye="uniform_eye",t.uniform_lightDir="uniform_lightDir",t.texture2D_0="texture2D_0",t.texture2D_1="texture2D_1",t.texture2D_2="texture2D_2",t.texture2D_3="texture2D_3",t.texture2D_4="texture2D_4",t}();t.VarConstName=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t["int"]="int",t["float"]="float",t.vec2="vec2",t.vec3="vec3",t.vec4="vec4",t.mat2="mat2",t.mat3="mat3",t.mat4="mat4",t}();t.AttributeType=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t.bool="bool",t["int"]="int",t["float"]="float",t.vec2="vec2",t.vec3="vec3",t.vec4="vec4",t.bvec2="bvec2",t.bvec3="bvec3",t.bvec4="bvec4",t.ivec2="ivec2",t.ivec3="ivec3",t.ivec4="ivec4",t.mat2="mat2",t.mat3="mat3",t.mat4="mat4",t.sampler2D="sampler2D",t.sampleCube="sampleCube",t}();t.UniformType=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t.bool="bool",t["int"]="int",t["float"]="float",t.vec2="vec2",t.vec3="vec3",t.vec4="vec4",t.bvec2="bvec2",t.bvec3="bvec3",t.bvec4="bvec4",t.ivec2="ivec2",t.ivec3="ivec3",t.ivec4="ivec4",t.mat2="mat2",t.mat3="mat3",t.mat4="mat4",t.sampler2D="sampler2D",t.sampleCube="sampleCube",t}();t.VaryingType=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){this.valueType="",this.value="",this.activeTextureIndex=-1,this.index=-1}return t.prototype["var"]=function(t){return this.level+" "+this.valueType+" "+name+"."+t},t.prototype.use=function(t){return void 0===t&&(t=""),""!=t?this.name+"."+t:this.name},t.prototype.clone=function(){var e=new t;return e.name=this.name,e.valueType=this.valueType,e.level=this.level,e.varName=this.varName,e.value=this.value,e},t.prototype.computeVarName=function(){var t=this.name.indexOf("[");t>=0?this.varName=this.name.substr(0,t):this.varName=this.name},t}();t.VarRegister=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.TmpVar=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="attribute",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.Attribute=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="varying",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.Varying=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="uniform",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.Uniform=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i,a){t.call(this),this.name=e,this.computeVarName(),this.key="const",this.valueType=i,this.value=a}return __extends(e,t),e}(t.VarRegister);t.ConstVar=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){t.call(this),this.name=e,this.computeVarName(),this.key="sampler2D"}return __extends(e,t),e}(t.VarRegister);t.Sampler2D=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){t.call(this),this.name=e,this.computeVarName(),this.key="samplerCube"}return __extends(e,t),e}(t.VarRegister);t.Sampler3D=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var i=function(){function e(t,e){this.index=0,this.source="precision highp float;            	\n",this.shadersName=new Array,this.endShadername="",this.stateChange=!1,this.maxBone=0,this.useage=e,this.materialData=t}return e.prototype.addShader=function(t){this.shadersName.push(t)},e.prototype.addEnd=function(t){this.endShadername=t},e.prototype.activate=function(t,e,i,a){},e.prototype.updata=function(t,e,i,a){},e.prototype.getShaderSource=function(){if(""!=this.endShadername){var e=this.shadersName.indexOf(this.endShadername);-1==e&&this.shadersName.push(this.endShadername)}var i,a=t.ShaderSystemTool.instance.getShader(this.shadersName,this.useage);for(var r in a.attributeList)this.connectAtt(a.attributeList[r]);for(var r in a.structDict)this.connectStruct(a.structDict[r]);for(i=0;i<a.varyingList.length;i++)this.connectVarying(a.varyingList[i]);for(i=0;i<a.tempList.length;i++)this.connectTemp(a.tempList[i]);for(i=0;i<a.constList.length;i++)"max_directLight"==a.constList[i].varName&&(a.constList[i].value=this.materialData.directLightList.length.toString()),"bonesNumber"==a.constList[i].varName&&(a.constList[i].value=this.maxBone),"max_sportLight"==a.constList[i].varName&&(a.constList[i].value=this.materialData.sportLightList.length.toString()),"max_pointLight"==a.constList[i].varName&&(a.constList[i].value=this.materialData.pointLightList.length.toString()),this.connectConst(a.constList[i]);for(i=0;i<a.uniformList.length;i++)this.connectUniform(a.uniformList[i]);for(i=0;i<a.sampler2DList.length;i++){var s=a.sampler2DList[i];s=s.clone(),this.connectSampler(s),s.activeTextureIndex=this.getTexture2DIndex(i),s.index=i,this.useage.sampler2DList.push(s)}for(i=0;i<a.sampler3DList.length;i++){var n=a.sampler3DList[i];n=n.clone(),this.connectSampler3D(n),n.activeTextureIndex=this.getTexture2DIndex(a.sampler2DList.length+i),n.index=a.sampler2DList.length+i,this.useage.sampler3DList.push(n)}for(i=0;i<a.funcList.length;i++)this.source+=a.funcList[i].func;return this.source},e.prototype.connectAtt=function(t){this.source+="attribute "+t.valueType+" "+t.name+"; \r\n"},e.prototype.connectTemp=function(t){this.source+=t.valueType+" "+t.name+"; \r\n"},e.prototype.connectStruct=function(t){this.source+=t+" \r\n"},e.prototype.connectConst=function(t){this.source+="const "+t.valueType+" "+t.name+" = "+t.value+"; \r\n"},e.prototype.connectVarying=function(t){this.source+="varying "+t.valueType+" "+t.name+"; \r\n"},e.prototype.connectUniform=function(t){this.source+="uniform "+t.valueType+" "+t.name+"; \r\n"},e.prototype.connectSampler=function(t){this.source+="uniform sampler2D "+t.name+"; \r\n"},e.prototype.connectSampler3D=function(t){this.source+="uniform samplerCube "+t.name+"; \r\n"},e.prototype.getTexture2DIndex=function(e){switch(e){case 0:return t.ContextSamplerType.TEXTURE_0;case 1:return t.ContextSamplerType.TEXTURE_1;case 2:return t.ContextSamplerType.TEXTURE_2;case 3:return t.ContextSamplerType.TEXTURE_3;case 4:return t.ContextSamplerType.TEXTURE_4;case 5:return t.ContextSamplerType.TEXTURE_5;case 6:return t.ContextSamplerType.TEXTURE_6;case 7:return t.ContextSamplerType.TEXTURE_7;case 8:return t.ContextSamplerType.TEXTURE_8}throw new Error("texture not big then 8")},e.prototype.dispose=function(){this.materialData=null,this.useage=null,this.source="",this.source=null,this.shadersName.length=0,this.shadersName=null},e}();e.ShaderBase=i}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){this.name="",this.func=""}return t}();t.FuncData=e;var i=function(){function t(){this.name="",this.funcDict={},this.structDict={},this.attributeList=new Array,this.varyingList=new Array,this.uniformList=new Array,this.constList=new Array,this.tempList=new Array,this.sampler2DList=new Array,this.sampler3DList=new Array,this.funcList=new Array}return t.prototype.addVar=function(t){"attribute"==t.key?this.attributeList.push(t):"varying"==t.key?this.varyingList.push(t):"uniform"==t.key?this.uniformList.push(t):"const"==t.key?this.constList.push(t):"sampler2D"==t.key?this.sampler2DList.push(t):"samplerCube"==t.key?this.sampler3DList.push(t):this.tempList.push(t)},t.prototype.addFunc=function(t,i){if(void 0==this.funcDict[t]){this.funcDict[t]=i;var a=new e;a.name=t,a.func=i,"main"==t?this.funcList.push(a):this.funcList.unshift(a)}else if("main"==t){var r=this.mergeMainFunc(this.funcDict[t],i);this.funcDict[t]=r;var a=this.findFunc(t);a&&(a.func=r)}else console.log("<"+t+">")},t.prototype.addStruct=function(t,e){void 0==this.structDict[t]?this.structDict[t]=e:console.log("<"+t+">struct")},t.prototype.addContent=function(t){for(var e in t.structDict)this.structDict[e]=t.structDict[e];for(var e in t.funcDict)this.addFunc(e,t.funcDict[e]);for(var i=0;i<t.attributeList.length;++i){for(var a=!0,r=0;r<this.attributeList.length;++r)if(t.attributeList[i].name==this.attributeList[r].name){(t.attributeList[i].valueType!=this.attributeList[r].valueType||t.attributeList[i].key!=this.attributeList[r].key)&&console.log("Error :addContent"),a=!1;break}a&&this.attributeList.push(t.attributeList[i].clone())}for(var i=0;i<t.varyingList.length;++i){for(var a=!0,r=0;r<this.varyingList.length;++r)if(t.varyingList[i].name==this.varyingList[r].name){(t.varyingList[i].valueType!=this.varyingList[r].valueType||t.varyingList[i].key!=this.varyingList[r].key)&&console.log("Error :addContent"),a=!1;break}a&&this.varyingList.push(t.varyingList[i].clone())}for(var i=0;i<t.uniformList.length;++i){for(var a=!0,r=0;r<this.uniformList.length;++r)if(t.uniformList[i].name==this.uniformList[r].name){(t.uniformList[i].valueType!=this.uniformList[r].valueType||t.uniformList[i].key!=this.uniformList[r].key)&&console.log("Error :addContent"),a=!1;break}a&&this.uniformList.push(t.uniformList[i].clone())}for(var i=0;i<t.constList.length;++i){for(var a=!0,r=0;r<this.constList.length;++r)if(t.constList[i].name==this.constList[r].name){(t.constList[i].valueType!=this.constList[r].valueType||t.constList[i].key!=this.constList[r].key)&&console.log("Error :addContent"),a=!1;break}a&&this.constList.push(t.constList[i].clone())}for(var i=0;i<t.tempList.length;++i){for(var a=!0,r=0;r<this.tempList.length;++r)if(t.tempList[i].name==this.tempList[r].name){(t.tempList[i].valueType!=this.tempList[r].valueType||t.tempList[i].key!=this.tempList[r].key)&&console.log("Error :addContent"),a=!1;break}a&&this.tempList.push(t.tempList[i].clone())}for(var i=0;i<t.sampler2DList.length;++i){for(var a=!0,r=0;r<this.sampler2DList.length;++r)if(t.sampler2DList[i].name==this.sampler2DList[r].name){(t.sampler2DList[i].valueType!=this.sampler2DList[r].valueType||t.sampler2DList[i].key!=this.sampler2DList[r].key)&&console.log("Error :addContent"),a=!1;break}a&&this.sampler2DList.push(t.sampler2DList[i].clone())}for(var i=0;i<t.sampler3DList.length;++i){for(var a=!0,r=0;r<this.sampler3DList.length;++r)if(t.sampler3DList[i].name==this.sampler3DList[r].name){(t.sampler2DList[i].valueType!=this.sampler3DList[r].valueType||t.sampler3DList[i].key!=this.sampler3DList[r].key)&&console.log("Error :addContent"),a=!1;break}a&&this.sampler3DList.push(t.sampler3DList[i].clone())}},t.prototype.mergeMainFunc=function(t,e){var i=t,a="",r=e.indexOf("{"),s=e.lastIndexOf("}");r++,a=e.slice(r,s),r=i.lastIndexOf("}");var n=i.substr(0,r),o=i.substr(r,i.length-r);i=n,i+=a;var h="";return i+=h,i+=o},t.prototype.findFunc=function(t){for(var e=null,i=0;i<this.funcList.length;++i)if(this.funcList[i].name==t){e=this.funcList[i];break}return e},t}();t.ShaderContent=i}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.libs=["default_vertex","diffuseMap_fragment","diffuse_fragmentEnd","normalMap_fragment","specularMap_fragment","diffuseMethod_fragment","Color_fragment","directLight_fragment","spotLight_fragment","pointLight_fragment","skeleton_vertex","particle_vertex","particle_vertexEnd","Shadow_vertex_static","Shadow_vertex_sksleton","Shadow_fragment","ShadowMapping_vertex","shadowmapping_fragment","depthMethod_fragment","normalMethod_fragment","postCanvas_vertex","postCanvas_fragment","sky_fragment","sky_vertex","spheresky_vertex","spheresky_fragment","terrainRGBA_fragment","warpedImage_fragment","lightMap_fragment","EnvironmentMapping_fragment","SpecularEnvironmentMappingMethod","distanceFog_fragment","AOMap_fragment","wireframe_vertex","wireframe_fragment","FresnelReflection_fragment","PaintFresnelReflection_fragment","AlphaEnvironmentMapping_fragment","cubeDiffuseMap_fragment","particle_time","particle_position","particle_offset","particle_speed","particle_billboard","particle_acceleration","particle_lifeRotate","particle_acceleRotate","particle_scale","particle_acceleScale","BrightPassFilter","GaussianBlurHorizontal","GaussianBlurVertical","Composition","Tonemaping"],this._shaderLibs={},this._methodLibs={},this._loaderDict={},this._loadList=new Array,this._shaderContentDict={}
}return Object.defineProperty(e,"instance",{get:function(){return this._instance||(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),e.regist=function(t){this.instance._loadFunc=t,this.instance.load("")},e.prototype.load=function(e){for(var i=this,a=0;a<this.libs.length;a++)this._loadList.push(this.libs[a]);for(var a=0;a<this.libs.length;a++){var r=e+"shader/"+this.libs[a]+".glsl";this._loaderDict[r]=this.libs[a];var s=t.glsldata;if(s)this.setupShader(r,s[this.libs[a]]);else{var n=new t.URLLoader(r);n.onLoadComplete=function(t){return i.onCompleteShader(t)}}}s&&setTimeout(function(){return i._loadFunc(i)},0)},e.prototype.onCompleteShader=function(t){this.setupShader(t.url,t.data)},e.prototype.setupShader=function(t,e){var i=this.readShader(e);i.name=this._loaderDict[t],this._shaderLibs[i.name]=e,this._methodLibs[i.name]=i,this._shaderContentDict[i.name]=i;for(var a=-1,r=0;r<this._loadList.length;++r)if(this._loadList[r]==i.name){a=r;break}a>=0&&this._loadList.splice(a,1),this._loadList.length<=0&&this._loadFunc(this)},e.prototype.getShaderSource=function(t){return this._shaderLibs[t]=this._shaderLibs[t]||""},e.prototype.getShader=function(e,i){var a=0,r="",s=null;for(a=0;a<e.length;++a)""!=r&&(r+="/"),r+=e[a];if(void 0==this._shaderContentDict[r]){for(s=new t.GLSL.ShaderContent,a=0;a<e.length;++a){var n=this._shaderContentDict[e[a]];s.addContent(n)}this._shaderContentDict[r]=s}else s=this._shaderContentDict[r];if(null==s)return null;for(a=0;a<s.attributeList.length;a++)r=s.attributeList[a].varName,i[r]=s.attributeList[a].clone();for(a=0;a<s.varyingList.length;a++)r=s.varyingList[a].varName,i[r]||(i[r]=s.varyingList[a].clone());for(a=0;a<s.tempList.length;a++)r=s.tempList[a].varName,i[r]=s.tempList[a].clone();for(a=0;a<s.uniformList.length;a++)r=s.uniformList[a].varName,i[r]=s.uniformList[a].clone();for(a=0;a<s.constList.length;a++)r=s.constList[a].varName,i[r]=s.constList[a].clone();for(a=0;a<s.sampler2DList.length;a++)r=s.sampler2DList[a].varName,i[r]=s.sampler2DList[a].clone();for(a=0;a<s.sampler3DList.length;a++)r=s.sampler3DList[a].varName,i[r]=s.sampler3DList[a].clone();return s},e.prototype.readShader=function(e){for(var i=new t.GLSL.ShaderContent,a=t.StringUtil.processShaderFile(e),r=t.StringUtil.parseContent(a),s=r.concat();s.length>0;){var n=s[0];s.shift();var o=this.getLineType(n),h=-1;if(h=o.indexOf("struct"),-1==h)if(h=o.indexOf("function"),-1==h)if(h=o.indexOf("unknown"),-1==h);else{var u=t.StringUtil.parseLines(n),l=t.StringUtil.getVarKey(u),c=t.StringUtil.getVarType(u);if("sampler2D"==c){var d=this.getSampler2D(n);d&&i.addVar(d)}else if("samplerCube"==c){var f=this.getSampler3D(n);f&&i.addVar(f)}else if("attribute"==l){var p=this.getAttribute(n);p&&i.addVar(p)}else if("varying"==l){var g=this.getVarying(n);g&&i.addVar(g)}else if("uniform"==l){var m=this.getUniform(n);m&&i.addVar(m)}else if("const"==l){var _=this.getConst(n);_&&i.addVar(_)}else i.addVar(this.getTemper(n))}else{var u=o.split(" "),D=n;i.addFunc(u[1],D)}else{var u=o.split(" "),y=n;i.addStruct(u[1],y),this.processStruct(u[1],y,i)}}return i},e.prototype.getLineType=function(t){var e=t.indexOf("{");if(e>0){var i=t.substr(0,e);if(i.indexOf("struct")>=0){var a=i.lastIndexOf(" ");a++;var r=i.substr(a,i.length-a);return"struct "+r}if(i.indexOf("=")<0){var s=t.indexOf("("),a=t.lastIndexOf(" ",s);a++;var n=t.substr(a,s-a);return"function "+n}}return"unknown"},e.prototype.getAttribute=function(e){var i,a,r,s=e,n=t.StringUtil.parseLines(s);return i=t.StringUtil.getVarName(n),a=t.StringUtil.getVarType(n),r=new t.GLSL.Attribute(i,a)},e.prototype.getTemper=function(e){var i,a,r,s=e,n=t.StringUtil.parseLines(s);return i=t.StringUtil.getVarName(n),a=t.StringUtil.getVarType(n),r=new t.GLSL.TmpVar(i,a)},e.prototype.getVarying=function(e){var i,a,r,s=e,n=t.StringUtil.parseLines(s);return i=t.StringUtil.getVarName(n),a=t.StringUtil.getVarType(n),r=new t.GLSL.Varying(i,a)},e.prototype.getUniform=function(e){var i,a,r,s=e,n=t.StringUtil.parseLines(s);return i=t.StringUtil.getVarName(n),a=t.StringUtil.getVarType(n),r=new t.GLSL.Uniform(i,a)},e.prototype.getConst=function(e){var i,a,r,s,n=e,o=t.StringUtil.parseLines(n);return i=t.StringUtil.getVarName(o),a=t.StringUtil.getVarType(o),r=t.StringUtil.getVarValue(o),s=new t.GLSL.ConstVar(i,a,r)},e.prototype.getSampler2D=function(e){var i,a,r=e,s=t.StringUtil.parseLines(r);return i=t.StringUtil.getVarName(s),a=new t.GLSL.Sampler2D(i)},e.prototype.getSampler3D=function(e){var i,a,r=e,s=t.StringUtil.parseLines(r);return i=t.StringUtil.getVarName(s),a=new t.GLSL.Sampler3D(i)},e.prototype.filterCharacter=function(t){for(var i=t,a=i,r=0;r<e._filterChar.length;++r)for(;;){if(a=i.replace(e._filterChar[r],""),i==a)break;i=a}return a},e.prototype.processStruct=function(e,i,a){var r=i.lastIndexOf("}");r++;for(var s=i.lastIndexOf(";"),n=i.substr(r,s-r),o=t.StringUtil.parseLines(n),h=0;h<o.length;++h){var u=this.getTemper(e+" "+o[h]+";");u&&a.addVar(u)}},e._filterChar=[" ","  ",";","\n","\r","	","\n","\r","	"],e}();t.ShaderSystemTool=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.passNeedReset=!1,this.sampler2DList=new Array,this.sampler3DList=new Array,this.vsMethodList=new Array,this.fsMethodList=new Array,this.effectMethodList=new Array}return t.prototype.dispose=function(){},t}();t.MethodUsageData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.textureMethodTypes=[],this.diffusePassUsageData=new t.MethodUsageData,this.depthPassUsageData=new t.MethodUsageData,this.normalPassUsageData=new t.MethodUsageData,this.positionPassUsageData=new t.MethodUsageData,this.postPassUsageData=new t.MethodUsageData,this.lightPassUsageData=new t.MethodUsageData,this.shadowPassUsageData=new t.MethodUsageData,this.drawMode=t.DrawMode.TRIANGLES,this.normalTex=t.CheckerboardTexture.texture,this.specularTex=t.CheckerboardTexture.texture,this.lightMapTex=t.CheckerboardTexture.texture,this.aoMapTex=t.CheckerboardTexture.texture,this.environmentMapTex=t.CheckerboardTexture.texture,this.maskTex=t.CheckerboardTexture.texture,this.splat_0Tex=t.CheckerboardTexture.texture,this.splat_1Tex=t.CheckerboardTexture.texture,this.splat_2Tex=t.CheckerboardTexture.texture,this.splat_3Tex=t.CheckerboardTexture.texture,this.directLightList=new Array,this.sportLightList=new Array,this.pointLightList=new Array,this.layer=0,this.castShadow=!1,this.acceptShadow=!0,this.depthTest=!0,this.smooth=!0,this.blendMode=t.BlendMode.NORMAL,this.alphaBlending=!1,this.ambientColor=16777215,this.diffuseColor=16777215,this.specularColor=16777215,this.shininess=8,this.cutAlpha=.7,this.repeat=!1,this.bothside=!1,this.alpha=1,this.specularPower=1,this.ambientPower=1,this.diffusePower=1,this.normalPower=1,this.materialDataNeedChange=!0,this.textureChange=!1,this.passChange=!0,this.cullFrontOrBack=t.Egret3DDrive.BACK}return e.prototype.clone=function(){var i=new e;return i.diffusePassUsageData=this.diffusePassUsageData,i.depthPassUsageData=this.depthPassUsageData,i.normalPassUsageData=this.normalPassUsageData,i.positionPassUsageData=this.positionPassUsageData,i.postPassUsageData=this.positionPassUsageData,i.lightPassUsageData=this.positionPassUsageData,i.shadowPassUsageData=this.positionPassUsageData,i.diffuseTex=t.CheckerboardTexture.texture,i.textureChange=!0,i.textureMethodTypes=this.textureMethodTypes,i.drawMode=this.drawMode,i.context3D=this.context3D,i.diffuseTex=this.diffuseTex,i.specularTex=this.specularTex,i.lightMapTex=this.lightMapTex,i.environmentMapTex=this.environmentMapTex,i.shadowMapTex=this.shadowMapTex,i.splat_0Tex=this.splat_0Tex,i.splat_1Tex=this.splat_1Tex,i.splat_2Tex=this.splat_2Tex,i.splat_3Tex=this.splat_3Tex,i.layer=this.layer,i.castShadow=this.castShadow,i.acceptShadow=this.acceptShadow,i.depthTest=this.depthTest,i.smooth=this.smooth,i.blendMode=this.blendMode,i.blend_src=this.blend_src,i.blend_dest=this.blend_dest,i.ambientColor=this.ambientColor,i.diffuseColor=this.diffuseColor,i.specularColor=this.specularColor,i.shininess=this.shininess,i.shininess=this.shininess,i.cutAlpha=this.cutAlpha,i.alpha=this.alpha,i.specularPower=this.specularPower,i.ambientPower=this.ambientPower,i.diffusePower=this.diffusePower,i.normalPower=this.normalPower,i.passChange=this.passChange,i.materialDataNeedChange=this.materialDataNeedChange,i.textureChange=!0,i.cullFrontOrBack=this.cullFrontOrBack,i},e.prototype.dispose=function(){this.diffusePassUsageData&&this.diffusePassUsageData.dispose(),this.depthPassUsageData&&this.depthPassUsageData.dispose(),this.normalPassUsageData&&this.normalPassUsageData.dispose(),this.normalPassUsageData&&this.normalPassUsageData.dispose(),this.positionPassUsageData&&this.positionPassUsageData.dispose(),this.postPassUsageData&&this.postPassUsageData.dispose(),this.lightPassUsageData&&this.lightPassUsageData.dispose(),this.shadowPassUsageData&&this.shadowPassUsageData.dispose(),this.directLightList.length>0&&(this.directLightList.length=0,this.directLightList=null),this.sportLightList.length>0&&(this.sportLightList.length=0,this.sportLightList=null),this.pointLightList.length>0&&(this.pointLightList.length=0,this.pointLightList=null)},e}();t.MaterialData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.vsMethodName="",this.fsMethodName="",this.acceptShadow=!1}return t.prototype.setMaterialData=function(t,e){this.usage=e,this.materialData=t},Object.defineProperty(t.prototype,"vertexMethodName",{get:function(){return this.vsMethodName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fragMethodName",{get:function(){return this.fsMethodName},enumerable:!0,configurable:!0}),t.prototype.activate=function(t,e,i,a,r,s){this.context3D=t},t.prototype.updata=function(t,e,i,a,r,s){},t.prototype.dispose=function(){},t}();t.MethodBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i){e.call(this,t,i)}return __extends(i,e),i.prototype.setVertexShader=function(e){var i;switch(e.geomtryType){case t.GeometryType.Static:i=new t.StaticVertexMethod,this.useage.vsMethodList.push(i),this.addShader(i.vertexMethodName);break;case t.GeometryType.Skin:i=new t.SkinVertexMethod,this.useage.vsMethodList.push(i),this.addShader(i.vertexMethodName),i.acceptShadow=this.materialData.acceptShadow;break;case t.GeometryType.Particle:i=new t.ParticleVertexMethod,this.useage.vsMethodList.push(i),this.addShader(i.vertexMethodName),this.addEnd("particle_vertexEnd")}i.acceptShadow=this.materialData.acceptShadow,this.materialData.acceptShadow&&this.addShader("Shadow_vertex_static")},i.prototype.getShaderSource=function(){var t=e.prototype.getShaderSource.call(this),i=t.lastIndexOf("}"),a=t.substr(i,t.length-i);return t=t.substr(0,i),t+="   gl_Position = temp_p; \r\n",t+=a},i.prototype.build=function(){for(this.index=0;this.index<this.useage.vsMethodList.length;this.index++)this.useage.vsMethodList[this.index].setMaterialData(this.materialData,this.useage)},i.prototype.addMethod=function(t){this.stateChange=!0,this.useage.vsMethodList.push(t)},i}(t.GLSL.ShaderBase);t.VertexShader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i){t.call(this,e,i),this.useage=i,this.materialData=e}return __extends(e,t),e.prototype.addMethod=function(t){this.stateChange=!0,this.useage.fsMethodList.push(t)},e.prototype.addEffectMethod=function(t){this.stateChange=!0,this.useage.effectMethodList.push(t)},e.prototype.getShaderSource=function(){var e=t.prototype.getShaderSource.call(this),i=e.lastIndexOf("}"),a=e.substr(i,e.length-i);return e=e.substr(0,i),e+="   gl_FragColor = diffuse;\r\n",e+=a},e.prototype.build=function(){for(this.stateChange=!1,this.index=0;this.index<this.useage.fsMethodList.length;this.index++)this.useage.fsMethodList[this.index].setMaterialData(this.materialData,this.useage);for(this.stateChange=!1,this.index=0;this.index<this.useage.effectMethodList.length;this.index++)this.useage.effectMethodList[this.index].setMaterialData(this.materialData,this.useage)},e}(t.GLSL.ShaderBase);t.PixelShader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.normalMatrix=new t.Matrix4_4,this.vsMethodName="default_vertex"}return __extends(i,e),i.prototype.activate=function(t,e,i,a,r){r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData),r.numberOfVertices=r.verticesData.length/r.vertexAttLength,r.vertexSizeInBytes=r.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT,r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData),t.bindVertexBuffer(r.sharedVertexBuffer),this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.name),this.usage.attribute_normal.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_normal.name),this.usage.attribute_tangent.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_tangent.name),this.usage.attribute_color.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_color.name),this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv0.name),this.usage.attribute_uv1.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv1.name),this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.name),this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.name),this.usage.uniform_normalMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_normalMatrix.name),this.usage.uniform_eyepos.uniformIndex=t.getUniformLocation(e,this.usage.uniform_eyepos.name),this.acceptShadow&&this.usage.uniform_shadowMatrix&&(this.usage.uniform_shadowMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_shadowMatrix.name))},i.prototype.updata=function(e,i,a,r,s){e.bindVertexBuffer(s.sharedVertexBuffer),e.vertexAttribPointer(i,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,0),e.vertexAttribPointer(i,this.usage.attribute_normal.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,12),e.vertexAttribPointer(i,this.usage.attribute_tangent.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,24),e.vertexAttribPointer(i,this.usage.attribute_color.uniformIndex,4,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,36),e.vertexAttribPointer(i,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,52),e.vertexAttribPointer(i,this.usage.attribute_uv1.uniformIndex,2,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,60),this.normalMatrix.copyFrom(a),this.normalMatrix.invert(),this.normalMatrix.transpose(),e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,!1,a.rawData),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,r.viewProjectionMatrix.rawData),e.uniformMatrix4fv(this.usage.uniform_normalMatrix.uniformIndex,!1,this.normalMatrix.rawData),e.uniform3f(this.usage.uniform_eyepos.uniformIndex,r.x,r.y,r.z),this.acceptShadow&&this.usage.uniform_shadowMatrix&&e.uniformMatrix4fv(this.usage.uniform_shadowMatrix.uniformIndex,!1,t.ShadowRender.shadowCamera3D.viewProjectionMatrix.rawData)},i}(t.MethodBase);t.StaticVertexMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.vsMethodName="Shadow_vertex_static"}return __extends(i,e),i.prototype.activate=function(t,e,i,a,r){r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData),r.numberOfVertices=r.verticesData.length/r.vertexAttLength,r.vertexSizeInBytes=r.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT,r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData),t.bindVertexBuffer(r.sharedVertexBuffer),this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.name),this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.name),this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.name)},i.prototype.updata=function(e,i,a,r,s){e.bindVertexBuffer(s.sharedVertexBuffer),e.vertexAttribPointer(i,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,0),e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,!1,a.rawData),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,r.viewProjectionMatrix.rawData)},i}(t.MethodBase);t.ShadowVertexMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.normalMatrix=new t.Matrix4_4,this.vsMethodName="skeleton_vertex"}return __extends(i,e),i.prototype.activate=function(t,e,i,a,r,s){r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData),r.numberOfVertices=r.verticesData.length/r.vertexAttLength,r.vertexSizeInBytes=r.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT,r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData),t.bindVertexBuffer(r.sharedVertexBuffer),this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.varName),this.usage.attribute_normal.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_normal.varName),this.usage.attribute_tangent.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_tangent.varName),this.usage.attribute_color.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_color.varName),this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv0.varName),this.usage.attribute_uv1.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv1.varName),this.usage.attribute_boneIndex.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_boneIndex.varName),this.usage.attribute_boneWeight.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_boneWeight.varName),this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.varName),this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.varName),this.usage.uniform_normalMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_normalMatrix.varName),this.usage.uniform_eyepos.uniformIndex=t.getUniformLocation(e,this.usage.uniform_eyepos.varName),this.usage.uniform_PoseMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_PoseMatrix.varName)},i.prototype.updata=function(e,i,a,r,s,n){e.bindVertexBuffer(s.sharedVertexBuffer),e.gl.vertexAttribPointer(this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,0),e.gl.enableVertexAttribArray(this.usage.attribute_position.uniformIndex),e.gl.vertexAttribPointer(this.usage.attribute_normal.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,12),e.gl.enableVertexAttribArray(this.usage.attribute_normal.uniformIndex),e.gl.vertexAttribPointer(this.usage.attribute_tangent.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,24),e.gl.enableVertexAttribArray(this.usage.attribute_tangent.uniformIndex),e.gl.vertexAttribPointer(this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,52),e.gl.enableVertexAttribArray(this.usage.attribute_uv0.uniformIndex),e.gl.vertexAttribPointer(this.usage.attribute_boneIndex.uniformIndex,4,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,68),e.gl.enableVertexAttribArray(this.usage.attribute_boneIndex.uniformIndex),e.gl.vertexAttribPointer(this.usage.attribute_boneWeight.uniformIndex,4,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,84),e.gl.enableVertexAttribArray(this.usage.attribute_boneWeight.uniformIndex),this.normalMatrix.copyFrom(a),this.normalMatrix.invert(),this.normalMatrix.transpose(),e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,!1,a.rawData),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,r.viewProjectionMatrix.rawData),e.uniformMatrix4fv(this.usage.uniform_normalMatrix.uniformIndex,!1,this.normalMatrix.rawData),e.uniform3f(this.usage.uniform_eyepos.uniformIndex,r.x,r.y,r.z),e.uniform4fv(this.usage.uniform_PoseMatrix.uniformIndex,n.currentSkeletonMatrixData)},i}(t.MethodBase);t.SkinVertexMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.index=0,this.time=0,this.normalMatrix=new t.Matrix4_4,this.vsMethodName="particle_vertex"}return __extends(i,e),i.prototype.activate=function(t,e,i,a,r,s){for(r.sharedVertexBuffer=t.creatVertexBuffer(r.verticesData),r.numberOfVertices=s.animaNodeCollection.numberOfVertices,r.vertexSizeInBytes=s.animaNodeCollection.vertexSizeInBytes,r.sharedIndexBuffer=t.creatIndexBuffer(r.indexData),t.bindVertexBuffer(r.sharedVertexBuffer),this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_position.name),this.usage.attribute_offset.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_offset.name),this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(e,this.usage.attribute_uv0.name),this.index=0;this.index<s.animaNodeCollection.nodes.length;this.index++)s.animaNodeCollection.nodes[this.index].usageAttributeLen>0&&(s.animaNodeCollection.nodes[this.index].uniformIndex=t.getShaderAttribLocation(e,s.animaNodeCollection.nodes[this.index].usageAttribute));this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ModelMatrix.name),this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_ProjectionMatrix.name),this.usage.uniform_eyepos.uniformIndex=t.getUniformLocation(e,this.usage.uniform_eyepos.name),this.usage.uniform_time.uniformIndex=t.getUniformLocation(e,this.usage.uniform_time.name),this.usage.uniform_cameraMatrix.uniformIndex=t.getUniformLocation(e,this.usage.uniform_cameraMatrix.name)},i.prototype.updata=function(e,i,a,r,s,n){e.bindVertexBuffer(s.sharedVertexBuffer),e.vertexAttribPointer(i,this.usage.attribute_position.uniformIndex,4,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,0),e.vertexAttribPointer(i,this.usage.attribute_offset.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,16),e.vertexAttribPointer(i,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,28);var o;for(this.index=0;this.index<n.animaNodeCollection.nodes.length;this.index++)n.animaNodeCollection.nodes[this.index].usageAttributeLen>0&&(o=n.animaNodeCollection.nodes[this.index],e.vertexAttribPointer(i,o.uniformIndex,o.usageAttributeLen,t.Egret3DDrive.FLOAT,!1,s.vertexSizeInBytes,o.offsetBytes));e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,!1,a.rawData),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,r.viewProjectionMatrix.rawData),e.uniformMatrix4fv(this.usage.uniform_cameraMatrix.uniformIndex,!1,r.modelMatrix.rawData),e.uniform3f(this.usage.uniform_eyepos.uniformIndex,r.x,r.y,r.z),e.uniform1f(this.usage.uniform_time.uniformIndex,n.time)},i}(t.MethodBase);t.ParticleVertexMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.fsMethodName="Shadow_fragment"}return __extends(e,t),e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n)},e.prototype.updata=function(t,e,i,a,r,s){},e}(t.MethodBase);t.ShadowMapMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.uvData=new Float32Array(8),this.fsMethodName="diffuseMethod_fragment",this.uvData[0]=1,this.uvData[1]=1,this.uvData[2]=1,this.uvData[3]=1,this.uvData[4]=1,this.uvData[5]=1,this.uvData[6]=1,this.uvData[7]=1}return __extends(e,t),e.prototype.setUVTitling=function(t,e,i){this.uvData[2*t]=e,this.uvData[2*t+1]=i},e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n),this.usage.uniform_materialSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_materialSource.varName),this.uvIndex=e.getUniformLocation(i,"uvs"),this.materialData.directLightList.length>0&&(this.usage.uniform_directLightSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_directLightSource.varName)),this.materialData.sportLightList.length>0&&(this.usage.uniform_sportLightSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_sportLightSource.varName)),this.materialData.pointLightList.length>0&&(this.usage.uniform_pointLightSource.uniformIndex=e.getUniformLocation(i,this.usage.uniform_pointLightSource.varName))},e.prototype.updata=function(t,e,i,a,r,s){this.materialData.materialDataNeedChange&&(this.materialData.materialDataNeedChange=!1,this.materialData.diffusePassUsageData.materialSourceData[0]=this.materialData.diffuseColor>>24&1,this.materialData.diffusePassUsageData.materialSourceData[1]=this.materialData.diffuseColor>>16&1,this.materialData.diffusePassUsageData.materialSourceData[2]=this.materialData.diffuseColor>>8&1,this.materialData.diffusePassUsageData.materialSourceData[3]=this.materialData.ambientColor>>24&1,this.materialData.diffusePassUsageData.materialSourceData[4]=this.materialData.ambientColor>>16&1,this.materialData.diffusePassUsageData.materialSourceData[5]=this.materialData.ambientColor>>8&1,this.materialData.diffusePassUsageData.materialSourceData[6]=this.materialData.specularColor>>24&1,this.materialData.diffusePassUsageData.materialSourceData[7]=this.materialData.specularColor>>16&1,this.materialData.diffusePassUsageData.materialSourceData[8]=this.materialData.specularColor>>8&1,this.materialData.diffusePassUsageData.materialSourceData[9]=this.materialData.alpha,this.materialData.diffusePassUsageData.materialSourceData[10]=this.materialData.cutAlpha,this.materialData.diffusePassUsageData.materialSourceData[11]=this.materialData.shininess),t.gl.uniform1fv(this.usage.uniform_materialSource.uniformIndex,this.materialData.diffusePassUsageData.materialSourceData),t.gl.uniform1fv(this.uvIndex,this.uvData),this.materialData.directLightList.length>0&&t.gl.uniform1fv(this.usage.uniform_directLightSource.uniformIndex,this.usage.directLightData),this.materialData.sportLightList.length>0&&t.gl.uniform1fv(this.usage.uniform_sportLightSource.uniformIndex,this.usage.sportLightData),this.materialData.pointLightList.length>0&&t.gl.uniform1fv(this.usage.uniform_pointLightSource.uniformIndex,this.usage.pointLightData)},e.prototype.dispose=function(){},e}(t.MethodBase);t.TerrainMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.fsMethodName="normalMethod_fragment"}return __extends(e,t),e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n)},e.prototype.updata=function(t,e,i,a,r,s){},e.prototype.dispose=function(){},e}(t.MethodBase);t.NormalMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.fsMethodName=""}return __extends(e,t),e.prototype.activate=function(t,e,i,a,r,s){},e.prototype.updata=function(t,e,i,a,r,s){},e.prototype.dispose=function(){},e}(t.MethodBase);t.DepthMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.fsMethodName="diffuseMethod_fragment"}return __extends(e,t),e.prototype.activate=function(e,i,a,r,s,n){t.prototype.activate.call(this,e,i,a,r,s,n)},e.prototype.updata=function(t,e,i,a,r,s){},e.prototype.dispose=function(){},e}(t.MethodBase);t.DiffuseMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.bias=.002,this.shdowColorR=.3,this.shdowColorG=.3,this.shdowColorB=.5,this.vsMethodName="ShadowMapping_vertex",this.fsMethodName="shadowmapping_fragment"}return __extends(i,e),i.prototype.setMaterialData=function(e,i){this.usage=i,this.materialData=e,this.materialData.shadowMapTex=t.ShadowRender.frameBuffer.texture},i.prototype.activate=function(t,i,a,r,s,n){e.prototype.activate.call(this,t,i,a,r,s,n),i.shadowParameterUniformIndex=t.getUniformLocation(i,"shadowParameter")},i.prototype.updata=function(t,e,i,a,r,s){t.uniform4f(e.shadowParameterUniformIndex,this.shdowColorR,this.shdowColorG,this.shdowColorB,this.bias)},i}(t.MethodBase);t.ShadowMapingMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.vsMethodName="",this.fsMethodName=""}return t.prototype.setMaterialData=function(t,e){this.usage=e,this.materialData=t},Object.defineProperty(t.prototype,"vertexMethodName",{get:function(){return this.vsMethodName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fragMethodName",{get:function(){return this.fsMethodName},enumerable:!0,configurable:!0}),t.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t},t.prototype.updataEffect=function(t,e,i,a,r,s,n){},t.prototype.dispose=function(){},t}();t.EffectMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this),this._aoPower=1,this.fsMethodName="AOMap_fragment",this.aoTexture=t}return __extends(i,e),Object.defineProperty(i.prototype,"aoPower",{get:function(){return this._aoPower},set:function(t){this._aoPower=t},enumerable:!0,configurable:!0}),i.prototype.setMaterialData=function(e,i){this.usage=i,this.materialData=e,this.texture?this.materialData.aoMapTex=this.texture:this.materialData.aoMapTex=t.CheckerboardTexture.texture},Object.defineProperty(i.prototype,"aoTexture",{set:function(t){this.texture=t,t&&this.materialData&&(this.materialData.aoMapTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t,e.aoPower=t.getUniformLocation(e.program3D,"aoPower")},i.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform1f(e.aoPower,this._aoPower)},i.prototype.dispose=function(){},i}(t.EffectMethod);t.AOMapMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this),this.fsMethodName="lightMap_fragment",this.lightTexture=t}return __extends(i,e),i.prototype.setMaterialData=function(e,i){this.usage=i,this.materialData=e,this.texture?this.materialData.lightMapTex=this.texture:this.materialData.lightMapTex=t.CheckerboardTexture.texture},Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t,t&&this.materialData&&(this.materialData.lightMapTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t},i.prototype.updataEffect=function(t,e,i,a,r,s,n){},i.prototype.dispose=function(){},i}(t.EffectMethod);t.LightMapMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this),this.reflectValue=1,this.fsMethodName="EnvironmentMapping_fragment",this.lightTexture=t}return __extends(i,e),Object.defineProperty(i.prototype,"reflect",{get:function(){return this.reflectValue},set:function(t){this.reflectValue=t},enumerable:!0,configurable:!0}),i.prototype.setMaterialData=function(e,i){this.usage=i,this.materialData=e,this.texture?this.materialData.environmentMapTex=this.texture:this.materialData.environmentMapTex=t.CheckerboardTexture.texture},Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t,t&&this.materialData&&(this.materialData.environmentMapTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t,e.reflectValue=t.getUniformLocation(e.program3D,"reflectValue")},i.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform1f(e.reflectValue,this.reflectValue)},i.prototype.dispose=function(){},i}(t.EffectMethod);t.EnvironmentMappingMethod=e}(egret3d||(egret3d={}));
var egret3d;!function(t){var e=function(e){function i(t,i){e.call(this),this._rimPower=.9,this._envLightPower=.5,this._maskColor=16777215,this._maskColorR=1,this._maskColorG=0,this._maskColorB=0,this.fsMethodName="PaintFresnelReflection_fragment",this.envtexture=t,this.randomTexture=i}return __extends(i,e),Object.defineProperty(i.prototype,"rimPower",{get:function(){return this._rimPower},set:function(t){this._rimPower=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"envLightPower",{get:function(){return this._envLightPower},set:function(t){this._envLightPower=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maskColor",{get:function(){return this._maskColor},set:function(t){this._maskColor=t,this._maskColorR=(t>>16&255)/255,this._maskColorG=(t>>8&255)/255,this._maskColorB=(255&t)/255},enumerable:!0,configurable:!0}),i.prototype.setMaterialData=function(e,i){this.usage=i,this.materialData=e,this._envtexture?this.materialData.environmentMapTex=this._envtexture:this.materialData.environmentMapTex=t.CheckerboardTexture.texture,this._randomTexture?this.materialData.maskTex=this._randomTexture:this.materialData.maskTex=t.CheckerboardTexture.texture},Object.defineProperty(i.prototype,"envtexture",{set:function(t){this._envtexture=t,t&&this.materialData&&(this.materialData.environmentMapTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"randomTexture",{set:function(t){this._randomTexture=t,t&&this.materialData&&(this.materialData.maskTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t,e.maskColor=t.getUniformLocation(e.program3D,"maskColor"),e.rimPower=t.getUniformLocation(e.program3D,"rimPower"),e.envLightPower=t.getUniformLocation(e.program3D,"envLightPower")},i.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform3f(e.maskColor,this._maskColorR,this._maskColorG,this._maskColorB),t.gl.uniform1f(e.rimPower,this._rimPower),t.gl.uniform1f(e.envLightPower,this._envLightPower)},i.prototype.dispose=function(){},i}(t.EffectMethod);t.PaintFresnelReflectionMappingMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this),this.reflectValue=1,this.fsMethodName="SpecularEnvironmentMappingMethod",this.lightTexture=t}return __extends(i,e),Object.defineProperty(i.prototype,"reflect",{get:function(){return this.reflectValue},set:function(t){this.reflectValue=t},enumerable:!0,configurable:!0}),i.prototype.setMaterialData=function(e,i){this.usage=i,this.materialData=e,this.texture?this.materialData.environmentMapTex=this.texture:this.materialData.environmentMapTex=t.CheckerboardTexture.texture},Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t,t&&this.materialData&&(this.materialData.environmentMapTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t},i.prototype.updataEffect=function(t,e,i,a,r,s,n){},i.prototype.dispose=function(){},i}(t.EffectMethod);t.SpecularEnvironmentMappingMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this),this.reflectValue=1,this.fsMethodName="AlphaEnvironmentMapping_fragment",this.lightTexture=t}return __extends(i,e),i.prototype.setMaterialData=function(e,i){this.usage=i,this.materialData=e,this.texture?this.materialData.environmentMapTex=this.texture:this.materialData.environmentMapTex=t.CheckerboardTexture.texture},Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t,t&&this.materialData&&(this.materialData.environmentMapTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.dispose=function(){},i}(t.EffectMethod);t.AlphaEnvironmentMappingMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this._fogColor=4294967295,this._globalDensity=1,this._startDistance=500,this._distanceScale=.1,this._height=500,this._heightScale=.1,this.fsMethodName="distanceFog_fragment",this._data=new Float32Array(8),this.fogColor=this._fogColor,this.globalDensity=this._globalDensity}return __extends(e,t),Object.defineProperty(e.prototype,"fogColor",{get:function(){return this._fogColor},set:function(t){this._fogColor=t,this._data[0]=(t>>16&255)/255,this._data[1]=(t>>8&255)/255,this._data[2]=(255&t)/255},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(t){this._globalDensity=t,this._data[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"startDistance",{get:function(){return this._startDistance},set:function(t){this._startDistance=t,this._data[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"distanceScale",{get:function(){return this._distanceScale},set:function(t){this._distanceScale=t,this._data[5]=t},enumerable:!0,configurable:!0}),e.prototype.activateEffect=function(t,e,i,a,r,s,n){this.context3D=t,e.uniform_globalFog=t.getUniformLocation(e.program3D,"uniform_globalFog")},e.prototype.updataEffect=function(t,e,i,a,r,s,n){t.gl.uniform1fv(e.uniform_globalFog,this._data)},e.prototype.dispose=function(){},e}(t.EffectMethod);t.DistanceFog=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){void 0===t&&(t=null),this.shaderChange=!1,this.context3DChange=!1,this.materialData=t}return t.prototype.addMethod=function(t){this.methodList=this.methodList||new Array,this.methodList.push(t),this.shaderChange=!0},t.prototype.removeMethod=function(t){var e=this.methodList.indexOf(t);this.methodList.splice(e,1),t.dispose()},t.prototype.addEffectMethod=function(t){this.effectMethodList=this.effectMethodList||new Array,this.effectMethodList.push(t),this.shaderChange=!0},t.prototype.removeEffectMethod=function(t){var e=this.effectMethodList.indexOf(t);this.effectMethodList.splice(e,1),t.dispose()},t.prototype.initShader=function(t,e,i){this.animation=i},t.prototype.resetTexture=function(){},t.prototype.buildShader=function(t){},t.prototype.activate=function(t,e,i,a,r){},t.prototype.draw=function(t,e,i,a,r){this.materialData.depthTest?(t.gl.enable(t.gl.DEPTH_TEST),t.gl.depthFunc(t.gl.LEQUAL)):(t.gl.disable(t.gl.DEPTH_TEST),t.gl.depthFunc(t.gl.LEQUAL)),t.gl.cullFace(this.materialData.cullFrontOrBack),this.materialData.bothside?t.gl.disable(t.gl.CULL_FACE):t.gl.enable(t.gl.CULL_FACE),t.gl.enable(t.gl.BLEND),t.setBlendFactors(this.materialData.blend_src,this.materialData.blend_dest),this.materialData.alphaBlending&&t.gl.depthMask(!1)},t.prototype.unActive=function(t,e){},t}();t.MaterialPassBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this,t),this.index=0}return __extends(i,e),i.prototype.initUseMethod=function(){var e=0;for(this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride),this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride),this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride),this.diffuseMethod=new t.DiffuseMethod,this.pixelShader.addMethod(this.diffuseMethod),this.pixelShader.addShader(this.diffuseMethod.fragMethodName),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.DIFFUSE)&&this.pixelShader.addShader("diffuseMap_fragment"),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.NORMAL)&&this.pixelShader.addShader("normalMap_fragment"),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.SPECULAR)&&this.pixelShader.addShader("specularMap_fragment"),e=0;e<this.materialData.directLightList.length;e++)this.pixelShader.addShader("directLight_fragment");for(e=0;e<this.materialData.sportLightList.length;e++)this.pixelShader.addShader("spotLight_fragment");for(e=0;e<this.materialData.pointLightList.length;e++)this.pixelShader.addShader("pointLight_fragment");if(this.animation&&this.animation.animaNodeCollection){var i=this.animation.animaNodeCollection.getNodesVertexShaders(),a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++)this.vertexShader.addShader(i[e]);for(e=0;e<a.length;e++)this.pixelShader.addShader(a[e])}if(this.materialData.acceptShadow&&this.shadowMaping&&(this.pixelShader.addMethod(this.shadowMaping),this.vertexShader.addShader(this.shadowMaping.vertexMethodName),this.pixelShader.addShader(this.shadowMaping.fragMethodName)),this.pixelShader.addShader("diffuse_fragmentEnd"),this.effectMethodList)for(var e=0;e<this.effectMethodList.length;e++)this.pixelShader.addEffectMethod(this.effectMethodList[e]),this.pixelShader.addShader(this.effectMethodList[e].fragMethodName)},i.prototype.initShader=function(i,a,r){e.prototype.initShader.call(this,i,a,r),this.vertexShader=new t.VertexShader(this.materialData,this.materialData.diffusePassUsageData),this.pixelShader=new t.PixelShader(this.materialData,this.materialData.diffusePassUsageData),this.materialData.context3D=i,this.vertexShader.setVertexShader(a),this.initUseMethod(),r&&r.initShader(this.vertexShader,this.pixelShader),this.vertexShader.build(),this.pixelShader.build();var s=this.vertexShader.getShaderSource(),n=this.pixelShader.getShaderSource(),o=i.creatVertexShader(s),h=i.creatFragmentShader(n);this.materialData.diffusePassUsageData.program3D=i.creatProgram(o,h),this.context3DChange=!0},i.prototype.resetTexture=function(){var t;for(var e in this.materialData.diffusePassUsageData.sampler2DList)t=this.materialData.diffusePassUsageData.sampler2DList[e],this.materialData[t.varName]&&(t.texture=this.materialData[t.varName]);var i;for(var e in this.materialData.diffusePassUsageData.sampler3DList)i=this.materialData.diffusePassUsageData.sampler3DList[e],this.materialData[i.varName]&&(i.texture=this.materialData[i.varName]);this.materialData.textureChange=!1},i.prototype.activate=function(t,e,i,a,r){for(this.materialData.diffusePassUsageData.uniform_materialSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_materialSource.varName),this.materialData.directLightList.length>0&&(this.materialData.diffusePassUsageData.uniform_directLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_directLightSource.varName)),this.materialData.sportLightList.length>0&&(this.materialData.diffusePassUsageData.uniform_sportLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_sportLightSource.varName)),this.materialData.pointLightList.length>0&&(this.materialData.diffusePassUsageData.uniform_pointLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_pointLightSource.varName)),this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++)this.materialData.diffusePassUsageData.vsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++)this.materialData.diffusePassUsageData.fsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.diffusePassUsageData.effectMethodList.length;this.index++)this.materialData.diffusePassUsageData.effectMethodList[this.index].activateEffect(t,this.materialData.diffusePassUsageData,this.materialData,e,i,a,r);this.resetTexture();var s;for(var n in this.materialData.diffusePassUsageData.sampler2DList)s=this.materialData.diffusePassUsageData.sampler2DList[n],s.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,s.varName);var o;for(var n in this.materialData.diffusePassUsageData.sampler3DList)o=this.materialData.diffusePassUsageData.sampler3DList[n],o.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,o.varName)},i.prototype.draw=function(i,a,r,s,n){i.gl.useProgram(this.materialData.diffusePassUsageData.program3D.program),e.prototype.draw.call(this,i,a,r,s,n);var o=0;this.materialData.materialDataNeedChange&&(this.materialData.diffusePassUsageData.materialSourceData[0]=(this.materialData.diffuseColor>>16&255)/255,this.materialData.diffusePassUsageData.materialSourceData[1]=(this.materialData.diffuseColor>>8&255)/255,this.materialData.diffusePassUsageData.materialSourceData[2]=(255&this.materialData.diffuseColor)/255,this.materialData.diffusePassUsageData.materialSourceData[3]=(this.materialData.ambientColor>>16&255)/255,this.materialData.diffusePassUsageData.materialSourceData[4]=(this.materialData.ambientColor>>8&255)/255,this.materialData.diffusePassUsageData.materialSourceData[5]=(255&this.materialData.ambientColor)/255,this.materialData.diffusePassUsageData.materialSourceData[6]=(this.materialData.specularColor>>16&255)/255,this.materialData.diffusePassUsageData.materialSourceData[7]=(this.materialData.specularColor>>8&255)/255,this.materialData.diffusePassUsageData.materialSourceData[8]=(255&this.materialData.specularColor)/255,this.materialData.diffusePassUsageData.materialSourceData[9]=this.materialData.alpha,this.materialData.diffusePassUsageData.materialSourceData[10]=this.materialData.cutAlpha,this.materialData.diffusePassUsageData.materialSourceData[11]=this.materialData.shininess,this.materialData.diffusePassUsageData.materialSourceData[12]=this.materialData.diffusePower,this.materialData.diffusePassUsageData.materialSourceData[13]=this.materialData.specularPower,this.materialData.diffusePassUsageData.materialSourceData[14]=this.materialData.ambientPower,this.materialData.diffusePassUsageData.materialSourceData[15]=this.materialData.normalPower),i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_materialSource.uniformIndex,this.materialData.diffusePassUsageData.materialSourceData);var h;for(var u in this.materialData.diffusePassUsageData.sampler2DList)if(h=this.materialData.diffusePassUsageData.sampler2DList[u],h.texture.upload(i),i.setTexture2DAt(h.activeTextureIndex,h.uniformIndex,h.index,h.texture.texture),this.materialData.materialDataNeedChange){var l=this.materialData.smooth?i.gl.LINEAR_MIPMAP_LINEAR:i.gl.LINEAR,c=this.materialData.smooth?i.gl.LINEAR:i.gl.LINEAR,d=this.materialData.repeat?i.gl.REPEAT:i.gl.CLAMP_TO_EDGE,f=this.materialData.repeat?i.gl.REPEAT:i.gl.CLAMP_TO_EDGE;i.setTexture2DSamplerState(l,c,d,f),this.materialData.materialDataNeedChange=!1}var p;for(var u in this.materialData.diffusePassUsageData.sampler3DList)p=this.materialData.diffusePassUsageData.sampler3DList[u],p.texture.upload(i),i.setCubeTextureAt(p.activeTextureIndex,p.uniformIndex,p.index,p.texture.cubeTexture);for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++)this.materialData.diffusePassUsageData.vsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n);if(this.materialData.diffusePassUsageData.uniform_directLightSource){for(o=0;o<this.materialData.directLightList.length;o++)this.materialData.directLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.directLightData);i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_directLightSource.uniformIndex,this.materialData.diffusePassUsageData.directLightData)}if(this.materialData.diffusePassUsageData.uniform_sportLightSource){for(o=0;o<this.materialData.sportLightList.length;o++)this.materialData.sportLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.sportLightData);i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_sportLightSource.uniformIndex,this.materialData.diffusePassUsageData.sportLightData)}if(this.materialData.diffusePassUsageData.uniform_pointLightSource){for(o=0;o<this.materialData.pointLightList.length;o++)this.materialData.pointLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.pointLightData);i.gl.uniform1fv(this.materialData.diffusePassUsageData.uniform_pointLightSource.uniformIndex,this.materialData.diffusePassUsageData.pointLightData)}for(this.context3DChange&&(this.activate(i,a,r,s,n),this.context3DChange=!1),this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++)this.materialData.diffusePassUsageData.vsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n);for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++)this.materialData.diffusePassUsageData.fsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n);for(this.index=0;this.index<this.materialData.diffusePassUsageData.effectMethodList.length;this.index++)this.materialData.diffusePassUsageData.effectMethodList[this.index].updataEffect(i,this.materialData.diffusePassUsageData,this.materialData,a,r,s,n);i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer),i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0),this.materialData.alphaBlending&&i.gl.depthMask(!0);for(var u in this.materialData.diffusePassUsageData.sampler2DList)i.gl.bindTexture(i.gl.TEXTURE_2D,null)},i}(t.MaterialPassBase);t.DiffuseMapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this,t),this.index=0}return __extends(i,e),i.prototype.initUseMethod=function(){var e=0;for(this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride),this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride),this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride),this.diffuseMethod=new t.DiffuseMethod,this.pixelShader.addMethod(this.diffuseMethod),this.pixelShader.addShader(this.diffuseMethod.fragMethodName),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.DIFFUSE)&&this.pixelShader.addShader("cubeDiffuseMap_fragment"),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.NORMAL)&&this.pixelShader.addShader("normalMap_fragment"),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.SPECULAR)&&this.pixelShader.addShader("specularMap_fragment"),e=0;e<this.materialData.directLightList.length;e++)this.pixelShader.addShader("directLight_fragment");for(e=0;e<this.materialData.sportLightList.length;e++)this.pixelShader.addShader("sportLight_fragment");for(e=0;e<this.materialData.pointLightList.length;e++)this.pixelShader.addShader("pointLight_fragment");if(this.animation&&this.animation.animaNodeCollection){var i=this.animation.animaNodeCollection.getNodesVertexShaders(),a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++)this.vertexShader.addShader(i[e]);for(e=0;e<a.length;e++)this.pixelShader.addShader(a[e])}if(this.materialData.acceptShadow&&this.shadowMaping&&(this.pixelShader.addMethod(this.shadowMaping),this.vertexShader.addShader(this.shadowMaping.vertexMethodName),this.pixelShader.addShader(this.shadowMaping.fragMethodName)),this.pixelShader.addShader("diffuse_fragmentEnd"),this.effectMethodList)for(var e=0;e<this.effectMethodList.length;e++)this.pixelShader.addEffectMethod(this.effectMethodList[e]),this.pixelShader.addShader(this.effectMethodList[e].fragMethodName)},i.prototype.initShader=function(t,i,a){e.prototype.initShader.call(this,t,i,a)},i.prototype.resetTexture=function(){var t;for(var e in this.materialData.diffusePassUsageData.sampler2DList)t=this.materialData.diffusePassUsageData.sampler2DList[e],this.materialData[t.varName]&&(t.texture=this.materialData[t.varName]);var i;for(var e in this.materialData.diffusePassUsageData.sampler3DList)i=this.materialData.diffusePassUsageData.sampler3DList[e],this.materialData[i.varName]&&(i.texture=this.materialData[i.varName]);this.materialData.textureChange=!1},i.prototype.activate=function(t,e,i,a,r){for(this.materialData.diffusePassUsageData.uniform_materialSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_materialSource.varName),this.materialData.directLightList.length>0&&(this.materialData.diffusePassUsageData.uniform_directLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_directLightSource.varName)),this.materialData.sportLightList.length>0&&(this.materialData.diffusePassUsageData.uniform_sportLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_sportLightSource.varName)),this.materialData.pointLightList.length>0&&(this.materialData.diffusePassUsageData.uniform_pointLightSource.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,this.materialData.diffusePassUsageData.uniform_pointLightSource.varName)),this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++)this.materialData.diffusePassUsageData.vsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++)this.materialData.diffusePassUsageData.fsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.diffusePassUsageData.effectMethodList.length;this.index++)this.materialData.diffusePassUsageData.effectMethodList[this.index].activateEffect(t,this.materialData.diffusePassUsageData,this.materialData,e,i,a,r);this.resetTexture();var s;for(var n in this.materialData.diffusePassUsageData.sampler2DList)s=this.materialData.diffusePassUsageData.sampler2DList[n],s.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,s.varName);var o;for(var n in this.materialData.diffusePassUsageData.sampler3DList)o=this.materialData.diffusePassUsageData.sampler3DList[n],o.uniformIndex=t.getUniformLocation(this.materialData.diffusePassUsageData.program3D,o.varName)},i.prototype.draw=function(t,i,a,r,s){e.prototype.draw.call(this,t,i,a,r,s)},i}(t.DiffuseMapPass);t.CubeDiffuseMapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this,i),this.diffuseMethod=new t.TerrainMethod}return __extends(i,e),i.prototype.initUseMethod=function(){var e=0;for(this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride),this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride),this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride),this.pixelShader.addMethod(this.diffuseMethod),this.pixelShader.addShader(this.diffuseMethod.fragMethodName),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.DIFFUSE)&&this.pixelShader.addShader("diffuseMap_fragment"),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.NORMAL)&&this.pixelShader.addShader("normalMap_fragment"),-1!=this.materialData.textureMethodTypes.indexOf(t.TextureMethodType.SPECULAR)&&this.pixelShader.addShader("specularMap_fragment"),this.pixelShader.addShader("terrainRGBA_fragment"),e=0;e<this.materialData.directLightList.length;e++)this.pixelShader.addShader("directLight_fragment");for(e=0;e<this.materialData.sportLightList.length;e++)this.pixelShader.addShader("spotLight_fragment");for(e=0;e<this.materialData.pointLightList.length;e++)this.pixelShader.addShader("pointLight_fragment");if(this.animation&&this.animation.animaNodeCollection){var i=this.animation.animaNodeCollection.getNodesVertexShaders(),a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++)this.vertexShader.addShader(i[e]);for(e=0;e<a.length;e++)this.pixelShader.addShader(a[e])}if(this.pixelShader.addShader("diffuse_fragmentEnd"),this.effectMethodList)for(var e=0;e<this.effectMethodList.length;e++)this.pixelShader.addEffectMethod(this.effectMethodList[e]),this.pixelShader.addShader(this.effectMethodList[e].fragMethodName);if(this.materialData.acceptShadow){var r=new t.ShadowMapingMethod;this.pixelShader.addMethod(r),this.vertexShader.addShader(r.vertexMethodName),this.pixelShader.addShader(r.fragMethodName)}},i}(t.DiffuseMapPass);t.TerrainMapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this,t),this.index=0}return __extends(i,e),i.prototype.initUseMethod=function(){this.pixelShader.addShader("depthMethod_fragment")},i.prototype.initShader=function(e,i,a){this.vertexShader=new t.VertexShader(this.materialData,this.materialData.depthPassUsageData),this.pixelShader=new t.PixelShader(this.materialData,this.materialData.depthPassUsageData),this.materialData.context3D=e,this.vertexShader.setVertexShader(i),this.initUseMethod(),this.vertexShader.build(),this.pixelShader.build(),a&&(this.vertexShader.maxBone=2*a.jointNumber);var r=this.vertexShader.getShaderSource(),s=this.pixelShader.getShaderSource(),n=e.creatVertexShader(r),o=e.creatFragmentShader(s);this.materialData.depthPassUsageData.program3D=e.creatProgram(n,o),this.context3DChange=!0},i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.depthPassUsageData.vsMethodList.length;this.index++)this.materialData.depthPassUsageData.vsMethodList[this.index].activate(t,this.materialData.depthPassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.depthPassUsageData.fsMethodList.length;this.index++)this.materialData.depthPassUsageData.fsMethodList[this.index].activate(t,this.materialData.depthPassUsageData.program3D,e,i,a,r)},i.prototype.draw=function(i,a,r,s,n){e.prototype.draw.call(this,i,a,r,s,n);for(this.context3DChange&&(this.activate(i,a,r,s,n),this.context3DChange=!1),this.index=0;this.index<this.materialData.depthPassUsageData.vsMethodList.length;this.index++)this.materialData.depthPassUsageData.vsMethodList[this.index].updata(i,this.materialData.depthPassUsageData.program3D,a,r,s,n);for(this.index=0;this.index<this.materialData.depthPassUsageData.fsMethodList.length;this.index++)this.materialData.depthPassUsageData.fsMethodList[this.index].updata(i,this.materialData.depthPassUsageData.program3D,a,r,s,n);i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer),i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0)},i}(t.MaterialPassBase);t.DepthMapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this,t),this.index=0}return __extends(i,e),i.prototype.initUseMethod=function(){var e=0;if(this.normalMethod=new t.NormalMethod,this.pixelShader.addMethod(this.normalMethod),this.pixelShader.addShader(this.normalMethod.fragMethodName),this.animation){var i=this.animation.animaNodeCollection.getNodesVertexShaders(),a=this.animation.animaNodeCollection.getNodesFragmentShaders();for(e=0;e<i.length;e++)this.vertexShader.addShader(i[e]);for(e=0;e<i.length;e++)this.pixelShader.addShader(a[e])}},i.prototype.initShader=function(e,i,a){this.vertexShader=new t.VertexShader(this.materialData,this.materialData.normalPassUsageData),this.pixelShader=new t.PixelShader(this.materialData,this.materialData.normalPassUsageData),this.materialData.context3D=e,this.vertexShader.setVertexShader(i),this.initUseMethod(),this.vertexShader.build(),this.pixelShader.build(),a&&(this.vertexShader.maxBone=2*a.jointNumber);var r=this.vertexShader.getShaderSource(),s=this.pixelShader.getShaderSource(),n=e.creatVertexShader(r),o=e.creatFragmentShader(s);this.materialData.normalPassUsageData.program3D=e.creatProgram(n,o),this.context3DChange=!0},i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.normalPassUsageData.vsMethodList.length;this.index++)this.materialData.normalPassUsageData.vsMethodList[this.index].activate(t,this.materialData.normalPassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.normalPassUsageData.fsMethodList.length;this.index++)this.materialData.normalPassUsageData.fsMethodList[this.index].activate(t,this.materialData.normalPassUsageData.program3D,e,i,a,r)},i.prototype.draw=function(i,a,r,s,n){i.setProgram(this.materialData.normalPassUsageData.program3D),e.prototype.draw.call(this,i,a,r,s,n);for(this.context3DChange&&(this.activate(i,a,r,s,n),this.context3DChange=!1),this.index=0;this.index<this.materialData.normalPassUsageData.vsMethodList.length;this.index++)this.materialData.normalPassUsageData.vsMethodList[this.index].updata(i,this.materialData.normalPassUsageData.program3D,a,r,s,n);for(this.index=0;this.index<this.materialData.normalPassUsageData.fsMethodList.length;this.index++)this.materialData.normalPassUsageData.fsMethodList[this.index].updata(i,this.materialData.normalPassUsageData.program3D,a,r,s,n);i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer),i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0)},i}(t.MaterialPassBase);t.NormalMapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this,t),this.index=0}return __extends(i,e),i.prototype.initUseMethod=function(){this.materialData.diffusePassUsageData.directLightData=new Float32Array(this.materialData.directLightList.length*t.DirectLight.stride),this.materialData.diffusePassUsageData.sportLightData=new Float32Array(this.materialData.sportLightList.length*t.SpotLight.stride),this.materialData.diffusePassUsageData.pointLightData=new Float32Array(this.materialData.pointLightList.length*t.PointLight.stride),this.diffuseMethod=new t.DiffuseMethod,this.pixelShader.addMethod(this.diffuseMethod),this.pixelShader.addShader(this.diffuseMethod.fragMethodName)},i.prototype.initShader=function(e,i,a){this.vertexShader=new t.VertexShader(this.materialData,this.materialData.diffusePassUsageData),this.pixelShader=new t.PixelShader(this.materialData,this.materialData.diffusePassUsageData),this.materialData.context3D=e,this.vertexShader.setVertexShader(i),this.initUseMethod(),this.vertexShader.build(),this.pixelShader.build(),a&&(this.vertexShader.maxBone=2*a.jointNumber);var r=this.vertexShader.getShaderSource(),s=this.pixelShader.getShaderSource(),n=e.creatVertexShader(r),o=e.creatFragmentShader(s);this.materialData.diffusePassUsageData.program3D=e.creatProgram(n,o),this.context3DChange=!0},i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++)this.materialData.diffusePassUsageData.vsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++)this.materialData.diffusePassUsageData.fsMethodList[this.index].activate(t,this.materialData.diffusePassUsageData.program3D,e,i,a,r)},i.prototype.updata=function(i,a,r,s,n){e.prototype.draw.call(this,i,a,r,s,n);var o;for(o=0;o<this.materialData.directLightList.length;o++)this.materialData.directLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.directLightData);for(o=0;o<this.materialData.sportLightList.length;o++)this.materialData.sportLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.sportLightData);
for(o=0;o<this.materialData.pointLightList.length;o++)this.materialData.pointLightList[o].updateLightData(o,this.materialData.diffusePassUsageData.pointLightData);for(this.context3DChange&&(this.activate(i,a,r,s,n),this.context3DChange=!1),this.index=0;this.index<this.materialData.diffusePassUsageData.vsMethodList.length;this.index++)this.materialData.diffusePassUsageData.vsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n);for(this.index=0;this.index<this.materialData.diffusePassUsageData.fsMethodList.length;this.index++)this.materialData.diffusePassUsageData.fsMethodList[this.index].updata(i,this.materialData.diffusePassUsageData.program3D,a,r,s,n);i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer),i.drawElement(this.materialData.drawMode,s.sharedIndexBuffer,0,s.numItems)},i}(t.MaterialPassBase);t.ColorMapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this,t)}return __extends(i,e),i.prototype.initUseMethod=function(){var t=0;if(this.animation&&this.animation.animaNodeCollection){var e=this.animation.animaNodeCollection.getNodesVertexShaders(),i=this.animation.animaNodeCollection.getNodesFragmentShaders();for(t=0;t<e.length;t++)this.vertexShader.addShader(e[t]);for(t=0;t<i.length;t++)this.pixelShader.addShader(i[t])}this.pixelShader.addShader("Shadow_fragment")},i.prototype.initShader=function(i,a,r){e.prototype.initShader.call(this,i,a,r),this.vertexShader=new t.VertexShader(this.materialData,this.materialData.shadowPassUsageData),this.pixelShader=new t.PixelShader(this.materialData,this.materialData.shadowPassUsageData),this.materialData.context3D=i,this.vertexShader.setVertexShader(a),this.initUseMethod(),r&&r.initShader(this.vertexShader,this.pixelShader),this.vertexShader.build(),this.pixelShader.build();var s=this.vertexShader.getShaderSource(),n=this.pixelShader.getShaderSource(),o=i.creatVertexShader(s),h=i.creatFragmentShader(n);this.materialData.shadowPassUsageData.program3D=i.creatProgram(o,h),this.context3DChange=!0},i.prototype.activate=function(t,e,i,a,r){for(this.index=0;this.index<this.materialData.shadowPassUsageData.vsMethodList.length;this.index++)this.materialData.shadowPassUsageData.vsMethodList[this.index].activate(t,this.materialData.shadowPassUsageData.program3D,e,i,a,r);for(this.index=0;this.index<this.materialData.shadowPassUsageData.fsMethodList.length;this.index++)this.materialData.shadowPassUsageData.fsMethodList[this.index].activate(t,this.materialData.shadowPassUsageData.program3D,e,i,a,r);var s;for(var n in this.materialData.shadowPassUsageData.sampler2DList)s=this.materialData.shadowPassUsageData.sampler2DList[n],s.uniformIndex=t.getUniformLocation(this.materialData.shadowPassUsageData.program3D,s.varName);var o;for(var n in this.materialData.shadowPassUsageData.sampler3DList)o=this.materialData.shadowPassUsageData.sampler3DList[n],o.uniformIndex=t.getUniformLocation(this.materialData.shadowPassUsageData.program3D,o.varName)},i.prototype.draw=function(i,a,r,s,n){this.context3DChange&&(this.activate(i,a,r,s,n),this.context3DChange=!1),i.gl.useProgram(this.materialData.shadowPassUsageData.program3D.program),e.prototype.draw.call(this,i,a,r,s,n);var o;for(var h in this.materialData.shadowPassUsageData.sampler2DList)o=this.materialData.shadowPassUsageData.sampler2DList[h],o.texture=this.materialData[o.varName],o.texture.upload(i),i.setTexture2DAt(o.activeTextureIndex,o.uniformIndex,o.index,o.texture.texture);var u;for(var h in this.materialData.shadowPassUsageData.sampler3DList)u=this.materialData.shadowPassUsageData.sampler3DList[h],u.texture=this.materialData[u.varName],u.texture.upload(i),i.setCubeTextureAt(u.activeTextureIndex,u.uniformIndex,u.index,u.texture.cubeTexture);for(this.index=0;this.index<this.materialData.shadowPassUsageData.vsMethodList.length;this.index++)this.materialData.shadowPassUsageData.vsMethodList[this.index].updata(i,this.materialData.shadowPassUsageData.program3D,a,r,s,n);for(this.index=0;this.index<this.materialData.shadowPassUsageData.fsMethodList.length;this.index++)this.materialData.shadowPassUsageData.fsMethodList[this.index].updata(i,this.materialData.shadowPassUsageData.program3D,a,r,s,n);i.gl.bindBuffer(t.Egret3DDrive.ELEMENT_ARRAY_BUFFER,s.sharedIndexBuffer.buffer),i.gl.drawElements(this.materialData.drawMode,s.numItems,t.Egret3DDrive.UNSIGNED_SHORT,0);for(var h in this.materialData.shadowPassUsageData.sampler2DList)i.gl.bindTexture(i.gl.TEXTURE_2D,null)},i}(t.MaterialPassBase);t.ShadowMapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.DIFFUSE=0]="DIFFUSE",t[t.NORMAL=1]="NORMAL",t[t.SPECULAR=2]="SPECULAR",t[t.RGBATERRAIN=3]="RGBATERRAIN"}(t.TextureMethodType||(t.TextureMethodType={}));var e=t.TextureMethodType,i=function(){function i(e){void 0===e&&(e=null),null==e?(this.materialData=new t.MaterialData,this.materialData.diffusePassUsageData.materialSourceData=new Float32Array(16)):this.materialData=e,this.setData(this.materialData)}return i.prototype.initMatPass=function(){throw new Error("cant't constructor parent")},i.prototype.setData=function(t){this.materialData&&this.materialData.dispose(),this.materialData=t,this.ambientColor=this.materialData.ambientColor,this.ambientPower=this.materialData.ambientPower,this.normalPower=this.materialData.normalPower,this.specularColor=this.materialData.specularColor,this.specularPower=this.materialData.specularPower,this.blendMode=this.materialData.blendMode},i.prototype.getData=function(){return this.materialData},i.prototype.addDiffusePassMothod=function(t){this.diffusePass.addMethod(t)},i.prototype.addDiffusePassEffectMothod=function(t){this.diffusePass.addEffectMethod(t)},Object.defineProperty(i.prototype,"shadowMapingMethod",{get:function(){return this.diffusePass.shadowMaping},set:function(t){this.diffusePass.shadowMaping=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"diffuseColor",{set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"ambientColor",{set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.ambientColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"specularColor",{set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.specularColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha!=t&&(this.materialData.alpha=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"shininess",{get:function(){return this.materialData.shininess},set:function(t){this.materialData.shininess!=t&&(this.materialData.shininess=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"specularPower",{get:function(){return this.materialData.specularPower},set:function(t){this.materialData.specularPower!=t&&(this.materialData.specularPower=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"ambientPower",{get:function(){return this.materialData.ambientPower},set:function(t){this.materialData.ambientPower!=t&&(this.materialData.ambientPower=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"diffusePower",{get:function(){return this.materialData.diffusePower},set:function(t){this.materialData.diffusePower!=t&&(this.materialData.diffusePower=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"normalPower",{get:function(){return this.materialData.normalPower},set:function(t){this.materialData.normalPower!=t&&(this.materialData.normalPower=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"castShadow",{get:function(){return this.materialData.castShadow},set:function(e){this.materialData.castShadow=e,e&&(t.ShadowRender.frameBuffer?this.shadowPass||(this.shadowPass=new t.ShadowMapPass(this.materialData)):alert("shadow view3D.useShadow = true "))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"acceptShadow",{get:function(){return this.materialData.acceptShadow},set:function(t){this.materialData.acceptShadow=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"smooth",{get:function(){return this.materialData.smooth},set:function(t){this.materialData.smooth=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"repeat",{get:function(){return this.materialData.repeat},set:function(t){this.materialData.repeat=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bothside",{get:function(){return this.materialData.bothside},set:function(t){this.materialData.bothside=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cullMode",{get:function(){return this.materialData.cullFrontOrBack},set:function(t){this.materialData.cullFrontOrBack=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"blendMode",{get:function(){return this.materialData.blendMode},set:function(e){switch(this.materialData.blendMode=e,e){case t.BlendMode.NORMAL:this.materialData.blend_src=t.Egret3DDrive.ONE,this.materialData.blend_dest=t.Egret3DDrive.ZERO;break;case t.BlendMode.LAYER:this.materialData.blend_src=t.Egret3DDrive.SRC_ALPHA,this.materialData.blend_dest=t.Egret3DDrive.ZERO,this.materialData.alphaBlending=!0;break;case t.BlendMode.MULTIPLY:this.materialData.blend_src=t.Egret3DDrive.ZERO,this.materialData.blend_dest=t.Egret3DDrive.SRC_COLOR,this.materialData.alphaBlending=!0;break;case t.BlendMode.ADD:this.materialData.blend_src=t.Egret3DDrive.SRC_ALPHA,this.materialData.blend_dest=t.Egret3DDrive.ONE,this.materialData.alphaBlending=!0;break;case t.BlendMode.ALPHA:this.materialData.blend_src=t.Egret3DDrive.SRC_ALPHA,this.materialData.blend_dest=t.Egret3DDrive.ONE_MINUS_SRC_ALPHA,this.materialData.alphaBlending=!0;break;case t.BlendMode.SCREEN:this.materialData.blend_src=t.Egret3DDrive.ONE,this.materialData.blend_dest=t.Egret3DDrive.ONE_MINUS_SRC_COLOR}},enumerable:!0,configurable:!0}),i.prototype.setOutlineStyler=function(t,e){!this.outLinePass},Object.defineProperty(i.prototype,"depthTest",{get:function(){return this.materialData.depthTest},set:function(t){this.materialData.depthTest=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lightGroup",{set:function(t){this.materialData.directLightList=t.directLightList,this.materialData.sportLightList=t.spotLightList,this.materialData.pointLightList=t.pointLightList},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"diffuseTexture",{get:function(){return this.materialData.diffuseTex},set:function(t){t&&(this.materialData.diffuseTex=t,this.materialData.textureChange=!0,-1==this.materialData.textureMethodTypes.indexOf(e.DIFFUSE)&&this.materialData.textureMethodTypes.push(e.DIFFUSE))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"normalTexture",{set:function(t){t&&(this.materialData.normalTex=t,this.materialData.textureChange=!0,-1==this.materialData.textureMethodTypes.indexOf(e.NORMAL)&&(this.materialData.textureMethodTypes.push(e.NORMAL),this.materialData.passChange=!0))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"specularTexture",{set:function(t){t&&(this.materialData.specularTex=t,this.materialData.textureChange=!0,-1==this.materialData.textureMethodTypes.indexOf(e.SPECULAR)&&(this.materialData.textureMethodTypes.push(e.SPECULAR),this.materialData.passChange=!0))},enumerable:!0,configurable:!0}),i.prototype.clone=function(){var t=new i(this.materialData.clone());return t},i.prototype.activateDiffusePass=function(t,e,i,a,r){this.outLinePass&&(this.outLinePass.initShader(t,a,r),this.outLinePass.activate(t,i,e,a,r)),this.diffusePass.initShader(t,a,r),this.diffusePass.activate(t,i,e,a,r)},i.prototype.rendenDiffusePass=function(t,e,i,a,r){this.outLinePass&&this.outLinePass.draw(t,i,e,a,r),this.materialData.passChange?(this.activateDiffusePass(t,e,i,a,r),this.materialData.passChange=!1):this.diffusePass.draw(t,i,e,a,r)},i.prototype.activateShadowPass=function(t,e,i,a,r){this.shadowPass.initShader(t,a,r),this.shadowPass.activate(t,i,e,a,r)},i.prototype.rendenShadowPass=function(t,e,i,a,r){this.materialData.passChange?this.activateShadowPass(t,e,i,a,r):this.shadowPass.draw(t,i,e,a,r)},i.prototype.activateNormalPass=function(t,e,i,a,r){this.normalPass.initShader(t,a,r),this.normalPass.activate(t,i,e,a,r)},i.prototype.rendenNormalPass=function(t,e,i,a,r){},i.prototype.activateDepthPass=function(t,e,i,a,r){this.depthPass.initShader(t,a,r),this.depthPass.activate(t,i,e,a,r)},i.prototype.rendenDepthPass=function(t,e,i,a,r){},i.prototype.dispose=function(){},i}();t.MaterialBase=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,s,n,o,h){void 0===h&&(h=null),e.call(this),this.materialData.diffuseTex=i,this.materialData.maskTex=a,this.materialData.splat_0Tex=r,this.materialData.splat_1Tex=s,this.materialData.splat_2Tex=n,this.materialData.splat_3Tex=o,h?this.materialData.lightMapTex=h:this.materialData.lightMapTex=t.CheckerboardTexture.texture,this.initMatPass()}return __extends(i,e),i.prototype.initMatPass=function(){this.diffusePass=new t.TerrainMapPass(this.materialData)},i.prototype.setUVTitling=function(t,e,i){this.diffusePass.diffuseMethod.setUVTitling(t,e,i)},i}(t.MaterialBase);t.TerrainMaterial=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){void 0===i&&(i=null),void 0===a&&(a=null),e.call(this,a),i?this.diffuseTexture=i:this.diffuseTexture=t.CheckerboardTexture.texture,this.initMatPass()}return __extends(i,e),i.prototype.initMatPass=function(){this.diffuseTexture instanceof t.SkyTexture?this.diffusePass=new t.CubeDiffuseMapPass(this.materialData):this.diffusePass=new t.DiffuseMapPass(this.materialData)},i.prototype.clone=function(){var t=new i(this.diffuseTexture,this.materialData.clone());return t},i}(t.MaterialBase);t.TextureMaterial=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._vtxNum=8,this._planeNum=6,this._vertex=new Array;for(var e=0;e<this._vtxNum;++e)this._vertex.push(new t.Vector3D);this._pos=new t.Vector3D,this._plane=new Array;for(var e=0;6>e;++e)this._plane.push(new t.Plane3D);this.box=new t.CubeBoxBound(new t.Vector3D,new t.Vector3D),this.center=new t.Vector3D}return e.prototype.makeFrustum=function(t,e,i,a){var r=Math.tan(t/2*(Math.PI/180)),s=i*r,n=s*e,o=a*r,h=o*e;this._vertex[0].x=n,this._vertex[0].y=s,this._vertex[0].z=i,this._vertex[1].x=-n,this._vertex[1].y=s,this._vertex[1].z=i,this._vertex[2].x=-n,this._vertex[2].y=-s,this._vertex[2].z=i,this._vertex[3].x=n,this._vertex[3].y=-s,this._vertex[3].z=i,this._vertex[4].x=h,this._vertex[4].y=o,this._vertex[4].z=a,this._vertex[5].x=-h,this._vertex[5].y=o,this._vertex[5].z=a,this._vertex[6].x=-h,this._vertex[6].y=-o,this._vertex[6].z=a,this._vertex[7].x=h,this._vertex[7].y=-o,this._vertex[7].z=a},e.prototype.update=function(e){this.makeFrustum(e.fieldOfView,e.aspectRatio,e.near,e.far);var i=new Array,a=new t.Matrix4_4;a.copyFrom(e.modelMatrix),this._curVer=i;for(var r=0;r<this._vtxNum;++r)i.push(a.transformVector(this._vertex[r]));for(var r=0;r<i.length;++r)this.box.max.x<i[r].x&&(this.box.max.x=i[r].x),this.box.max.y<i[r].y&&(this.box.max.y=i[r].y),this.box.max.z<i[r].z&&(this.box.max.z=i[r].z),this.box.min.x>i[r].x&&(this.box.min.x=i[r].x),this.box.min.y>i[r].y&&(this.box.min.y=i[r].y),this.box.min.z>i[r].z&&(this.box.min.z=i[r].z);this.box.calculateBox(),this._plane[0].fromPoints(i[4],i[5],i[6]),this._plane[1].fromPoints(i[1],i[6],i[5]),this._plane[2].fromPoints(i[0],i[4],i[7]),this._plane[3].fromPoints(i[1],i[0],i[3]),this._plane[4].fromPoints(i[1],i[5],i[4]),this._plane[5].fromPoints(i[3],i[7],i[6]);for(var r=0;r<this._planeNum;r++)this._plane[r].normalize();var s=new t.Vector3D;s.copyFrom(i[0].subtract(i[2])),s.scaleBy(.5),s.copyFrom(i[2].add(s));var n=new t.Vector3D;n.copyFrom(i[4].subtract(i[6])),n.scaleBy(.5),n.copyFrom(i[6].add(n)),this.center.copyFrom(n.subtract(s)),this.center.scaleBy(.5),this.center.copyFrom(s.add(this.center))},e.prototype.inPoint=function(t){for(var e=0,i=0;i<this._plane.length;++i)if(e=this._plane[i].distance(t),e>0)return!1;return!0},e.prototype.inSphere=function(t,e){for(var i=0,a=0;a<this._plane.length;++a)if(i=this._plane[a].distance(t),i>e)return!1;return!0},e.prototype.inBox=function(e){for(var i=(new Array,0),a=new t.Vector3D,r=0;r<this._plane.length;++r){for(var s=e.vexData.length/3,n=0;n<e.vexData.length;n+=3)a.setTo(e.vexData[n],e.vexData[n+1],e.vexData[n+2]),a.copyFrom(e.Transform.transformVector(a)),i=this._plane[r].distance(a),i>0&&s--;if(0>=s)return!1}return!0},e}();t.Frustum=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.BoundPick=0]="BoundPick",t[t.PositionPick=1]="PositionPick",t[t.UVPick=2]="UVPick"}(t.PickType||(t.PickType={}));var e=t.PickType,i=function(i){function a(){i.call(this),this._modeMatrix3D=new t.Matrix4_4,this._transformChange=!0,this._pos=new t.Vector3D,this._rot=new t.Vector3D,this._sca=new t.Vector3D(1,1,1),this._orientation=new t.Quaternion,this._axis=new t.Vector3D,this._angle=0,this._globalPos=new t.Vector3D,this._globalRot=new t.Vector3D,this._globalSca=new t.Vector3D(1,1,1),this._globalOrientation=new t.Quaternion,this._qut=new t.Quaternion,this._active=!1,this._mat=new t.Matrix4_4,this.layer=0,this.mouseEnable=!1,this.enableCut=!0,this.parent=null,this.childs=new Array,this.animation=null,this.geometry=null,this.material=null,this.box=new t.CubeBoxBound,this.pickerData=new t.PickResult,this.isController=!0,this.isVisible=!0,this.isDisable=!1,this.pickType=e.BoundPick,this.id=++a.s_id}return __extends(a,i),Object.defineProperty(a.prototype,"position",{get:function(){return this._pos},set:function(t){this.updateTransformChange(!0),this._pos.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rot},set:function(t){this._rot.x=t.x,this._rot.y=t.y,this._rot.z=t.z,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientation",{get:function(){return this._orientation},set:function(t){this._orientation.copyFrom(t),this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scale",{get:function(){return this._sca},set:function(t){this.updateTransformChange(!0),this._sca=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"x",{get:function(){return this._pos.x},set:function(t){this.updateTransformChange(!0),this._pos.x!=t&&(this._pos.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"y",{get:function(){return this._pos.y},set:function(t){this.updateTransformChange(!0),this._pos.y!=t&&(this._pos.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"z",{get:function(){return this._pos.z},set:function(t){this.updateTransformChange(!0),this._pos.z!=t&&(this._pos.z=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationX",{get:function(){return this._rot.x},set:function(t){this.updateTransformChange(!0),this._rot.x!=t&&(this._rot.x=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationY",{get:function(){return this._rot.y},set:function(t){this.updateTransformChange(!0),this._rot.y!=t&&(this._rot.y=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationZ",{get:function(){return this._rot.z},set:function(t){this.updateTransformChange(!0),this._rot.z!=t&&(this._rot.z=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleX",{get:function(){return this._sca.x},set:function(t){this.updateTransformChange(!0),this._sca.x!=t&&(this._sca.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleY",{get:function(){return this._sca.y},set:function(t){this.updateTransformChange(!0),this._sca.y!=t&&(this._sca.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleZ",{get:function(){return this._sca.z},set:function(t){this.updateTransformChange(!0),this._sca.z!=t&&(this._sca.z=t)},enumerable:!0,configurable:!0}),a.prototype.setRotationFromAxisAngle=function(t,e){t.normalize(),this.updateTransformChange(!0),this._orientation.fromAxisAngle(t,e),this._orientation.toEulerAngles(this._rot),this._axis.copyFrom(t),this._angle=e},Object.defineProperty(a.prototype,"modelMatrix",{get:function(){return this._transformChange&&this.updateModleMatrix(),this._modeMatrix3D},enumerable:!0,configurable:!0}),a.prototype.updateModleMatrix=function(){if(null!=this.parent){var t=this.parent.globalOrientation;this._globalOrientation.multiply(t,this._orientation),this._globalOrientation.toEulerAngles(this._globalRot);var e=this.parent.globalScale;this._globalSca.copyFrom(e.multiply(this._sca)),t.rotatePoint(e.multiply(this._pos),this._globalPos),this._globalPos.copyFrom(this._globalPos.add(this.parent.globalPosition))}else this._globalOrientation.copyFrom(this._orientation),this._globalPos.copyFrom(this._pos),this._globalSca.copyFrom(this._sca),this._globalRot.copyFrom(this._rot);this._modeMatrix3D.makeTransform(this._globalPos,this._globalSca,this._globalOrientation),this.box.Transform=this._modeMatrix3D,this._transformChange=!1,this.onUpdateTransform()},a.prototype.onUpdateTransform=function(){},Object.defineProperty(a.prototype,"globalPosition",{get:function(){return this._transformChange&&this.modelMatrix,this._globalPos},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotation",{get:function(){return this._transformChange&&this.modelMatrix,this._globalRot},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScale",{get:function(){return this._transformChange&&this.modelMatrix,this._globalSca},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalOrientation",{get:function(){return this._transformChange&&this.modelMatrix,this._globalOrientation},enumerable:!0,configurable:!0}),a.prototype.addChild=function(t){return this.childs.push(t),a.renderListChange=!0,t.parent=this,t.updateTransformChange(!0),t},a.prototype.addChildAt=function(t,e){return 0>e?this.childs.splice(0,0,t):e>=this.childs.length?this.childs.push(t):this.childs.splice(e,0,t),t.parent=this,t.updateTransformChange(!0),t},a.prototype.getChildAt=function(t){return 0>t||t>=this.childs.length?null:this.childs[t]},a.prototype.getChildIndex=function(t){for(var e=0;e<this.childs.length;++e)if(this.childs[e]==t)return e;return-1},a.prototype.removeChild=function(t){for(var e=0;e<this.childs.length;++e)if(this.childs[e]==t)return t.parent=null,this.childs.splice(e,1),t;return t.updateTransformChange(!0),null},a.prototype.removeChildAt=function(t){if(0>t||t>=this.childs.length)return null;var e=this.childs[t];return e.parent=null,this.childs.splice(t,1),e.updateTransformChange(!0),e},a.prototype.setChildIndex=function(t,e){for(var i=0;i<this.childs.length;++i)if(this.childs[i]==t){if(i==e)return;if(e>i)for(var a=i;a>e;--a)this.childs[a]=this.childs[a-1];else if(i>e)for(var a=i;e>a;++a)this.childs[a]=this.childs[a+1];return void(this.childs[e]=t)}},a.prototype.swapChildren=function(t,e){for(var i=0,a=0;i<this.childs.length;++i)if(this.childs[i]==t){for(;a<this.childs.length;++a)if(this.childs[a]==e){var r=this.childs[i];this.childs[i]=this.childs[a],this.childs[a]=r;break}return}},a.prototype.swapChildrenAt=function(t,e){if(!(0>t||t>=this.childs.length||0>e||e>=this.childs.length)){var i=this.childs[t];this.childs[t]=this.childs[e],this.childs[e]=i}},a.prototype.lookAt=function(e,i,a){void 0===a&&(a=t.Vector3D.Y_AXIS)},Object.defineProperty(a.prototype,"lookAtPosition",{get:function(){return new t.Vector3D},enumerable:!0,configurable:!0}),a.prototype.updateTransformChange=function(t){this._transformChange=t;for(var e=0;e<this.childs.length;++e)this.childs[e].updateTransformChange(t)},a.prototype.update=function(t,e,i){},a.prototype.getScreenPosition=function(t){return this._mat.copyFrom(t.viewProjectionMatrix),this._mat.append(this.modelMatrix),this._mat.transformVector(this.globalPosition)},a.prototype.dispose=function(){this.parent&&this.parent.removeChild(this),this.geometry&&(this.geometry.dispose(),this.geometry=null),this.material&&(this.material.dispose(),this.material=null);for(var t=0;t<this.childs.length;t++)this.childs[t].dispose()},a.renderListChange=!0,a.s_id=0,a}(t.EventDispatcher);t.Object3D=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r){void 0===a&&(a=100),void 0===r&&(r=100),e.call(this),this.material=i,this.geometry=new t.PlaneGeometry(a,r),this.box.fillBox(this.geometry.minPos,this.geometry.maxPos)}return __extends(i,e),i.prototype.update=function(t,e,i){this._qut.fromEulerAngles(-90,0,0),this._qut.multiply(t.orientation,this._qut),this.orientation=this._qut},i}(t.Object3D);t.Billboard=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.normalMatrix=new t.Matrix4_4,this.px=0,this.py=0,this.pz=0,this.offest=new t.Vector3D,this.skyTexture=e,this.usage=new t.MethodUsageData,this.vsShader=new t.GLSL.ShaderBase(null,this.usage),this.fsShader=new t.GLSL.ShaderBase(null,this.usage),this.setShader("spheresky_vertex","spheresky_fragment"),this.skyMatrix=new t.Matrix4_4}return e.prototype.setShader=function(t,e){this.vsShader.addShader(t),this.fsShader.addShader(e),this.vsShaderSource=this.vsShader.getShaderSource(),this.fsShaderSource=this.fsShader.getShaderSource()},e.prototype.rebuild=function(e){var i=e.creatVertexShader(this.vsShaderSource),a=e.creatFragmentShader(this.fsShaderSource);this.usage.program3D=e.creatProgram(i,a),this.usage.program3D&&e.setProgram(this.usage.program3D),this.sphereGeometry=this.sphereGeometry||new t.SphereGeometry(25),this.sphereGeometry.sharedVertexBuffer||(this.sphereGeometry.sharedVertexBuffer=e.creatVertexBuffer(this.sphereGeometry.verticesData),this.sphereGeometry.numberOfVertices=this.sphereGeometry.verticesData.length/this.sphereGeometry.vertexAttLength,this.sphereGeometry.vertexSizeInBytes=this.sphereGeometry.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT,this.sphereGeometry.sharedIndexBuffer=e.creatIndexBuffer(this.sphereGeometry.indexData)),this.usage.attribute_position.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_position"),this.usage.attribute_normal.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_normal"),this.usage.attribute_uv0.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_uv0"),this.usage.uniform_ProjectionMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix"),this.usage.uniform_ModelMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ModelMatrix"),this.usage.uniform_normalMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_normalMatrix");var r;for(var s in this.usage.sampler2DList)r=this.usage.sampler2DList[s],"sky_texture"==r.varName&&(r.texture=this.skyTexture),r.uniformIndex=e.getUniformLocation(this.usage.program3D,r.varName)},e.prototype.draw=function(e,i){this.usage.program3D||this.rebuild(e),e.setProgram(this.usage.program3D),e.gl.enable(t.Egret3DDrive.CULL_FACE),e.gl.cullFace(t.Egret3DDrive.FRONT),e.gl.enable(t.Egret3DDrive.BLEND),e.gl.blendFunc(t.Egret3DDrive.ONE,t.Egret3DDrive.ZERO),e.bindVertexBuffer(this.sphereGeometry.sharedVertexBuffer),e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,this.sphereGeometry.vertexSizeInBytes,0),e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,!1,this.sphereGeometry.vertexSizeInBytes,52),this.skyMatrix.identity(),this.skyMatrix.appendTranslation(i.x,i.y,i.z),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,i.viewProjectionMatrix.rawData),e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,!1,this.skyMatrix.rawData);var a;for(var r in this.usage.sampler2DList)a=this.usage.sampler2DList[r],a.texture.upload(e),e.setTexture2DAt(a.activeTextureIndex,a.uniformIndex,a.index,a.texture.texture);e.drawElement(t.DrawMode.TRIANGLES,this.sphereGeometry.sharedIndexBuffer,0,this.sphereGeometry.numItems)},e}();t.SphereSky=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.px=0,this.py=0,this.pz=0,this.offest=new t.Vector3D,this.skyTexture=e,this.usage=new t.MethodUsageData,this.vsShader=new t.GLSL.ShaderBase(null,this.usage),this.fsShader=new t.GLSL.ShaderBase(null,this.usage),this.setShader("sky_vertex","sky_fragment"),this.skyMatrix=new t.Matrix4_4,this.modelMatrix=new t.Matrix4_4}return e.prototype.setShader=function(t,e){this.vsShader.addShader(t),this.fsShader.addShader(e),this.vsShaderSource=this.vsShader.getShaderSource(),this.fsShaderSource=this.fsShader.getShaderSource()},e.prototype.rebuild=function(e){var i=e.creatVertexShader(this.vsShaderSource),a=e.creatFragmentShader(this.fsShaderSource);this.usage.program3D=e.creatProgram(i,a),this.usage.program3D&&e.setProgram(this.usage.program3D),this.cubeGeometry=this.cubeGeometry||new t.CubeGeometry,this.cubeGeometry.sharedVertexBuffer||(this.cubeGeometry.sharedVertexBuffer=e.creatVertexBuffer(this.cubeGeometry.verticesData),this.cubeGeometry.numberOfVertices=this.cubeGeometry.verticesData.length/this.cubeGeometry.vertexAttLength,this.cubeGeometry.vertexSizeInBytes=this.cubeGeometry.positionSize*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+3*Float32Array.BYTES_PER_ELEMENT+4*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT+2*Float32Array.BYTES_PER_ELEMENT,this.cubeGeometry.sharedIndexBuffer=e.creatIndexBuffer(this.cubeGeometry.indexData)),this.usage.attribute_position.uniformIndex=e.getShaderAttribLocation(this.usage.program3D,"attribute_position"),this.usage.uniform_ProjectionMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix"),this.usage.uniform_ModelMatrix.uniformIndex=e.getUniformLocation(this.usage.program3D,"uniform_ModelMatrix");var r;for(var s in this.usage.sampler3DList)r=this.usage.sampler3DList[s],r.uniformIndex=e.getUniformLocation(this.usage.program3D,r.varName),"sky_texture"==r.varName&&(r.texture=this.skyTexture)},e.prototype.draw=function(e,i){this.usage.program3D||this.rebuild(e),e.setProgram(this.usage.program3D),e.gl.enable(t.Egret3DDrive.CULL_FACE),e.gl.cullFace(t.Egret3DDrive.FRONT),e.bindVertexBuffer(this.cubeGeometry.sharedVertexBuffer),e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,this.cubeGeometry.vertexSizeInBytes,0),this.skyMatrix.identity(),this.skyMatrix.appendTranslation(i.x,i.y,i.z),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,i.viewProjectionMatrix.rawData),e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,!1,this.skyMatrix.rawData);
var a;for(var r in this.usage.sampler3DList)a=this.usage.sampler3DList[r],a.texture.upload(e),e.setCubeTextureAt(a.activeTextureIndex,a.uniformIndex,a.index,a.texture.cubeTexture);e.drawElement(t.DrawMode.TRIANGLES,this.cubeGeometry.sharedIndexBuffer,0,this.cubeGeometry.numItems)},e}();t.Sky=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e}(t.Object3D);t.Entity=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.perspective=0]="perspective",t[t.orthogonal=1]="orthogonal",t[t.VR=2]="VR"}(t.CameraType||(t.CameraType={}));var e=t.CameraType;!function(t){t[t.left=0]="left",t[t.right=1]="right"}(t.VRType||(t.VRType={}));var i=t.VRType,a=function(a){function r(i){void 0===i&&(i=e.perspective),a.call(this),this.projectMatrix=new t.Matrix4_4,this.frustum=new t.Frustum,this._viewPort=new t.Rectangle,this._scissorRect=new t.Rectangle,this._aspectRatio=1,this._fovY=45,this._near=1,this._far=1e4,this.temp=new t.Matrix4_4,this._lookAtPosition=new t.Vector3D,this._up=new t.Vector3D(0,1,0),this._cameraType=0,this._cameraMatrixChange=!1,this._viewMatrix=new t.Matrix4_4,this._tempQuat=new t.Quaternion,this.cameraType=i}return __extends(r,a),Object.defineProperty(r.prototype,"cameraType",{set:function(i){switch(this._cameraType=i,i){case e.orthogonal:this.cameraMatrix=this.modelMatrix,this.updataOrth();break;case e.perspective:this.cameraMatrix=this.modelMatrix,this.projectMatrix.perspective(this._fovY,this._aspectRatio,this._near,this._far);break;case e.VR:this.cameraMatrix=this.modelMatrix,this.projectMatrix.perspective(this._fovY,1,this._near,this._far),this.eyeMatrix=this.eyeMatrix||new t.EyesMatrix}},enumerable:!0,configurable:!0}),r.prototype.tap=function(t,a){void 0===a&&(a=null),t==e.VR?(this.eyeMatrix.updte(this.modelMatrix),a==i.left?this.cameraMatrix=this.eyeMatrix.leftEyeMatrix:a==i.right&&(this.cameraMatrix=this.eyeMatrix.rightEyeMatrix)):this.cameraMatrix=this.modelMatrix},Object.defineProperty(r.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){this._aspectRatio!=t&&(this._aspectRatio=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fieldOfView",{get:function(){return this._fovY},set:function(t){this._fovY!=t&&(this._fovY=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"near",{get:function(){return this._near},set:function(t){this._near!=t&&(this._near=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"far",{get:function(){return this._far},set:function(t){this._far!=t&&(this._far=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"viewProjectionMatrix",{get:function(){return this.cameraMatrix=this.modelMatrix,this.temp.copyFrom(this.cameraMatrix),this.temp.invert(),this.temp.append(this.projectMatrix),this.temp},enumerable:!0,configurable:!0}),r.prototype.updateScissorRect=function(t,e,i,a){this._scissorRect.x=t,this._scissorRect.y=e,this._scissorRect.width=i,this._scissorRect.height=a},r.prototype.updateViewport=function(t,e,i,a){this._viewPort.x=t,this._viewPort.y=e,this._viewPort.width=i,this._viewPort.height=a},r.prototype.lookAt=function(e,i,a){void 0===a&&(a=t.Vector3D.Y_AXIS),this.position=e,this._lookAtPosition.copyFrom(i),this._up.copyFrom(a),this._viewMatrix.lookAt(this._pos,this._lookAtPosition,this._up),this._viewMatrix.invert();var r=this._viewMatrix.decompose(t.Orientation3D.QUATERNION);this._tempQuat.x=r[1].x,this._tempQuat.y=r[1].y,this._tempQuat.z=r[1].z,this._tempQuat.w=r[1].w,this.orientation=this._tempQuat},r.prototype.onUpdateTransform=function(){this._viewMatrix.copyFrom(this._modeMatrix3D),this._viewMatrix.invert()},Object.defineProperty(r.prototype,"viewMatrix",{get:function(){return this._viewMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},enumerable:!0,configurable:!0}),r.prototype.updataOrth=function(){var t,e,i,a,r=800,s=new Float32Array(16),n=.5*r,o=n*this._aspectRatio;if(0==this._scissorRect.x&&0==this._scissorRect.y&&this._scissorRect.width==this._viewPort.width&&this._scissorRect.height==this._viewPort.height)t=-o,e=o,i=-n,a=n,s[0]=2/(r*this._aspectRatio),s[5]=2/r,s[10]=1/(this._far-this._near),s[14]=this._near/(this._near-this._far),s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=0,s[15]=1;else{var h=o*(this._viewPort.width/this._scissorRect.width),u=n*(this._viewPort.height/this._scissorRect.height),l=o*(2*this._scissorRect.x-this._viewPort.width)/this._scissorRect.width+o,c=-n*(2*this._scissorRect.y-this._viewPort.height)/this._scissorRect.height-n;t=l-h,e=l+h,i=c-u,a=c+u,s[0]=2/(e-t),s[5]=-2/(i-a),s[10]=1/(this._far-this._near),s[12]=(e+t)/(e-t),s[13]=(a+i)/(a-i),s[14]=this._near/(this.near-this.far),s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=0,s[15]=1}this.projectMatrix.copyRawDataFrom(s)},r.prototype.isVisibleToCamera=function(t){return this.frustum.inBox(t.box)?!0:!1},r}(t.Entity);t.Camera3D=a}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._lightType=-1,this._ambient=new t.Vector3D(1,1,1),this._diffuse=new t.Vector3D(1,1,1),this._halfColor=new t.Vector3D(1,1,1),this._specular=new t.Vector3D(1,1,1),this._halfVector=new t.Vector3D(1,1,1),this._intensity=1,this._halfIntensity=.5,this._spotExponent=1.1,this._spotCutoff=.7,this._spotCosCutoff=.1,this._constantAttenuation=.1,this._linearAttenuation=.1,this._quadraticAttenuation=.1,this._lightIndex=-1,this.len=25,this._change=!0}return __extends(i,e),Object.defineProperty(i.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!=t&&(this._intensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"halfIntensity",{get:function(){return this._halfIntensity},set:function(t){this._halfIntensity!=t&&(this._halfIntensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"ambient",{get:function(){return 0},set:function(t){this._ambient.w=(t>>24&255)/255,this._ambient.x=(t>>16&255)/255,this._ambient.y=(t>>8&255)/255,this._ambient.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"diffuse",{get:function(){return 0},set:function(t){this._diffuse.w=(t>>24&255)/255,this._diffuse.x=(t>>16&255)/255,this._diffuse.y=(t>>8&255)/255,this._diffuse.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"specular",{get:function(){return 0},set:function(t){this._specular.w=(t>>24&255)/255,this._specular.x=(t>>16&255)/255,this._specular.y=(t>>8&255)/255,this._specular.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),i.prototype.init=function(){},i.prototype.updateLightData=function(t,e){},i}(t.Object3D);t.LightBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e){t.call(this),e.normalize(),this._lightType=0,this._rot.x=e.x,this._rot.y=e.y,this._rot.z=e.z}return __extends(e,t),Object.defineProperty(e.prototype,"halfColor",{set:function(t){this._halfColor.w=(t>>24&255)/255,this._halfColor.x=(t>>16&255)/255,this._halfColor.y=(t>>8&255)/255,this._halfColor.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),e.prototype.updateLightData=function(t,i){i[t*e.stride+0]=this._rot.x,i[t*e.stride+1]=this._rot.y,i[t*e.stride+2]=this._rot.z,i[t*e.stride+3]=this._diffuse.x,i[t*e.stride+4]=this._diffuse.y,i[t*e.stride+5]=this._diffuse.z,i[t*e.stride+6]=this._halfColor.x,i[t*e.stride+7]=this._halfColor.y,i[t*e.stride+8]=this._halfColor.z,i[t*e.stride+9]=this._intensity,i[t*e.stride+10]=this._halfIntensity},e.stride=11,e}(t.LightBase);t.DirectLight=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e){t.call(this),this._lightType=1,this.diffuse=e}return __extends(e,t),e.prototype.updateLightData=function(t,i){i[t*e.stride]=this.x,i[t*e.stride+1]=this.y,i[t*e.stride+2]=this.z,i[t*e.stride+3]=this._diffuse.x,i[t*e.stride+4]=this._diffuse.y,i[t*e.stride+5]=this._diffuse.z,i[t*e.stride+6]=this._intensity},e.stride=7,e}(t.LightBase);t.PointLight=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e){t.call(this),this._diffuse=e,this._lightType=2}return __extends(e,t),Object.defineProperty(e.prototype,"spotCosCutoff",{get:function(){return this._spotCosCutoff},set:function(t){this._spotCosCutoff=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"spotExponent",{get:function(){return this._spotExponent},set:function(t){this._spotExponent=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"constantAttenuation",{get:function(){return this._constantAttenuation},set:function(t){this._constantAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"linearAttenuation",{get:function(){return this._linearAttenuation},set:function(t){this._linearAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"quadraticAttenuation",{get:function(){return this._quadraticAttenuation},set:function(t){this._quadraticAttenuation=t},enumerable:!0,configurable:!0}),e.prototype.updateLightData=function(t,i){i[t*e.stride]=this.x,i[t*e.stride+1]=this.y,i[t*e.stride+2]=this.z,i[t*e.stride+3]=this._rot.x,i[t*e.stride+4]=this._rot.y,i[t*e.stride+5]=this._rot.z,i[t*e.stride+6]=this._diffuse.x,i[t*e.stride+7]=this._diffuse.y,i[t*e.stride+8]=this._diffuse.z,i[t*e.stride+9]=this._spotExponent,i[t*e.stride+10]=this._spotCosCutoff,i[t*e.stride+11]=this._constantAttenuation,i[t*e.stride+12]=this._linearAttenuation,i[t*e.stride+13]=this._quadraticAttenuation},e.stride=14,e}(t.LightBase);t.SpotLight=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.lightNum=0,this.directLightList=new Array,this.spotLightList=new Array,this.pointLightList=new Array}return t.prototype.addDirectLight=function(t){this.directLightList.push(t),this.lightNum++},t.prototype.addSpotLight=function(t){this.spotLightList.push(t),this.lightNum++},t.prototype.addPointLight=function(t){this.pointLightList.push(t),this.lightNum++},t}();t.LightGroup=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this._renderIndex=0,this._numEntity=0}return t.prototype.draw=function(t,e,i,a,r,s){},t}();t.RenderBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.draw=function(t,e,i,a,r,s){for(this._renderList=a.renderList,this._numEntity=this._renderList.length,this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++)this._renderList[this._renderIndex].update(r,t,e),this._renderList[this._renderIndex].isVisible&&(this._renderList[this._renderIndex].tag&&this._renderList[this._renderIndex].tag.clearDepth&&this._renderList[this._renderIndex].tag.cleanState&&(this._renderList[this._renderIndex].tag.cleanState=!1,i.clearDepth(1)),null!=this._renderList[this._renderIndex].material&&0!=this._renderList[this._renderIndex].material.alpha&&this._renderList[this._renderIndex].material.rendenDiffusePass(i,r,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation))},e}(t.RenderBase);t.DefaultRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.update=function(t,e,i,a,r,s){for(this._renderList=a.renderList,this._numEntity=this._renderList.length,this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++)this._renderList[this._renderIndex].update(r,t,e),this._renderList[this._renderIndex].isVisible&&null!=this._renderList[this._renderIndex].material},e}(t.RenderBase);t.PositionRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.draw=function(t,e,i,a,r,s){for(this._renderList=a.renderList,this._numEntity=this._renderList.length,this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++)this._renderList[this._renderIndex].update(r,t,e),this._renderList[this._renderIndex].isVisible&&null!=this._renderList[this._renderIndex].material&&this._renderList[this._renderIndex].material.rendenNormalPass(i,r,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation)},e}(t.RenderBase);t.NormalRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.draw=function(t,e,i,a,r,s){for(this._renderList=a.renderList,this._numEntity=this._renderList.length,this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++)this._renderList[this._renderIndex].update(r,t,e),this._renderList[this._renderIndex].isVisible&&null!=this._renderList[this._renderIndex].material&&this._renderList[this._renderIndex].material.rendenDepthPass(i,r,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation)},e}(t.RenderBase);t.DepthRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.shadowTexture_width=1024,this.shadowTexture_height=1024,this.cameraTarget=new t.Vector3D,this.cameraPos=new t.Vector3D,this.distance=0,i.shadowCamera3D=new t.Camera3D(t.CameraType.orthogonal),i.frameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.shadowFrameBufrfer,t.Egret3DDrive.context3D,this.shadowTexture_width,this.shadowTexture_height,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA)}return __extends(i,e),i.prototype.draw=function(e,a,r,s,n,o){if(i.castShadowLight)for(this.offsetPos(new t.Vector3D),this._renderList=s.renderList,this._numEntity=this._renderList.length,this._renderIndex=0;this._renderIndex<this._numEntity;this._renderIndex++)if(this._renderList[this._renderIndex].material.castShadow){if(this._renderList[this._renderIndex].update(n,e,a),!this._renderList[this._renderIndex].isVisible)continue;this._renderList[this._renderIndex].material.rendenShadowPass(r,i.shadowCamera3D,this._renderList[this._renderIndex].modelMatrix,this._renderList[this._renderIndex].geometry,this._renderList[this._renderIndex].animation)}},i.prototype.offsetPos=function(t){this.cameraPos.x=i.castShadowLight.rotationX,this.cameraPos.y=i.castShadowLight.rotationY,this.cameraPos.z=i.castShadowLight.rotationZ,this.cameraPos.normalize(),this.cameraPos.scaleBy(500),this.cameraPos.x=this.cameraPos.x+t.x,this.cameraPos.y=this.cameraPos.y+t.y,this.cameraPos.z=this.cameraPos.z+t.z,i.shadowCamera3D.lookAt(this.cameraPos,t)},i}(t.RenderBase);t.ShadowRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.defaultRender=0]="defaultRender",t[t.positionRender=1]="positionRender",t[t.normalRender=2]="normalRender",t[t.specularRender=3]="specularRender",t[t.shadowRender=4]="shadowRender"}(t.RenderType||(t.RenderType={}));var e=t.RenderType,i=function(){function i(){}return i.getRender=function(t){return this.renders[t]?this.renders[t]:this.creatSystemRender(t)},i.creatSystemRender=function(i){var a;switch(i){case e.defaultRender:a=new t.DefaultRender;break;case e.positionRender:a=new t.PositionRender;break;case e.normalRender:a=new t.NormalRender;break;case e.specularRender:break;case e.shadowRender:a=new t.ShadowRender}return this.renders[i]=a,a},i.renders=new Object,i}();t.RenderManager=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this._num=0,this._objDict={},this.renderList=new Array,this.mousePickList=new Array,this._nodes=new Array,this._rootNode=t}return t.prototype.update=function(t){this.renderList=this._nodes,this.renderList.length=0,t.frustum.update(t)},t.prototype.findRenderObject=function(t){for(var e=0;e<this.renderList.length;++e)if(this.renderList[e]===t)return e;return-1},t}();t.CollectBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.objects=new Array,this.alphaObjects=new Array}return t}();t.Layer=e;var i=function(){function t(){this.layers=new Array,this.clearDepth=!1,this.cleanState=!0}return t}();t.Tag=i;var a=function(a){function r(t){a.call(this,t),this._tags=new Array,this._layers=new Array,this._tagsName=new Array,this.addTag("default"),this.addTag("terrain"),this.addTag("terrain_texture"),this.addTag("shadow"),this.addTag("character"),this.addTag("modle_effect"),this.addTag("particle"),this.addTag("transparent"),this.addTag("wireframe",!0);this.addLayer("layer_0"),this.addLayer("layer_1"),this.addLayer("layer_2"),this.addLayer("layer_3"),this.addLayer("layer_4")}return __extends(r,a),Object.defineProperty(r.prototype,"tags",{get:function(){return this._tags},enumerable:!0,configurable:!0}),r.prototype.setTags=function(t,e){var i=this._tagsName.indexOf(t);if(-1!=i){var a=this._tags[i];this.removeTag(t),this._tagsName.splice(e,0,t),this._tags.splice(e,0,a)}else this.insertTag(t,e)},r.prototype.setTagsItem=function(t,e){this.removeLayer(t),this.insetLayer(t,e)},r.prototype.getTagLayer=function(t,e){void 0===t&&(t="default"),void 0===e&&(e="layer_0");var i=this._tagsName.indexOf(t),a=this._layers.indexOf(e);return i<<24|a},r.prototype.getTag=function(t){void 0===t&&(t="default");var e=this._tagsName.indexOf(t);return-1!=e?this.tags[e]:null},r.prototype.addTag=function(t,a){if(void 0===a&&(a=!1),-1==this._tagsName.indexOf(t)){this._tagsName.push(t);var r=new i;r.clearDepth=a,this._tags.push(r);for(var s=0;s<this._layers.length;++s){var n=new e;r.layers.push(n)}}},r.prototype.insertTag=function(t,a){if(-1==this._tagsName.indexOf(t)){this._tagsName.splice(a,0,t);var r=new i;this._tags.splice(a,0,r);for(var s=0;s<this._layers.length;++s){var n=new e;r.layers.push(n)}}},r.prototype.removeTag=function(t){var e=this._tagsName.indexOf(t);-1!=e&&(this._tagsName.splice(e,1),this._tags.splice(e,1))},r.prototype.addLayer=function(t){if(-1==this._layers.indexOf(t)){this._layers.push(t);for(var i=0;i<this._tags.length;++i){var a=new e;this._tags[i].layers.push(a)}}},r.prototype.insetLayer=function(t,i){if(-1==this._layers.indexOf(t)){this._layers.splice(i,0,t);for(var a=0;a<this._tags.length;++a){var r=new e;this._tags[a].layers.splice(i,0,r)}}},r.prototype.removeLayer=function(t){var e=this._layers.indexOf(t);if(-1!=e){this._layers.splice(e,1);for(var i=0;i<this._tags.length;++i)this._tags[i].layers.splice(e,1)}},r.prototype.applyRender=function(t,e){this.addRenderList(t,e);for(var i=0;i<t.childs.length;i++)this.applyRender(t.childs[i],e)},r.prototype.addRenderList=function(t,e){if(t.material&&(!t.enableCut||e.isVisibleToCamera(t))){t.mouseEnable&&this.mousePickList.push(t);var i=this.findLayer(t);this.findTag(t);null!=t.material&&t.material.materialData.alphaBlending?i.alphaObjects.push(t):i.objects.push(t)}},r.prototype.update=function(t){var e=this;a.prototype.update.call(this,t),this.renderList.length=0,this.mousePickList.length=0,this.clearLayerList(),this.applyRender(this._rootNode,t);for(var i=0;i<this._tags.length;++i){this._tags[i].clearDepth=!0;for(var r=0;r<this._tags[i].layers.length;++r){for(var s=0;s<this._tags[i].layers[r].objects.length;++s)this.renderList.push(this._tags[i].layers[r].objects[s]);this._tags[i].layers[r].alphaObjects.sort(function(i,a){return e.sort(i,a,t)});for(var s=0;s<this._tags[i].layers[r].alphaObjects.length;++s)this.renderList.push(this._tags[i].layers[r].alphaObjects[s])}}},r.prototype.findLayer=function(t){var e=t.layer>>24,i=16777215&t.layer;return e<this._tags.length&&e>=0&&i<this._tags[e].layers.length&&i>=0?this._tags[e].layers[i]:this._tags[0].layers[0]},r.prototype.findTag=function(t){var e=t.layer>>24;return e<this._tags.length&&e>=0?this._tags[e]:this._tags[0]},r.prototype.clearLayerList=function(){for(var t=0;t<this._tags.length;++t)for(var e=0;e<this._tags[t].layers.length;++e)this._tags[t].layers[e].objects.length=0,this._tags[t].layers[e].alphaObjects.length=0},r.prototype.sort=function(e,i,a){var r=t.Vector3D.distance(e.globalPosition,a.position),s=t.Vector3D.distance(i.globalPosition,a.position);return r>s?-1:s>r?1:0},r}(t.CollectBase);t.EntityCollect=a}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.collect=new t.EntityCollect(this)}return __extends(i,e),i}(t.Object3D);t.Scene3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.shadowFrameBufrfer=0]="shadowFrameBufrfer",t[t.defaultFrameBuffer=1]="defaultFrameBuffer",t[t.positionFrameBuffer=2]="positionFrameBuffer",t[t.normalFrameBuffer=3]="normalFrameBuffer",t[t.specularFrameBuffer=4]="specularFrameBuffer",t[t.leftEyeFrameBuffer=5]="leftEyeFrameBuffer",t[t.rightEyeFrameBuffer=6]="rightEyeFrameBuffer",t[t.nextFrameBuffer=7]="nextFrameBuffer"}(t.FrameBufferType||(t.FrameBufferType={}));t.FrameBufferType;!function(t){t[t.FLOAT_RGB=0]="FLOAT_RGB",t[t.FLOAT_RGBA=1]="FLOAT_RGBA",t[t.UNSIGNED_BYTE_RGB=2]="UNSIGNED_BYTE_RGB",t[t.UNSIGNED_BYTE_RGBA=3]="UNSIGNED_BYTE_RGBA"}(t.FrameBufferFormat||(t.FrameBufferFormat={}));var e=(t.FrameBufferFormat,function(){function e(){this.shadowFrameBufrfer=new t.FrameBuffer,this.defaultFrameBuffer=new t.FrameBuffer,this.positionFrameBuffer=new t.FrameBuffer,this.normalFrameBuffer=new t.FrameBuffer,this.specularFrameBuffer=new t.FrameBuffer,this.leftEyeFrameBuffer=new t.FrameBuffer,this.rightFrameBuffer=new t.FrameBuffer,this.nextFrameBuffer=new t.FrameBuffer,e.instance&&new Error("can't new RttManager instance!")}return e.creatFrameBuffer=function(i,a,r,s,n){var o=new t.FrameBuffer;return o.frameBufferName=i,o.width=r,o.height=s,o.texture=new t.RenderTexture(a.createFramebuffer(r,s,n)),e.instance[i]=o,e.instance[i]},e.prototype.drawFrameBuffersToTexture=function(t,e,i,a,r,s){},e.drawToTexture=function(t,e,i,a,r,s,n,o){a.viewPort(o.x,o.y,o.width,o.height),a.setRenderToTexture(i,!0,0),r.draw(t,e,a,s,n,o),a.setRenderToBackBuffer()},e.drawToTextureStart=function(t,e,i){e.viewPort(i.x,i.y,i.width,i.height),e.setRenderToTexture(t,!0,0)},e.drawToTextureEnd=function(t){t.setRenderToBackBuffer()},e.instance=new e,e}());t.RttManager=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.vertexAttLength=17,this.source_indexData=new Array,this.source_vertexData=new Array,this.source_vertexColorData=new Array,this.source_normalData=new Array,this.source_tangtData=new Array,this.source_uvData=new Array,this.source_uv2Data=new Array,this.source_faceData=new Array,this.source_skinData=new Array,this.vertexIndex=0,this.indices=new Array,this.vertices=new Array,this.normals=new Array,this.tangts=new Array,this.verticesColor=new Array,this.uvs=new Array,this.uv2s=new Array,this.skinMesh=new Array,this.faceNormals=new Array,this.faceWeights=new Array}return e.build=function(i){if(null==i.source_faceData||i.source_faceData.length<=0||null==i.source_vertexData||i.source_vertexData.length<=0)return null;var a=new e;a.indices=[],a.vertexDatas=[],a.vertexAttLength=i.vertexAttLength;for(var r=null,s=null,n=new t.Vector3D(1,1,1),o=new t.Vector3D(1,1,1,1),h=new t.UV(1,0),u=new t.UV(1,0),l=0;l<i.source_faceData.length;l++){r=i.source_faceData[l],a.indices.push(3*l+0,3*l+2,3*l+1);for(var c=0;3>c;c++)s=i.source_vertexData[r.vertexIndices[c]-1],r.normalIndices&&i.source_normalData&&i.source_normalData.length>0&&(n=i.source_normalData[r.normalIndices[c]-1]),r.colorIndices&&i.source_vertexColorData&&i.source_vertexColorData.length>0&&(o=i.source_vertexColorData[r.colorIndices[c]-1]),r.uvIndices&&i.source_uvData&&i.source_uvData.length>0&&(h=i.source_uvData[r.uvIndices[c]-1]),r.uv2Indices&&i.source_uv2Data&&i.source_uv2Data.length>0&&(u=i.source_uv2Data[r.uv2Indices[c]-1]),a.vertexDatas.push(s.x,s.y,s.z,n.x,n.y,n.z,0,0,0,o.r,o.g,o.b,o.a,h.u,h.v,u.u,u.v),null!=i.source_skinData&&i.source_skinData.length>0&&a.vertexDatas.push(i.source_skinData[8*(r.vertexIndices[c]-1)+0],i.source_skinData[8*(r.vertexIndices[c]-1)+2],i.source_skinData[8*(r.vertexIndices[c]-1)+4],i.source_skinData[8*(r.vertexIndices[c]-1)+6],i.source_skinData[8*(r.vertexIndices[c]-1)+1],i.source_skinData[8*(r.vertexIndices[c]-1)+3],i.source_skinData[8*(r.vertexIndices[c]-1)+5],i.source_skinData[8*(r.vertexIndices[c]-1)+7])}return e.buildFaceTangents(a),a},e.translateMaterialGroup=function(t){var i,a,r=t.source_faceData,s=r.length,n=new e;n.vertexAttLength=t.vertexAttLength;for(var o,h=0;s>h;++h)for(i=r[h],a=i.indexIds.length-1,o=1;a>o;++o)this.translateVertexData(i,o,t,n),this.translateVertexData(i,0,t,n),this.translateVertexData(i,o+1,t,n);return n.vertices.length>0&&(n.vertLen=n.vertices.length/3*t.vertexAttLength,n.vertexDatas=new Array(n.vertLen),this.updateFaceTangents(n),this.combinGeomtryData(n)),n},e.translateVertexData=function(t,e,i,a){var r,s,n,o,h;if(a.indices[t.indexIds[e]])r=a.indices[t.indexIds[e]]-1;else if(r=a.vertexIndex,a.indices[t.indexIds[e]]=++a.vertexIndex,s=i.source_vertexData[t.vertexIndices[e]-1],a.vertices.push(s.x,s.y,s.z),null!=i.source_vertexColorData&&i.source_vertexColorData.length>0&&(n=i.source_vertexColorData[t.vertexIndices[e]-1],a.verticesColor.push(n.r,n.g,n.b,n.a)),null!=i.source_skinData&&i.source_skinData.length>0&&a.skinMesh.push(i.source_skinData[8*(t.vertexIndices[e]-1)+0],i.source_skinData[8*(t.vertexIndices[e]-1)+2],i.source_skinData[8*(t.vertexIndices[e]-1)+4],i.source_skinData[8*(t.vertexIndices[e]-1)+6],i.source_skinData[8*(t.vertexIndices[e]-1)+1],i.source_skinData[8*(t.vertexIndices[e]-1)+3],i.source_skinData[8*(t.vertexIndices[e]-1)+5],i.source_skinData[8*(t.vertexIndices[e]-1)+7]),t.normalIndices.length>0&&(o=i.source_normalData[t.normalIndices[e]-1],a.normals.push(o.x,o.y,o.z)),t.uvIndices.length>0)try{h=i.source_uvData[t.uvIndices[e]-1],a.uvs.push(h.u,h.v),i.source_uv2Data.length>0&&(h=i.source_uv2Data[t.uv2Indices[e]-1],a.uv2s.push(h.u,h.v))}catch(u){switch(e){case 0:a.uvs.push(0,1);break;case 1:a.uvs.push(.5,0);break;case 2:a.uvs.push(1,1)}}a.indices.push(r)},e.combinGeomtryData=function(t,e){void 0===e&&(e=!0);for(var i=0,a=0,r=0,s=0,n=0,o=0,h=0,u=t.vertexDatas;i<t.vertLen;)u[i++]=t.vertices[a++],u[i++]=t.vertices[a++],u[i++]=t.vertices[a++],t.normals&&t.normals.length?(u[i++]=t.normals[r++],u[i++]=t.normals[r++],u[i++]=t.normals[r++]):(u[i++]=0,u[i++]=0,u[i++]=0),t.tangts?(i++,i++,i++):(u[i++]=0,u[i++]=0,u[i++]=0),t.source_vertexColorData&&t.source_vertexColorData.length?(u[i++]=t.verticesColor[o++],u[i++]=t.verticesColor[o++],u[i++]=t.verticesColor[o++],u[i++]=t.verticesColor[o++]):(u[i++]=1,u[i++]=1,u[i++]=1,u[i++]=1),t.uvs&&t.uvs.length?(u[i++]=t.uvs[s++],u[i++]=t.uvs[s++],t.uv2s&&t.uv2s.length?(u[i++]=t.uv2s[n++],u[i++]=t.uv2s[n++]):(u[i++]=t.uvs[n++],u[i++]=t.uvs[n++])):(u[i++]=0,u[i++]=0,u[i++]=0,u[i++]=0),t.skinMesh&&t.skinMesh.length&&(u[i++]=t.skinMesh[h++],u[i++]=t.skinMesh[h++],u[i++]=t.skinMesh[h++],u[i++]=t.skinMesh[h++],u[i++]=t.skinMesh[h++],u[i++]=t.skinMesh[h++],u[i++]=t.skinMesh[h++],u[i++]=t.skinMesh[h++])},e.updateFaceNormals=function(t){for(var e,i,a,r,s,n,o,h,u,l,c,d,f,p,g,m,_,D,y,v,x=0,w=0,b=0,T=t.indices.length,A=t.vertexDatas,E=17,L=3;T>x;){e=L+t.indices[x++]*E,i=A[e],s=A[e+1],h=A[e+2],e=L+t.indices[x++]*E,a=A[e],n=A[e+1],u=A[e+2],e=L+t.indices[x++]*E,r=A[e],o=A[e+1],l=A[e+2],c=r-i,d=o-s,f=l-h,p=a-i,g=n-s,m=u-h,_=f*g-d*m,D=c*m-f*p,y=d*p-c*g,v=Math.sqrt(_*_+D*D+y*y);var S=1e4*v;1>S&&(S=1),t.faceWeights[b++]=S,v=1/v,t.faceNormals[w++]=_*v,t.faceNormals[w++]=D*v,t.faceNormals[w++]=y*v}},e.updateVertexNormals=function(t){this.updateFaceNormals(t);for(var e,i,a=0,r=1,s=2,n=(t.vertexDatas.length,17),o=3,h=0,u=0,l=t.indices.length;l>h;)i=t.faceWeights[u++],e=o+t.indices[h++]*n,t.vertexDatas[e]+=t.faceNormals[a]*i,t.vertexDatas[e++]+=t.faceNormals[r]*i,t.vertexDatas[e++]+=t.faceNormals[s]*i,e=o+t.indices[h++]*n,t.vertexDatas[e]+=t.faceNormals[a]*i,t.vertexDatas[e++]+=t.faceNormals[r]*i,t.vertexDatas[e++]+=t.faceNormals[s]*i,e=o+t.indices[h++]*n,t.vertexDatas[e]+=t.faceNormals[a]*i,t.vertexDatas[e++]+=t.faceNormals[r]*i,t.vertexDatas[e++]+=t.faceNormals[s]*i,a+=3,r+=3,s+=3},e.buildFaceTangents=function(t){for(var i=0;i<t.indices.length;i++)t.vertices.push(t.vertexDatas[i*t.vertexAttLength],t.vertexDatas[i*t.vertexAttLength+1],t.vertexDatas[i*t.vertexAttLength+2]),t.uvs.push(t.vertexDatas[i*t.vertexAttLength+13],t.vertexDatas[i*t.vertexAttLength+14]);e.updateFaceTangents(t)},e.updateFaceTangents=function(t){for(var e,i,a,r,s,n,o,h,u,l,c,d,f,p,g,m,_,D,y,v,x,w=0,b=t.indices.length,T=t.vertices,A=t.uvs;b>w;)e=t.indices[w],i=t.indices[w+1],a=t.indices[w+2],r=2*e,n=A[r+1],r=2*i,o=A[r+1]-n,r=2*a,h=A[r+1]-n,s=3*e,l=T[s],c=T[s+1],d=T[s+2],s=3*i,f=T[s]-l,p=T[s+1]-c,g=T[s+2]-d,s=3*a,m=T[s]-l,_=T[s+1]-c,D=T[s+2]-d,y=h*f-o*m,v=h*p-o*_,x=h*g-o*D,u=1/Math.sqrt(y*y+v*v+x*x),t.tangts[w++]=u*y,t.tangts[w++]=u*v,t.tangts[w++]=u*x;var w,E=t.vertexDatas.length,L=t.vertexAttLength,S=6,M=t.vertexDatas;for(w=S;E>w;)M[w]=0,M[w+1]=0,M[w+2]=0,w+=L;var P,R,C=b,F=0,I=1,U=2;for(w=0;C>w;)R=1,P=S+t.indices[w++]*L,M[P++]+=-t.tangts[F]*R,M[P++]+=t.tangts[I]*R,M[P]+=t.tangts[U]*R,P=S+t.indices[w++]*L,M[P++]+=-t.tangts[F]*R,M[P++]+=t.tangts[I]*R,M[P]+=t.tangts[U]*R,P=S+t.indices[w++]*L,M[P++]+=-t.tangts[F]*R,M[P++]+=t.tangts[I]*R,M[P]+=t.tangts[U]*R,F+=3,I+=3,U+=3;for(w=S;E>w;){var O=M[w],B=M[w+1],k=M[w+2],N=1/Math.sqrt(O*O+B*B+k*k);M[w]=O*N,M[w+1]=B*N,M[w+2]=k*N,w+=L}},e}();t.GeometryData=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.Static=0]="Static",t[t.Skin=1]="Skin",t[t.Particle=2]="Particle",t[t.Billbord=3]="Billbord",t[t.VertexAnim=4]="VertexAnim",t[t.Grass=5]="Grass",t[t.Ribbon=6]="Ribbon",t[t.wrieFrame=7]="wrieFrame",t[t.Shadow=8]="Shadow"}(t.GeometryType||(t.GeometryType={}));var e=(t.GeometryType,function(){function e(){this.geomtryType=0,this.vertexAttLength=17,this.positionSize=3,this.normalSize=3,this.tangentSize=3,this.colorSize=4,this.uvSize=2,this.uv2Size=2,this.numItems=0,this.minPos=new t.Vector3D,this.maxPos=new t.Vector3D,this.textureFile="",this.textureSpecular="",this.textureBump=""}return e.prototype.buildGeomtry=function(){},e.prototype.updata=function(t,e){},e.prototype.buildBoundBox=function(){this.minPos.copyFrom(new t.Vector3D(99999,99999,99999)),this.maxPos.copyFrom(new t.Vector3D(-99999,-99999,-99999));for(var e=0;e<this.verticesData.length;e+=this.vertexAttLength)this.maxPos.x<this.verticesData[e]&&(this.maxPos.x=this.verticesData[e]),this.maxPos.y<this.verticesData[e+1]&&(this.maxPos.y=this.verticesData[e+1]),this.maxPos.z<this.verticesData[e+2]&&(this.maxPos.z=this.verticesData[e+2]),this.minPos.x>this.verticesData[e]&&(this.minPos.x=this.verticesData[e]),this.minPos.y>this.verticesData[e+1]&&(this.minPos.y=this.verticesData[e+1]),this.minPos.z>this.verticesData[e+2]&&(this.minPos.z=this.verticesData[e+2])},e.prototype.rotationGeomtry=function(e){this.rotationQ=new t.Quaternion,this.rotationQ.fromEulerAngles(e.x*t.Matrix3DUtils.RADIANS_TO_DEGREES,e.y*t.Matrix3DUtils.RADIANS_TO_DEGREES,e.z*t.Matrix3DUtils.RADIANS_TO_DEGREES);for(var i=new t.Vector3D,a=0;a<this.verticesData.length/this.vertexAttLength;a++)i.x=this.verticesData[this.vertexAttLength*a+0],i.y=this.verticesData[this.vertexAttLength*a+1],i.z=this.verticesData[this.vertexAttLength*a+2],this.rotationQ.rotatePoint(i,i),this.verticesData[this.vertexAttLength*a+0]=i.x,this.verticesData[this.vertexAttLength*a+1]=i.y,this.verticesData[this.vertexAttLength*a+2]=i.z},e.prototype.dispose=function(){},e}());t.GeometryBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.setGeomtryData=function(t,e){this.indexData=t,this.verticesData=e,this.numItems=t.length},e}(t.GeometryBase);t.SubGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i,a){void 0===t&&(t=80),void 0===i&&(i=80),void 0===a&&(a=80),e.call(this),this.width=80,this.height=80,this.depth=80,this.width=t,this.height=i,this.depth=a,this.buildGeomtry()
}return __extends(i,e),i.prototype.buildGeomtry=function(){var t=new Array;t.push(.5*-this.width,.5*-this.height,.5*-this.depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this.width,.5*this.height,.5*-this.depth,0,0,-10,1,0,0,1,1,1,1,1,1,0,0,.5*this.width,.5*this.height,.5*-this.depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this.width,.5*this.height,.5*-this.depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this.width,.5*-this.height,.5*-this.depth,0,0,-10,1,0,0,1,1,1,1,0,0,0,0,.5*-this.width,.5*-this.height,.5*-this.depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this.width,.5*-this.height,.5*this.depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*this.width,.5*-this.height,.5*this.depth,0,0,10,1,0,0,1,1,1,1,1,0,0,0,.5*this.width,.5*this.height,.5*this.depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*this.width,.5*this.height,.5*this.depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*-this.width,.5*this.height,.5*this.depth,0,0,10,1,0,0,1,1,1,1,0,1,0,0,.5*-this.width,.5*-this.height,.5*this.depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*-this.width,.5*-this.height,.5*-this.depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this.width,.5*-this.height,.5*-this.depth,0,-10,0,1,0,0,1,1,1,1,1,0,0,0,.5*this.width,.5*-this.height,.5*this.depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this.width,.5*-this.height,.5*this.depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this.width,.5*-this.height,.5*this.depth,0,-10,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this.width,.5*-this.height,.5*-this.depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this.width,.5*-this.height,.5*-this.depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this.width,.5*this.height,.5*-this.depth,10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*this.width,.5*this.height,.5*this.depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this.width,.5*this.height,.5*this.depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this.width,.5*-this.height,.5*this.depth,10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*this.width,.5*-this.height,.5*-this.depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this.width,.5*this.height,.5*-this.depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this.width,.5*this.height,.5*-this.depth,0,10,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this.width,.5*this.height,.5*this.depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this.width,.5*this.height,.5*this.depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this.width,.5*this.height,.5*this.depth,0,10,0,1,0,0,1,1,1,1,0,1,0,0,.5*this.width,.5*this.height,.5*-this.depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this.width,.5*this.height,.5*-this.depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this.width,.5*-this.height,.5*-this.depth,-10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this.width,.5*-this.height,.5*this.depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this.width,.5*-this.height,.5*this.depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this.width,.5*this.height,.5*this.depth,-10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this.width,.5*this.height,.5*-this.depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0);var e=new Array;e.push(0,2,1,3,5,4,6,8,7,9,11,10,12,14,13,15,17,16,18,20,19,21,23,22,24,26,25,27,29,28,30,32,31,33,35,34),this.setGeomtryData(e,t),this.buildBoundBox()},i.prototype.transfromVertex=function(e){this.sharedVertexBuffer&&(t.Egret3DDrive.context3D.gl.deleteBuffer(this.sharedVertexBuffer),this.sharedVertexBuffer=null);for(var i=17,a=this.verticesData.length/i,r=0;a>r;r++)this.verticesData[i*r+0]+=e.x,this.verticesData[i*r+1]+=e.y,this.verticesData[i*r+2]+=e.z},i}(t.SubGeometry);t.CubeGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i,a){void 0===e&&(e=100),void 0===i&&(i=15),void 0===a&&(a=15),t.call(this),this._segmentsW=50,this._segmentsH=50,this._radius=100,this._radius=e,this._segmentsW=i,this._segmentsH=a,this.buildSphere()}return __extends(e,t),e.prototype.buildSphere=function(){var t,e,i=0,a=0,r=0,s=(this._segmentsH+1)*(this._segmentsW+1),n=this.vertexAttLength,o=n-9;t=new Array(s*n),e=new Array((this._segmentsH-1)*this._segmentsW*6);var h=0,u=0,l=0,c=0,d=0,f=0;for(a=0;a<=this._segmentsH;++a){h=u;var p=Math.PI*a/this._segmentsH,g=-this._radius*Math.cos(p),m=this._radius*Math.sin(p);for(i=0;i<=this._segmentsW;++i){var _=2*Math.PI*i/this._segmentsW,D=m*Math.cos(_),y=m*Math.sin(_),v=1/Math.sqrt(D*D+y*y+g*g),x=Math.sqrt(y*y+D*D);if(d=0,f=x>.007?D/x:0,l=-g,c=y,i==this._segmentsW?(t[u++]=t[h],t[u++]=t[h+1],t[u++]=t[h+2],t[u++]=D*v,t[u++]=l*v,t[u++]=c*v,t[u++]=x>.007?-y/x:1,t[u++]=d,t[u++]=f,t[u+0]=1,t[u+1]=1,t[u+2]=1,t[u+3]=1):(t[u++]=D,t[u++]=l,t[u++]=c,t[u++]=D*v,t[u++]=l*v,t[u++]=c*v,t[u++]=x>.007?-y/x:1,t[u++]=d,t[u++]=f,t[u]=1,t[u+1]=1,t[u+2]=1,t[u+3]=1),i>0&&a>0){var w=(this._segmentsW+1)*a+i,b=(this._segmentsW+1)*a+i-1,T=(this._segmentsW+1)*(a-1)+i-1,A=(this._segmentsW+1)*(a-1)+i;a==this._segmentsH?(t[u-9]=t[h],t[u-8]=t[h+1],t[u-7]=t[h+2],e[r++]=w,e[r++]=A,e[r++]=T):1==a?(e[r++]=w,e[r++]=T,e[r++]=b):(e[r++]=w,e[r++]=A,e[r++]=T,e[r++]=w,e[r++]=T,e[r++]=b)}u+=o}}var n=17,o=((this._segmentsH+1)*(this._segmentsW+1)*n,n-2),u=13;for(a=0;a<=this._segmentsH;++a)for(i=0;i<=this._segmentsW;++i)t[u++]=i/this._segmentsW,t[u++]=a/this._segmentsH,u+=o;this.setGeomtryData(e,t)},e}(t.SubGeometry);t.SphereGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i,a,r,s,n){void 0===t&&(t=500),void 0===i&&(i=500),void 0===a&&(a=1),void 0===r&&(r=1),void 0===s&&(s=1),void 0===n&&(n=1),e.call(this),this._segmentsW=1,this._segmentsH=1,this._width=500,this._height=500,this._scaleU=1,this._scaleV=1,this._width=t,this._height=i,this._segmentsW=a,this._segmentsH=r,this._scaleU=s,this._scaleV=n,this.buildGeometry()}return __extends(i,e),i.prototype.buildGeometry=function(){var e,i,a,r,s,n,o=this._segmentsW+1,h=(this._segmentsH+1)*o,u=this.vertexAttLength,l=u-15;s=this._segmentsH*this._segmentsW*6,e=new Array(h*u),i=new Array(s),s=0;for(var c=(new t.Vector3D,0),d=0;d<=this._segmentsH;++d)for(var f=0;f<=this._segmentsW;++f)if(a=(f/this._segmentsW-.5)*this._width,r=(d/this._segmentsH-.5)*this._height,e[c++]=a,e[c++]=0,e[c++]=r,e[c++]=0,e[c++]=1,e[c++]=0,e[c++]=1,e[c++]=0,e[c++]=0,e[c++]=1,e[c++]=1,e[c++]=1,e[c++]=1,e[c++]=f/this._segmentsW*this._scaleU,e[c++]=(1-d/this._segmentsH)*this._scaleV,c+=l,f!=this._segmentsW&&d!=this._segmentsH){n=f+d*o;var p=1;i[s++]=n*p,i[s++]=(n+o+1)*p,i[s++]=(n+o)*p,i[s++]=n*p,i[s++]=(n+1)*p,i[s++]=(n+o+1)*p}this.setGeomtryData(i,e),this.buildBoundBox()},i}(t.SubGeometry);t.PlaneGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.buildGeomtry()}return __extends(e,t),e.prototype.buildGeomtry=function(){var t=new Array,e=new Array,i=10,a=10,r=60,s=10,n=2*Math.PI/i;for(s=0;i>=s;s++){var o=a*Math.sin(s*n),h=a*Math.cos(s*n);t.push(o,0+r/2,h,o,0,h,1,1,1,1,1,0,0,0,o,0-r/2,h,o,0,h,1,1,1,1,1,0,0,0)}for(t.push(0,0+r/2,0,0,1,0,1,1,1,1,1,0,0,0),s=0;i>=s;s++){var o=a*Math.sin(s*n),h=a*Math.cos(s*n);t.push(o,0+r/2,h,0,1,0,1,1,1,1,1,0,0,0)}for(t.push(0,0-r/2,0,0,-1,0,1,1,1,1,1,0,0,0),s=i;s>=0;s--){var o=a*Math.sin(s*n),h=a*Math.cos(s*n);t.push(o,0-r/2,h,0,-1,0,1,1,1,1,1,0,0,0)}this.setGeomtryData(e,t)},e}(t.SubGeometry);t.CylinderGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.vertexIndices=new Array,this.uvIndices=new Array,this.uv2Indices=new Array,this.normalIndices=new Array,this.colorIndices=new Array,this.indexIds=new Array}return t}();t.FaceData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.geomtryType=t.GeometryType.Skin}return __extends(i,e),i.prototype.setGeomtryData=function(t,e,i){this.indexData=t,this.verticesData=e,this.numItems=t.length,this.initialSkeleton=i},i}(t.GeometryBase);t.SkinGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i,a,r,s,n,o,h){void 0===i&&(i=1e3),void 0===a&&(a=100),void 0===r&&(r=1e3),void 0===s&&(s=30),void 0===n&&(n=30),void 0===o&&(o=255),void 0===h&&(h=0),t.call(this),this._scaleU=1,this._scaleV=1,this._segmentsW=s,this._segmentsH=n,this._width=i,this._height=a,this._depth=r,this._minElevation=h,this._maxElevation=o,this.heightmap=e,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e.imageData,0,0,e.width,e.height),document.body.appendChild(this.canvas),this.canvas.hidden=!0,this.imageData=this.ctx.getImageData(0,0,this.heightmap.imageData.width,this.heightmap.imageData.height),this.buildElevationGeometry()}return __extends(e,t),e.prototype.getPixel=function(t,e){var i=e*(4*this.heightmap.imageData.width)+4*t,a=this.imageData.data[i+3]<<24|this.imageData.data[i+0]<<16|this.imageData.data[i+1]<<8|this.imageData.data[i+2];return a},e.prototype.getHeightBypos=function(t,e){var i=this.getPixel(t,e);return i>this._maxElevation?this._maxElevation/255*this._height:i<this._minElevation?this._minElevation/255*this._height:i/255*this._height},e.prototype.buildElevationGeometry=function(){var t,e,i,a,r,s,n,o,h,u=this._segmentsW+1,l=(this._segmentsH+1)*u,c=(this.heightmap.width-1)/this._segmentsW,d=(this.heightmap.height-1)/this._segmentsH;t=new Array(3*l),e=new Array(this._segmentsH*this._segmentsW*6),l=0,r=0;for(var f,p=0;p<=this._segmentsH;++p)for(var g=0;g<=this._segmentsW;++g)i=(g/this._segmentsW-.5)*this._width,a=(p/this._segmentsH-.5)*this._depth,n=Math.floor(g*c),o=Math.floor((this._segmentsH-p)*d),f=255&this.getPixel(n,o),h=f>this._maxElevation?this._maxElevation/255*this._height:f<this._minElevation?this._minElevation/255*this._height:f/255*this._height,t[l++]=i,t[l++]=h,t[l++]=a,t[l++]=1,t[l++]=1,t[l++]=1,t[l++]=-1,t[l++]=0,t[l++]=0,t[l++]=1,t[l++]=1,t[l++]=1,t[l++]=1,t[l++]=g/this._segmentsW*this._scaleU,t[l++]=p/this._segmentsH*this._scaleV,t[l++]=g/this._segmentsW,t[l++]=p/this._segmentsH,g!=this._segmentsW&&p!=this._segmentsH&&(s=g+p*u,e[r++]=s,e[r++]=s+u+1,e[r++]=s+u,e[r++]=s,e[r++]=s+1,e[r++]=s+u+1);this.indexData=e,this.verticesData=t,this.numItems=e.length},e.prototype.updateFaceNormals=function(){for(var t,e,i,a,r,s,n,o,h,u,l,c,d,f,p,g,m,_,D,y,v=0,x=0,w=this.indexData.length,b=this.verticesData,T=17,A=0;w>v;)t=A+this.indexData[v++]*T,e=b[t],r=b[t+1],o=b[t+2],t=A+this.indexData[v++]*T,i=b[t],s=b[t+1],h=b[t+2],t=A+this.indexData[v++]*T,a=b[t],n=b[t+1],u=b[t+2],l=a-e,c=n-r,d=u-o,f=i-e,p=s-r,g=h-o,m=d*p-c*g,_=l*g-d*f,D=c*f-l*p,y=Math.sqrt(m*m+_*_+D*D),y=1/y,b[x*T+3]=m*y,b[x*T+4]=_*y,b[x*T+5]=D*y,x++},e}(t.GeometryBase);t.ElevationGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.packageGeometry=function(e,i,a){a.numberOfVertices=a.verticesData.length/a.vertexAttLength;for(var r=new t.SubGeometry,s=a.vertexAttLength,n=a.numberOfVertices*i,o=new Array(n*e),h=new Array(e*a.indexData.length),u=0;e>u;u++)for(var l=0;l<a.numberOfVertices;l++)o[l*i+0+u*n]=a.verticesData[l*s+0],o[l*i+1+u*n]=a.verticesData[l*s+1],o[l*i+2+u*n]=a.verticesData[l*s+2],o[l*i+3+u*n]=u,o[l*i+4+u*n]=0,o[l*i+5+u*n]=0,o[l*i+6+u*n]=0,o[l*i+7+u*n]=a.verticesData[l*s+13],o[l*i+8+u*n]=a.verticesData[l*s+14];for(var u=0;e>u;u++)for(var l=0;l<a.indexData.length;l++)h[l+u*a.indexData.length]=a.indexData[l]+u*a.numberOfVertices;return r.setGeomtryData(h,o),r.geometryNum=e,r.vertexAttLength=i,r.numberOfVertices=r.verticesData.length/r.vertexAttLength,r},e}();t.GeometryUtil=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i,a){void 0===a&&(a=null),t.call(this),this.geometry=e,this.material=i,this.animation=a,this.box.fillBox(this.geometry.minPos,this.geometry.maxPos)}return __extends(e,t),e.prototype.clone=function(){return new e(this.geometry,this.material,this.animation?this.animation.clone():null)},e.prototype.update=function(t,e,i){this.isDisable||this.animation&&this.animation.updata(e,i)},e}(t.Object3D);t.Mesh=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.LOADER_MODEL_TYPE=0]="LOADER_MODEL_TYPE",t[t.LOADER_SCENE_TYPE=1]="LOADER_SCENE_TYPE",t[t.LOADER_TEXTURE_TYPE=2]="LOADER_TEXTURE_TYPE"}(t.LoaderType||(t.LoaderType={}));var e=(t.LoaderType,function(t){function e(e,i){void 0===i&&(i=null),t.call(this),this.type=e,this.url=i}return __extends(e,t),e.prototype.load=function(t){void 0===t&&(t=null),null!=t&&(this.url=t),null!=this.url&&this.onLoad()},e.prototype.onLoad=function(){},e}(t.EventDispatcher));t.BaseLoader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){void 0===i&&(i=null),e.call(this,t.LoaderType.LOADER_TEXTURE_TYPE,i)}return __extends(i,e),Object.defineProperty(i.prototype,"texture",{get:function(){return this._texture},enumerable:!0,configurable:!0}),i.prototype.onLoad=function(){var e=this,i=new t.URLLoader;i.onLoadComplete=function(t){return e.onEMFileLoadComplete(t)},i.load(this.url)},i.prototype.onEMFileLoadComplete=function(e){this._texture=e.data,this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE,this))},i}(t.BaseLoader);t.TextureLoader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r){void 0===i&&(i=null),void 0===a&&(a=null),void 0===r&&(r=null),e.call(this,t.LoaderType.LOADER_MODEL_TYPE,i),this.url=i,this._esmFile=a,this._eamFiles=r}return __extends(i,e),Object.defineProperty(i.prototype,"esmFile",{get:function(){return this._esmFile},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"mesh",{get:function(){return this._mesh},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"geomtry",{get:function(){return this._geomtry},enumerable:!0,configurable:!0}),i.prototype.onLoad=function(){var e=this;this._mesh=null,this._geomtry=null;var i=new t.URLLoader;i.onLoadComplete=function(t){return e.onESMLoadComplete(e.url,t,e._eamFiles)},i.load(this.url+this._esmFile)},i.prototype.onESMLoadComplete=function(e,i,a){this._geomtry=i.data;var r=this._geomtry.textureFile&&this._geomtry.textureFile.length>0,s=this._geomtry.textureBump&&this._geomtry.textureBump.length>0,n=this._geomtry.textureSpecular&&this._geomtry.textureSpecular.length>0,o=new t.TextureMaterial(null);if(this._geomtry.textureFile.length>0){var h=new t.AsyncLoadingTexturematerial(o);h.loadTexture(r?e+this._geomtry.textureFile:null,s?e+this._geomtry.textureBump:null,n?e+this._geomtry.textureSpecular:null)}if(this._geomtry.geomtryType==t.GeometryType.Skin){var u=this._geomtry;this._mesh=new t.Mesh(this._geomtry,o,new t.SkeletonAnimation(u.initialSkeleton))}else this._mesh=new t.Mesh(this._geomtry,o);if(a&&a.length>0)this.loadEAMFile(e,0,a);else{var l=new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE);l.data=this,this.dispatchEvent(l)}},i.prototype.loadEAMFile=function(e,i,a){var r=this;if(i>=a.length){var s=new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE);return s.data=this,void this.dispatchEvent(s)}var n=new t.URLLoader;n.onLoadComplete=function(t){return r.onEAMLoadComplete(e,t.data,i,a)},n.load(e+a[i])},i.prototype.onEAMLoadComplete=function(t,e,i,a){this._mesh.animation.addSkeletonAnimationClip(e),this.loadEAMFile(t,i+1,a)},i}(t.BaseLoader);t.ModeLoader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){void 0===i&&(i=null),e.call(this,t.LoaderType.LOADER_SCENE_TYPE,i),this._meshList=[],this._totalNumber=0}return __extends(i,e),Object.defineProperty(i.prototype,"meshList",{get:function(){return this._meshList},enumerable:!0,configurable:!0}),i.prototype.onLoad=function(){var e=this;this._meshList=[];var i=new t.URLLoader;i.onLoadComplete=function(t){return e.onEMFileLoadComplete(e.url,t)},i.load(this.url+"/config.em")},i.prototype.onEMFileLoadComplete=function(e,i){var a=this.parsingXML(i.data),r=a.getElementsByTagName("mesh");this._totalNumber=r.length;for(var s=0;s<r.length;s++){var n=e;n+="/"+r[s].attributes.getNamedItem("link").value;var o=new t.Vector3D;o.parsing(r[s].attributes.getNamedItem("rotation").value);var h=new t.Vector3D;h.parsing(r[s].attributes.getNamedItem("scaling").value);var u=new t.Vector3D;u.parsing(r[s].attributes.getNamedItem("translation").value),this.loadChild(n,o,h,u,e+"/")}},i.prototype.loadChild=function(e,i,a,r,s){var n=this,o=new t.URLLoader;o.onLoadComplete=function(t){return n.onLoadComplete(t,i,a,r,s)},o.load(e)},i.prototype.onLoadComplete=function(e,i,a,r,s){var n=e.data,o=new t.TextureMaterial,h=new t.AsyncLoadingTexturematerial(o);h.loadTexture(n.textureFile.length>0?s+n.textureFile:null,n.textureBump.length>0?s+n.textureBump:null,n.textureSpecular.length>0?s+n.textureSpecular:null);var u=new t.Mesh(e.data,o);u.scaleX=a.x,u.scaleY=a.y,u.scaleZ=a.z,u.rotationX=i.x,u.rotationY=i.y,u.rotationZ=i.z,u.x=r.x,u.y=r.y,u.z=r.z,this._meshList.push(u),this._meshList.length>=this._totalNumber&&this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE,this))},i.prototype.parsingXML=function(t){var e=null;if(!window.DOMParser&&window.ActiveXObject)for(var i=["MSXML.2.DOMDocument.6.0","MSXML.2.DOMDocument.3.0","Microsoft.XMLDOM"],a=0;a<i.length;a++)try{e=new ActiveXObject(i[a]),e.async=!1,e.loadXML(t);break}catch(r){}else{if(!(window.DOMParser&&document.implementation&&document.implementation.createDocument))return null;try{var s=new DOMParser;e=s.parseFromString(t,"text/xml")}catch(r){}}return e},i}(t.BaseLoader);t.SceneLoader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this._url="",this._data=null,this._dataformat=null,this.onLoadComplete=null,this.onLoadError=null,this.onLoadProgress=null,t&&(e&&(this.dataformat=e),this.load(t))}return e.prototype.load=function(t){var i=this;if(this._data=null,this._url=t,null==this._dataformat&&(this._dataformat=e.DATAFORMAT_TEXT,this._url.length>=4))switch(this._url.substr(this._url.length-4,4).toLowerCase()){case".dds":this._dataformat=e.DATAFORMAT_DDS;break;case".tga":this._dataformat=e.DATAFORMAT_TGA;break;case".bmp":this._dataformat=e.DATAFORMAT_BITMAP;break;case".png":this._dataformat=e.DATAFORMAT_BITMAP;break;case".jpg":this._dataformat=e.DATAFORMAT_BITMAP;break;case"glsl":this._dataformat=e.DATAFORMAT_TEXT;break;case".pvr":this._dataformat=e.DATAFORMAT_PVR;break;case".esm":this._dataformat=e.DATAFORMAT_ESM;break;case".eam":this._dataformat=e.DATAFORMAT_EAM;break;case".eca":this._dataformat=e.DATAFORMAT_ECA}return null==this._xhr&&(this._xhr=this.getXHR()),null==this._xhr?void alert("Your browser does not support XMLHTTP."):(this._xhr.readyState>0&&this._xhr.abort(),this._xhr.open("GET",this._url,!0),this._xhr.addEventListener("progress",function(t){return i.onProgress(t)},!1),this._xhr.addEventListener("readystatechange",function(t){return i.onReadyStateChange(t)},!1),this._xhr.addEventListener("error",function(t){return i.onError(t)},!1),this.dataformat==e.DATAFORMAT_BITMAP?this._xhr.responseType="blob":this.dataformat!=e.DATAFORMAT_TEXT&&(this._xhr.responseType="arraybuffer"),void this._xhr.send())},Object.defineProperty(e.prototype,"dataformat",{get:function(){return this._dataformat},set:function(t){this._dataformat=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),e.prototype.onReadyStateChange=function(t){4==this._xhr.readyState&&(this._xhr.status>=400||0==this._xhr.status?console.log(this._url,"load fail"):this.loadComplete())},e.prototype.loadComplete=function(){switch(this.dataformat){case e.DATAFORMAT_BINARY:this._data=new t.ByteArray(this._xhr.response);break;case e.DATAFORMAT_SOUND:this._data=this._xhr.responseBody;break;case e.DATAFORMAT_TEXT:this._data=this._xhr.responseText;break;case e.DATAFORMAT_BITMAP:var i=document.createElement("img");void 0!=window.createObjectURL?i.src=window.createObjectURL(this._xhr.response):void 0!=window.URL?i.src=window.URL.createObjectURL(this._xhr.response):void 0!=window.webkitURL&&(i.src=window.webkitURL.createObjectURL(this._xhr.response));var a=this;return void(i.onload=function(){a._data=new t.ImageTexture(i),a.onLoadComplete&&a.onLoadComplete(a)});case e.DATAFORMAT_DDS:this._data=t.DDSParser.parse(this._xhr.response);break;case e.DATAFORMAT_TGA:this._data=t.TGAParser.parse(this._xhr.response);break;case e.DATAFORMAT_ESM:var r=t.ESMParser.parse(this._xhr.response);this._data=r;break;case e.DATAFORMAT_EAM:var s=t.EAMParser.parse(this._xhr.response);this._data=s;break;case e.DATAFORMAT_ECA:var n=t.ECAParser.parse(this._xhr.response);this._data=n;break;case e.DATAFORMAT_PVR:var o=t.PVRParser.parse(this._xhr.response);this._data=o;break;default:this._data=this._xhr.responseText}this.onLoadComplete&&this.onLoadComplete(this)},e.prototype.onProgress=function(t){},e.prototype.onError=function(e){this.onLoadError&&this.onLoadError(),t.Debug.instance.trace("loaderror, url: ",this._url),console.log("load error",e)},e.prototype.getXHR=function(){var t=null;return t=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")},e.DATAFORMAT_BINARY="binary",e.DATAFORMAT_TEXT="text",e.DATAFORMAT_SOUND="sound",e.DATAFORMAT_BITMAP="bitmap",e.DATAFORMAT_DDS="dds",e.DATAFORMAT_TGA="tga",e.DATAFORMAT_ESM="esm",e.DATAFORMAT_EAM="eam",e.DATAFORMAT_ECA="eca",e.DATAFORMAT_PVR="pvr",e}();t.URLLoader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this._mat=t}return e.prototype.loadTexture=function(e,i,a){var r=this;if(void 0===i&&(i=null),void 0===a&&(a=null),e){var s=new t.URLLoader;s.onLoadComplete=function(t){return r.__textureComplete(t)},s.load(e)}if(i){var n=new t.URLLoader;n.onLoadComplete=function(t){return r.__bumpComplete(t)},n.load(i)}if(a){var o=new t.URLLoader;o.onLoadComplete=function(t){return r.__specComplete(t)},o.load(a)}},e.prototype.__specComplete=function(e){e.data.upload(t.Egret3DDrive.context3D),this._mat.specularTexture=e.data},e.prototype.__textureComplete=function(e){e.data.upload(t.Egret3DDrive.context3D),this._mat.diffuseTexture=e.data},e.prototype.__bumpComplete=function(e){e.data.upload(t.Egret3DDrive.context3D),this._mat.normalTexture=e.data},e}();t.AsyncLoadingTexturematerial=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.RGB_S3TC_DXT1_FORMAT=2001]="RGB_S3TC_DXT1_FORMAT",t[t.RGBA_S3TC_DXT1_FORMAT=2002]="RGBA_S3TC_DXT1_FORMAT",t[t.RGBA_S3TC_DXT3_FORMAT=2003]="RGBA_S3TC_DXT3_FORMAT",t[t.RGBA_S3TC_DXT5_FORMAT=2003]="RGBA_S3TC_DXT5_FORMAT"}(t.DDSFormat||(t.DDSFormat={}));var e=t.DDSFormat,i=function(){function i(){}return i.parse=function(r,s){void 0===s&&(s=!0);var n=new a,o=31,h=0,u=542327876,l=131072,c=512,d=4,f=i.fourCCToInt32("DXT1"),p=i.fourCCToInt32("DXT3"),g=i.fourCCToInt32("DXT5"),m=1021,h=0,_=1,D=2,y=3,v=4,x=7,w=20,b=21,T=22,A=23,E=24,L=25,S=26,M=28,P=new Int32Array(r,0,o);if(P[h]!==u)return console.error("DDSParser.parse: Invalid magic number in DDS header."),null;if(!(P[w]&d))return console.error("DDSParser.parse: Unsupported format, must contain a FourCC code."),null;var R,C=P[b],F=!1;switch(C){case f:R=8,n.format=e.RGB_S3TC_DXT1_FORMAT;break;case p:R=16,n.format=e.RGBA_S3TC_DXT3_FORMAT;break;case g:R=16,n.format=e.RGBA_S3TC_DXT5_FORMAT;break;default:if(!(32==P[T]&&16711680&P[A]&&65280&P[E]&&255&P[L]&&4278190080&P[S]))return console.error("DDSParser.parse: Unsupported FourCC code ",i.int32ToFourCC(C)),null;F=!0,R=64,n.format=m}n.mipmapCount=1,P[D]&l&&s!==!1&&(n.mipmapCount=Math.max(1,P[x])),n.isCubemap=P[M]&c?!0:!1,n.width=P[v],n.height=P[y];var I=P[_]+4,U=n.width,O=n.height,B=n.isCubemap?6:1,k=!1;n.format==e.RGB_S3TC_DXT1_FORMAT&&0==t.Egret3DDrive.ColorFormat_DXT1_RGB?k=!0:n.format==e.RGBA_S3TC_DXT3_FORMAT&&0==t.Egret3DDrive.ColorFormat_DXT3_RGBA?k=!0:n.format==e.RGBA_S3TC_DXT5_FORMAT&&0==t.Egret3DDrive.ColorFormat_DXT5_RGBA&&(k=!0);for(var N=0;B>N;N++){for(var V=0;V<n.mipmapCount;V++){var G;if(F){G=i.loadARGBMip(r,I,U,O);var z=G.length}else{var z=Math.max(4,U)/4*Math.max(4,O)/4*R;G=new Uint8Array(r,I,z),k&&(G=i.softSolutionDXT(U,O,n.format,G))}var j=new t.MipmapData(G,U,O);n.mipmaps.push(j),I+=z,U=Math.max(.5*U,1),O=Math.max(.5*O,1)}U=n.width,O=n.height}var K=new t.TextureBase;return k?(K.internalFormat=t.InternalFormat.PixelArray,K.colorFormat=t.Egret3DDrive.ColorFormat_RGBA8888):(K.internalFormat=t.InternalFormat.CompressData,f==C?K.colorFormat=t.Egret3DDrive.ColorFormat_DXT1_RGB:p==C?K.colorFormat=t.Egret3DDrive.ColorFormat_DXT3_RGBA:g==C&&(K.colorFormat=t.Egret3DDrive.ColorFormat_DXT5_RGBA)),K.mimapData=n.mipmaps,K},i.loadARGBMip=function(t,e,i,a){for(var r=i*a*4,s=new Uint8Array(t,e,r),n=new Uint8Array(r),o=0,h=0,u=0;a>u;u++)for(var l=0;i>l;l++){var c=s[h];h++;var d=s[h];h++;var f=s[h];h++;var p=s[h];h++,n[o]=f,o++,n[o]=d,o++,n[o]=c,o++,n[o]=p,o++}return n},i.fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)},i.int32ToFourCC=function(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&65385)},i.softSolutionDXT=function(i,a,r,s){var n,o=new Uint8Array(i*a*4),h=[new t.Color,new t.Color,new t.Color,new t.Color],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];switch(r){case e.RGB_S3TC_DXT1_FORMAT:case e.RGBA_S3TC_DXT1_FORMAT:n=s.length/8;for(var l=0;n>l;l++){var c=s[8*l+0]|s[8*l+1]<<8,d=s[8*l+2]|s[8*l+3]<<8;h[0].r=c>>11&31,h[0].g=c>>5&63,h[0].b=31&c,h[0].a=255,h[1].r=d>>11&31,h[1].g=d>>5&63,h[1].b=31&d,h[1].a=255,c>d?(h[2].lerp(h[0],h[1],.33),h[3].lerp(h[0],h[1],.66)):h[2].lerp(h[0],h[1],.5);for(var f=0;4>f;f++)u[4*f+0]=3&s[8*l+4+f],u[4*f+1]=s[8*l+4+f]>>2&3,u[4*f+2]=s[8*l+4+f]>>4&3,u[4*f+3]=s[8*l+4+f]>>6&3;for(var p=0;p<h.length;p++)h[p].r=8*h[p].r,h[p].g=4*h[p].g,h[p].b=8*h[p].b;var g=l%(i/4)*4,m=4*Math.floor(l/(i/4));a>m+0&&(i>g+0&&(o[(m+0)*(4*i)+4*(g+0)+0]=h[u[0]].r,o[(m+0)*(4*i)+4*(g+0)+1]=h[u[0]].g,o[(m+0)*(4*i)+4*(g+0)+2]=h[u[0]].b,o[(m+0)*(4*i)+4*(g+0)+3]=h[u[0]].a),i>g+1&&(o[(m+0)*(4*i)+4*(g+1)+0]=h[u[1]].r,o[(m+0)*(4*i)+4*(g+1)+1]=h[u[1]].g,o[(m+0)*(4*i)+4*(g+1)+2]=h[u[1]].b,o[(m+0)*(4*i)+4*(g+1)+3]=h[u[1]].a),i>g+2&&(o[(m+0)*(4*i)+4*(g+2)+0]=h[u[2]].r,o[(m+0)*(4*i)+4*(g+2)+1]=h[u[2]].g,o[(m+0)*(4*i)+4*(g+2)+2]=h[u[2]].b,o[(m+0)*(4*i)+4*(g+2)+3]=h[u[2]].a),i>g+3&&(o[(m+0)*(4*i)+4*(g+3)+0]=h[u[3]].r,o[(m+0)*(4*i)+4*(g+3)+1]=h[u[3]].g,o[(m+0)*(4*i)+4*(g+3)+2]=h[u[3]].b,o[(m+0)*(4*i)+4*(g+3)+3]=h[u[3]].a)),a>m+1&&(i>g+0&&(o[(m+1)*(4*i)+4*(g+0)+0]=h[u[4]].r,o[(m+1)*(4*i)+4*(g+0)+1]=h[u[4]].g,o[(m+1)*(4*i)+4*(g+0)+2]=h[u[4]].b,o[(m+1)*(4*i)+4*(g+0)+3]=h[u[4]].a),i>g+1&&(o[(m+1)*(4*i)+4*(g+1)+0]=h[u[5]].r,o[(m+1)*(4*i)+4*(g+1)+1]=h[u[5]].g,o[(m+1)*(4*i)+4*(g+1)+2]=h[u[5]].b,o[(m+1)*(4*i)+4*(g+1)+3]=h[u[5]].a),i>g+2&&(o[(m+1)*(4*i)+4*(g+2)+0]=h[u[6]].r,o[(m+1)*(4*i)+4*(g+2)+1]=h[u[6]].g,o[(m+1)*(4*i)+4*(g+2)+2]=h[u[6]].b,o[(m+1)*(4*i)+4*(g+2)+3]=h[u[6]].a),i>g+3&&(o[(m+1)*(4*i)+4*(g+3)+0]=h[u[7]].r,o[(m+1)*(4*i)+4*(g+3)+1]=h[u[7]].g,o[(m+1)*(4*i)+4*(g+3)+2]=h[u[7]].b,o[(m+1)*(4*i)+4*(g+3)+3]=h[u[7]].a)),a>m+2&&(i>g+0&&(o[(m+2)*(4*i)+4*(g+0)+0]=h[u[8]].r,o[(m+2)*(4*i)+4*(g+0)+1]=h[u[8]].g,o[(m+2)*(4*i)+4*(g+0)+2]=h[u[8]].b,o[(m+2)*(4*i)+4*(g+0)+3]=h[u[8]].a),i>g+1&&(o[(m+2)*(4*i)+4*(g+1)+0]=h[u[9]].r,o[(m+2)*(4*i)+4*(g+1)+1]=h[u[9]].g,o[(m+2)*(4*i)+4*(g+1)+2]=h[u[9]].b,o[(m+2)*(4*i)+4*(g+1)+3]=h[u[9]].a),i>g+2&&(o[(m+2)*(4*i)+4*(g+2)+0]=h[u[10]].r,o[(m+2)*(4*i)+4*(g+2)+1]=h[u[10]].g,o[(m+2)*(4*i)+4*(g+2)+2]=h[u[10]].b,o[(m+2)*(4*i)+4*(g+2)+3]=h[u[10]].a),i>g+3&&(o[(m+2)*(4*i)+4*(g+3)+0]=h[u[11]].r,o[(m+2)*(4*i)+4*(g+3)+1]=h[u[11]].g,o[(m+2)*(4*i)+4*(g+3)+2]=h[u[11]].b,o[(m+2)*(4*i)+4*(g+3)+3]=h[u[11]].a)),a>m+3&&(i>g+0&&(o[(m+3)*(4*i)+4*(g+0)+0]=h[u[12]].r,o[(m+3)*(4*i)+4*(g+0)+1]=h[u[12]].g,o[(m+3)*(4*i)+4*(g+0)+2]=h[u[12]].b,o[(m+3)*(4*i)+4*(g+0)+3]=h[u[12]].a),i>g+1&&(o[(m+3)*(4*i)+4*(g+1)+0]=h[u[13]].r,o[(m+3)*(4*i)+4*(g+1)+1]=h[u[13]].g,o[(m+3)*(4*i)+4*(g+1)+2]=h[u[13]].b,o[(m+3)*(4*i)+4*(g+1)+3]=h[u[13]].a),i>g+2&&(o[(m+3)*(4*i)+4*(g+2)+0]=h[u[14]].r,o[(m+3)*(4*i)+4*(g+2)+1]=h[u[14]].g,o[(m+3)*(4*i)+4*(g+2)+2]=h[u[14]].b,o[(m+3)*(4*i)+4*(g+2)+3]=h[u[14]].a),i>g+3&&(o[(m+3)*(4*i)+4*(g+3)+0]=h[u[15]].r,o[(m+3)*(4*i)+4*(g+3)+1]=h[u[15]].g,o[(m+3)*(4*i)+4*(g+3)+2]=h[u[15]].b,o[(m+3)*(4*i)+4*(g+3)+3]=h[u[15]].a))}break;case e.RGBA_S3TC_DXT3_FORMAT:n=s.length/16;for(var l=0;n>l;l++){var c=s[16*l+8]|s[16*l+9]<<8,d=s[16*l+10]|s[16*l+11]<<8;h[0].r=c>>11&31,h[0].g=c>>5&63,h[0].b=31&c,h[0].a=255,h[1].r=d>>11&31,h[1].g=d>>5&63,h[1].b=31&d,h[1].a=255,c>d?(h[2].lerp(h[0],h[1],.33),h[3].lerp(h[0],h[1],.66)):(h[2].lerp(h[0],h[1],.5),h[3].a=0);for(var f=0;4>f;f++)u[4*f+0]=3&s[16*l+12+f],u[4*f+1]=s[16*l+12+f]>>2&3,u[4*f+2]=s[16*l+12+f]>>4&3,u[4*f+3]=s[16*l+12+f]>>6&3;for(var p=0;p<h.length;p++)h[p].r=8*h[p].r,h[p].g=4*h[p].g,h[p].b=8*h[p].b;var g=l%(i/4)*4,m=4*Math.floor(l/(i/4));a>m+0&&(i>g+0&&(o[(m+0)*(4*i)+4*(g+0)+0]=h[u[0]].r,o[(m+0)*(4*i)+4*(g+0)+1]=h[u[0]].g,o[(m+0)*(4*i)+4*(g+0)+2]=h[u[0]].b,o[(m+0)*(4*i)+4*(g+0)+3]=17*(15&s[16*l+0])),i>g+1&&(o[(m+0)*(4*i)+4*(g+1)+0]=h[u[1]].r,o[(m+0)*(4*i)+4*(g+1)+1]=h[u[1]].g,o[(m+0)*(4*i)+4*(g+1)+2]=h[u[1]].b,o[(m+0)*(4*i)+4*(g+1)+3]=17*(s[16*l+0]>>4&15)),i>g+2&&(o[(m+0)*(4*i)+4*(g+2)+0]=h[u[2]].r,o[(m+0)*(4*i)+4*(g+2)+1]=h[u[2]].g,o[(m+0)*(4*i)+4*(g+2)+2]=h[u[2]].b,o[(m+0)*(4*i)+4*(g+2)+3]=17*(15&s[16*l+1])),i>g+3&&(o[(m+0)*(4*i)+4*(g+3)+0]=h[u[3]].r,o[(m+0)*(4*i)+4*(g+3)+1]=h[u[3]].g,o[(m+0)*(4*i)+4*(g+3)+2]=h[u[3]].b,o[(m+0)*(4*i)+4*(g+3)+3]=17*(s[16*l+1]>>4&15))),a>m+1&&(i>g+0&&(o[(m+1)*(4*i)+4*(g+0)+0]=h[u[4]].r,o[(m+1)*(4*i)+4*(g+0)+1]=h[u[4]].g,o[(m+1)*(4*i)+4*(g+0)+2]=h[u[4]].b,o[(m+1)*(4*i)+4*(g+0)+3]=17*(15&s[16*l+2])),i>g+1&&(o[(m+1)*(4*i)+4*(g+1)+0]=h[u[5]].r,o[(m+1)*(4*i)+4*(g+1)+1]=h[u[5]].g,o[(m+1)*(4*i)+4*(g+1)+2]=h[u[5]].b,o[(m+1)*(4*i)+4*(g+1)+3]=17*(s[16*l+2]>>4&15)),i>g+2&&(o[(m+1)*(4*i)+4*(g+2)+0]=h[u[6]].r,o[(m+1)*(4*i)+4*(g+2)+1]=h[u[6]].g,o[(m+1)*(4*i)+4*(g+2)+2]=h[u[6]].b,o[(m+1)*(4*i)+4*(g+2)+3]=17*(15&s[16*l+3])),i>g+3&&(o[(m+1)*(4*i)+4*(g+3)+0]=h[u[7]].r,o[(m+1)*(4*i)+4*(g+3)+1]=h[u[7]].g,o[(m+1)*(4*i)+4*(g+3)+2]=h[u[7]].b,o[(m+1)*(4*i)+4*(g+3)+3]=17*(s[16*l+3]>>4&15))),a>m+2&&(i>g+0&&(o[(m+2)*(4*i)+4*(g+0)+0]=h[u[8]].r,o[(m+2)*(4*i)+4*(g+0)+1]=h[u[8]].g,o[(m+2)*(4*i)+4*(g+0)+2]=h[u[8]].b,o[(m+2)*(4*i)+4*(g+0)+3]=17*(15&s[16*l+4])),i>g+1&&(o[(m+2)*(4*i)+4*(g+1)+0]=h[u[9]].r,o[(m+2)*(4*i)+4*(g+1)+1]=h[u[9]].g,o[(m+2)*(4*i)+4*(g+1)+2]=h[u[9]].b,o[(m+2)*(4*i)+4*(g+1)+3]=17*(s[16*l+4]>>4&15)),i>g+2&&(o[(m+2)*(4*i)+4*(g+2)+0]=h[u[10]].r,o[(m+2)*(4*i)+4*(g+2)+1]=h[u[10]].g,o[(m+2)*(4*i)+4*(g+2)+2]=h[u[10]].b,o[(m+2)*(4*i)+4*(g+2)+3]=17*(15&s[16*l+5])),i>g+3&&(o[(m+2)*(4*i)+4*(g+3)+0]=h[u[11]].r,o[(m+2)*(4*i)+4*(g+3)+1]=h[u[11]].g,o[(m+2)*(4*i)+4*(g+3)+2]=h[u[11]].b,o[(m+2)*(4*i)+4*(g+3)+3]=17*(s[16*l+5]>>4&15))),a>m+3&&(i>g+0&&(o[(m+3)*(4*i)+4*(g+0)+0]=h[u[12]].r,o[(m+3)*(4*i)+4*(g+0)+1]=h[u[12]].g,o[(m+3)*(4*i)+4*(g+0)+2]=h[u[12]].b,o[(m+3)*(4*i)+4*(g+0)+3]=17*(15&s[16*l+6])),i>g+1&&(o[(m+3)*(4*i)+4*(g+1)+0]=h[u[13]].r,o[(m+3)*(4*i)+4*(g+1)+1]=h[u[13]].g,o[(m+3)*(4*i)+4*(g+1)+2]=h[u[13]].b,o[(m+3)*(4*i)+4*(g+1)+3]=17*(s[16*l+6]>>4&15)),i>g+2&&(o[(m+3)*(4*i)+4*(g+2)+0]=h[u[14]].r,o[(m+3)*(4*i)+4*(g+2)+1]=h[u[14]].g,o[(m+3)*(4*i)+4*(g+2)+2]=h[u[14]].b,o[(m+3)*(4*i)+4*(g+2)+3]=17*(15&s[16*l+7])),i>g+3&&(o[(m+3)*(4*i)+4*(g+3)+0]=h[u[15]].r,o[(m+3)*(4*i)+4*(g+3)+1]=h[u[15]].g,o[(m+3)*(4*i)+4*(g+3)+2]=h[u[15]].b,o[(m+3)*(4*i)+4*(g+3)+3]=17*(s[16*l+7]>>4&15)))}break;case e.RGBA_S3TC_DXT5_FORMAT:}return o},i}();t.DDSParser=i;var a=function(){function t(){this.mipmaps=new Array,this.width=0,this.height=0,this.format=null,this.mipmapCount=1}return t}()}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){function i(t){switch(t.image_type){case d:case g:(t.colormap_length>256||24!==t.colormap_size||1!==t.colormap_type)&&console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case f:case p:case m:case _:t.colormap_type&&console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case c:console.error("TGAParser.parse.tgaCheckHeader: No data");break;default:console.error('TGAParser.parse.tgaCheckHeader: Invalid type " '+t.image_type+'"')}(t.width<=0||t.height<=0)&&console.error("TGAParser.parse.tgaCheckHeader: Invalid image size"),8!==t.pixel_size&&16!==t.pixel_size&&24!==t.pixel_size&&32!==t.pixel_size&&console.error('TGAParser.parse.tgaCheckHeader: Invalid pixel size "'+t.pixel_size+'"')
}function a(t,e,i,a,r){var s,n,o,h;if(n=i.pixel_size>>3,o=i.width*i.height*n,e&&(h=r.subarray(a,a+=i.colormap_length*(i.colormap_size>>3))),t){s=new Uint8Array(o);for(var u,l,c,d=0,f=new Uint8Array(n);o>d;)if(u=r[a++],l=(127&u)+1,128&u){for(c=0;n>c;++c)f[c]=r[a++];for(c=0;l>c;++c)s.set(f,d+c*n);d+=n*l}else{for(l*=n,c=0;l>c;++c)s[d+c]=r[a++];d+=l}}else s=r.subarray(a,a+=e?i.width*i.height:o);return{pixel_data:s,palettes:h}}function r(t,e,i,a,r,s,n,o,h){var u,l,c,d=h,f=0,p=E.width;for(c=e;c!==a;c+=i)for(l=r;l!==n;l+=s,f++)u=o[f],t[4*(l+p*c)+3]=255,t[4*(l+p*c)+2]=d[3*u+0],t[4*(l+p*c)+1]=d[3*u+1],t[4*(l+p*c)+0]=d[3*u+2];return t}function s(t,e,i,a,r,s,n,o){var h,u,l,c=0,d=E.width;for(l=e;l!==a;l+=i)for(u=r;u!==n;u+=s,c+=2)h=o[c+0]+(o[c+1]<<8),t[4*(u+d*l)+0]=(31744&h)>>7,t[4*(u+d*l)+1]=(992&h)>>2,t[4*(u+d*l)+2]=(31&h)>>3,t[4*(u+d*l)+3]=32768&h?0:255;return t}function n(t,e,i,a,r,s,n,o){var h,u,l=0,c=E.width;for(u=e;u!==a;u+=i)for(h=r;h!==n;h+=s,l+=3)t[4*(h+c*u)+3]=255,t[4*(h+c*u)+2]=o[l+0],t[4*(h+c*u)+1]=o[l+1],t[4*(h+c*u)+0]=o[l+2];return t}function o(t,e,i,a,r,s,n,o){var h,u,l=0,c=E.width;for(u=e;u!==a;u+=i)for(h=r;h!==n;h+=s,l+=4)t[4*(h+c*u)+2]=o[l+0],t[4*(h+c*u)+1]=o[l+1],t[4*(h+c*u)+0]=o[l+2],t[4*(h+c*u)+3]=o[l+3];return t}function h(t,e,i,a,r,s,n,o){var h,u,l,c=0,d=E.width;for(l=e;l!==a;l+=i)for(u=r;u!==n;u+=s,c++)h=o[c],t[4*(u+d*l)+0]=h,t[4*(u+d*l)+1]=h,t[4*(u+d*l)+2]=h,t[4*(u+d*l)+3]=255;return t}function u(t,e,i,a,r,s,n,o){var h,u,l=0,c=E.width;for(u=e;u!==a;u+=i)for(h=r;h!==n;h+=s,l+=2)t[4*(h+c*u)+0]=o[l+0],t[4*(h+c*u)+1]=o[l+0],t[4*(h+c*u)+2]=o[l+0],t[4*(h+c*u)+3]=o[l+1];return t}function l(t,e,i,a){var l,c,d,f,p,g,m=new Uint8Array(t*e*4);switch((E.flags&D)>>y){default:case w:l=0,d=1,p=t,c=0,f=1,g=e;break;case v:l=0,d=1,p=t,c=e-1,f=-1,g=-1;break;case b:l=t-1,d=-1,p=-1,c=0,f=1,g=e;break;case x:l=t-1,d=-1,p=-1,c=e-1,f=-1,g=-1}if(M)switch(E.pixel_size){case 8:h(m,c,f,g,l,d,p,i);break;case 16:u(m,c,f,g,l,d,p,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format")}else switch(E.pixel_size){case 8:r(m,c,f,g,l,d,p,i,a);break;case 16:s(m,c,f,g,l,d,p,i);break;case 24:n(m,c,f,g,l,d,p,i);break;case 32:o(m,c,f,g,l,d,p,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format")}return m}var c=0,d=1,f=2,p=3,g=9,m=10,_=11,D=48,y=4,v=0,x=1,w=2,b=3;e.byteLength<19&&console.error("TGAParser.parse: Not enough data to contain header.");var T=new Uint8Array(e),A=0,E={id_length:T[A++],colormap_type:T[A++],image_type:T[A++],colormap_index:T[A++]|T[A++]<<8,colormap_length:T[A++]|T[A++]<<8,colormap_size:T[A++],origin:[T[A++]|T[A++]<<8,T[A++]|T[A++]<<8],width:T[A++]|T[A++]<<8,height:T[A++]|T[A++]<<8,pixel_size:T[A++],flags:T[A++]};i(E),E.id_length+A>e.byteLength&&console.error("TGAParser.parse: No data"),A+=E.id_length;var L=!1,S=!1,M=!1;switch(E.image_type){case g:L=!0,S=!0;break;case d:S=!0;break;case m:L=!0;break;case f:break;case _:L=!0,M=!0;break;case p:M=!0}var P=a(L,S,E,A,T),R=l(E.width,E.height,P.pixel_data,P.palettes),C=new t.TextureBase;return C.internalFormat=t.InternalFormat.PixelArray,C.colorFormat=t.Egret3DDrive.ColorFormat_RGBA8888,C.mimapData.push(new t.MipmapData(R,E.width,E.height)),C},e}();t.TGAParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.DATA_FORMAT_STATIC_MODEL=1]="DATA_FORMAT_STATIC_MODEL",t[t.DATA_FORMAT_SKELETAL_ANIM_MODEL=2]="DATA_FORMAT_SKELETAL_ANIM_MODEL",t[t.DATA_FORMAT_EXPORT_MESH=4]="DATA_FORMAT_EXPORT_MESH",t[t.DATA_FORMAT_EXIST_VERTEX_POS=8]="DATA_FORMAT_EXIST_VERTEX_POS",t[t.DATA_FORMAT_EXIST_VERTEX_NORMAL=16]="DATA_FORMAT_EXIST_VERTEX_NORMAL",t[t.DATA_FORMAT_EXIST_VERTEX_TANGENT=32]="DATA_FORMAT_EXIST_VERTEX_TANGENT",t[t.DATA_FORMAT_EXIST_VERTEX_COLOR=64]="DATA_FORMAT_EXIST_VERTEX_COLOR",t[t.DATA_FORMAT_EXIST_VERTEX_UV1=128]="DATA_FORMAT_EXIST_VERTEX_UV1",t[t.DATA_FORMAT_EXIST_VERTEX_UV2=256]="DATA_FORMAT_EXIST_VERTEX_UV2",t[t.DATA_FORMAT_EXIST_SKELETAL_DATA=512]="DATA_FORMAT_EXIST_SKELETAL_DATA",t[t.DATA_FORMAT_EXIST_WEIGHTS_DATA=1024]="DATA_FORMAT_EXIST_WEIGHTS_DATA"}(t.ESMDataFormat||(t.ESMDataFormat={}));var e=t.ESMDataFormat,i=function(){function i(){}return i.parse=function(e){var a=new t.ByteArray(e),r=new t.GeometryData,s=a.readUnsignedInt(),n=s>>28&15,o=a.readUTF(),h="",u="";n>0&&(h=a.readUTF(),u=a.readUTF()),i.readMeshInfo(a,r,s,n);var l=new t.Skeleton;i.readBoneSkinInfo(a,r,l,n);var c;if(r.source_skinData.length>0){var d=new t.SkinGeometry;d.vertexAttLength=r.vertexAttLength=25,r=t.GeometryData.build(r),d.setGeomtryData(r.indices,r.vertexDatas,l),c=d}else{r=t.GeometryData.build(r);var f=new t.SubGeometry;f.setGeomtryData(r.indices,r.vertexDatas),c=f}return c.buildBoundBox(),c.textureFile=o,c.textureSpecular=h,c.textureBump=u,c},i.readMeshInfo=function(t,a,r,s){r&e.DATA_FORMAT_EXIST_VERTEX_POS&&i.readVertexInfo(t,a,s),r&e.DATA_FORMAT_EXIST_VERTEX_NORMAL&&i.readVertexNormalsInfo(t,a,s),r&e.DATA_FORMAT_EXIST_VERTEX_COLOR&&i.readVertexColorsInfo(t,a,s),r&e.DATA_FORMAT_EXIST_VERTEX_UV1&&i.readVertexUVInfo(t,a.source_uvData,s),r&e.DATA_FORMAT_EXIST_VERTEX_UV2&&i.readVertexUVInfo(t,a.source_uv2Data,s),i.readVertexIndexInfo(t,a,r,s)},i.readVertexInfo=function(e,i,a){for(var r=e.readInt(),s=0;r>s;s++)i.source_vertexData.push(new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat()))},i.readVertexNormalsInfo=function(e,i,a){for(var r=e.readInt(),s=0;r>s;s++)i.source_normalData.push(new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat()))},i.readVertexColorsInfo=function(e,i,a){for(var r=e.readInt(),s=0;r>s;s++)i.source_vertexColorData.push(new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat(),e.readFloat()))},i.readVertexUVInfo=function(e,i,a){for(var r=e.readInt(),s=0;r>s;s++)i.push(new t.UV(e.readFloat(),e.readFloat()))},i.readVertexIndexInfo=function(i,a,r,s){for(var n,o,h,u,l,c,d=i.readInt(),f=1,p=1,g=0;d>g;g++){var m=new t.FaceData;n=i.readUnsignedInt(),o=i.readUnsignedInt(),h=i.readUnsignedInt(),m.vertexIndices.push(n+1,o+1,h+1),r&e.DATA_FORMAT_EXIST_VERTEX_NORMAL&&m.normalIndices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1),r&e.DATA_FORMAT_EXIST_VERTEX_COLOR&&m.colorIndices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1),r&e.DATA_FORMAT_EXIST_VERTEX_UV1&&(s>=2?m.uvIndices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1):m.uvIndices.push(f++,f++,f++)),r&e.DATA_FORMAT_EXIST_VERTEX_UV2&&(s>=2?m.uv2Indices.push(i.readUnsignedInt()+1,i.readUnsignedInt()+1,i.readUnsignedInt()+1):m.uv2Indices.push(p++,p++,p++)),m.indexIds.push(String(n+1)+"/"+String(u+1)+"/"+String(n+1)),m.indexIds.push(String(o+1)+"/"+String(l+1)+"/"+String(o+1)),m.indexIds.push(String(h+1)+"/"+String(c+1)+"/"+String(h+1)),a.source_faceData.push(m)}},i.readBoneSkinInfo=function(t,e,a,r){i.readBoneInfo(t,a,r),i.readSkinInfo(t,e,r)},i.readBoneInfo=function(e,i,a){for(var r=e.readUnsignedByte(),s=(new t.Quaternion,new t.Vector3D),n=new t.Vector3D,o=new t.Vector3D,h=0;r>h;h++){var u=new t.Joint(null);e.readInt(),u.parentIndex=e.readInt(),u.name=e.readUTF(),s.x=e.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES,s.y=e.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES,s.z=e.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES,n.x=e.readFloat(),n.y=e.readFloat(),n.z=e.readFloat(),o.x=e.readFloat(),o.y=e.readFloat(),o.z=e.readFloat(),u.setInverseBindPose(o,s,n),i.joints.push(u)}},i.readSkinInfo=function(t,e,i){for(var a=t.readInt(),r=0,s=0,n=0;a>n;n++){for(var o=t.readUnsignedByte(),h=0;o>h;h++)r=t.readUnsignedByte(),s=t.readFloat(),e.source_skinData.push(r,s);for(var h=o;4>h;h++)r=0,s=0,e.source_skinData.push(r,s)}},i}();t.ESMParser=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var i=new t.ByteArray(e),a=i.readUnsignedByte(),r=i.readUTF(),s=i.readUnsignedByte();if(0>=a)return new t.SkeletonAnimationClip(r);for(var n=new Array,o=new Array,h=0;a>h;h++)n.push(i.readUTF()),o.push(i.readUTF());for(var u=i.readInt(),l=new Array,c=i.readInt(),h=0;c>h;h++){var d=new t.Skeleton;d.frameTime=i.readInt();for(var f=0;a>f;f++){var p=new t.Joint(n[f]);p.parent=o[f],p.setLocalTransform((new t.Quaternion).fromEulerAngles(i.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES,i.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES,i.readFloat()*t.Matrix3DUtils.RADIANS_TO_DEGREES),new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat()),new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat())),d.joints.push(p)}if(h>0){var g=new t.Skeleton;g.frameTime=d.frameTime-80;for(var m=l[l.length-1],f=0;a>f;f++){var p=new t.Joint(m.joints[f].name);p.parent=m.joints[f].parent,p.orientation=new t.Quaternion,p.orientation.lerp(m.joints[f].orientation,d.joints[f].orientation,.5),p.scale=new t.Vector3D,p.scale.lerp(m.joints[f].scale,d.joints[f].scale,.5),p.translation=new t.Vector3D,p.translation.lerp(m.joints[f].translation,d.joints[f].translation,.5),p.setLocalTransform(p.orientation,p.scale,p.translation),g.joints.push(p)}l.push(g)}l.push(d)}var _=new t.SkeletonAnimationClip(r);return _.sampling=s,_.frameCount=2*u,_.poseArray=l,_},e}();t.EAMParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){for(var i=new t.ByteArray(e),a=new t.CameraAnimationController,r=i.readUnsignedInt(),s=null,n=new t.Vector3D(1,1,1,1);r--;)s=new t.CameraAnimationFrame,s.time=i.readInt(),s.fov=i.readFloat(),s.rotation=new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat()),s.translation=new t.Vector3D(i.readFloat(),i.readFloat(),i.readFloat()),s.matrix=new t.Matrix4_4,s.matrix.recompose([s.translation,s.rotation,n]),a.cameraAnimationFrames.push(s);return a},e}();t.ECAParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.PVR=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.RGB_PVRTC_4BPPV1_Format=2100]="RGB_PVRTC_4BPPV1_Format",t[t.RGB_PVRTC_2BPPV1_Format=2101]="RGB_PVRTC_2BPPV1_Format",t[t.RGBA_PVRTC_4BPPV1_Format=2102]="RGBA_PVRTC_4BPPV1_Format",t[t.RGBA_PVRTC_2BPPV1_Format=2103]="RGBA_PVRTC_2BPPV1_Format"}(t.PVRFormat||(t.PVRFormat={}));var e=t.PVRFormat,i=function(){function i(){}return i.parse=function(e){var a=new t.PVR,r=13,s=new Uint32Array(e,0,r),n={buffer:e,header:s};return 55727696===s[0]?a=i._parseV3(n):559044176===s[11]?a=i._parseV2(n):console.log("PVRParser unknow pvr format. PVRParser::parse"),a},i._parseV2=function(t){var a,r,s=t.header,n=s[0],o=s[1],h=s[2],u=s[3],l=s[4],a=(s[5],s[6]),c=(s[7],s[8],s[9],s[10]),d=(s[11],s[12]),f=255,p=24,g=25,m=l&f,_=c>0;if(m===g)r=_?e.RGBA_PVRTC_4BPPV1_Format:e.RGB_PVRTC_4BPPV1_Format,a=4;else{if(m!==p)throw new Error("pvrtc - unknown format "+m);r=_?e.RGBA_PVRTC_2BPPV1_Format:e.RGB_PVRTC_2BPPV1_Format,a=2}return t.dataPtr=n,t.bpp=a,t.format=r,t.width=h,t.height=o,t.numSurfaces=d,t.numMipmaps=u+1,t.isCubemap=6===d,i._extract(t)},i._parseV3=function(t){var a,r,s=t.header,n=s[12],o=s[2],h=s[6],u=s[7],l=(s[9],s[10]),c=s[11];switch(o){case 0:a=2,r=e.RGB_PVRTC_2BPPV1_Format;break;case 1:a=2,r=e.RGBA_PVRTC_2BPPV1_Format;break;case 2:a=4,r=e.RGB_PVRTC_4BPPV1_Format;break;case 3:a=4,r=e.RGBA_PVRTC_4BPPV1_Format;break;default:throw new Error("pvrtc - unsupported PVR format "+o)}return t.dataPtr=52+n,t.bpp=a,t.format=r,t.width=u,t.height=h,t.numSurfaces=l,t.numMipmaps=c,t.isCubemap=6===l,i._extract(t)},i._extract=function(e){var i=new t.PVR,a=e.buffer,r=e.dataPtr,s=e.bpp,n=e.numSurfaces,o=0,h=0,u=0,l=0,c=0,d=0;2===s?(u=8,l=4):(u=4,l=4),h=u*l*s/8,i.mipmaps.length=e.numMipmaps*n;for(var f=0;f<e.numMipmaps;){var p=e.width>>f,g=e.height>>f;c=p/u,d=g/l,2>c&&(c=2),2>d&&(d=2),o=c*d*h;for(var m=0;n>m;m++){var _=new Uint8Array(a,r,o),D={data:_,width:p,height:g};i.mipmaps[m*e.numMipmaps+f]=D,r+=o}f++}return i},i}();t.PVRParser=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.loadList=[],this.completeCount=0,this.assets={},this.assetsModel={},this.assetsScene={},this.assetsTexture={},this.rootURL=""}return __extends(i,e),i.getInstance=function(){return i._instance},Object.defineProperty(i.prototype,"loadCompleteNumber",{get:function(){return this.completeCount},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"loadTotalNumber",{get:function(){return this.loadList.length},enumerable:!0,configurable:!0}),i.prototype.setRootURL=function(t){this.rootURL=t},i.prototype.findAssets=function(t){return this.assets[this.rootURL+t]},i.prototype.findModel=function(t){return this.assetsModel[this.rootURL+t]},i.prototype.findAnimModel=function(t){return this.assetsModel[this.rootURL+t]},i.prototype.findScene=function(t){return this.assetsScene[this.rootURL+t]},i.prototype.findTexture=function(t){return this.assetsTexture[this.rootURL+t]},i.prototype.startLoad=function(){for(var e=this,i=0;i<this.loadList.length;i++){var a=this.loadList[i];a.addEventListener(t.Event3D.EVENT_LOAD_COMPLETE,function(t){return e.checkComplete(t)}),a.load()}},i.prototype.addLoadModel=function(e,i){var a=new t.ModeLoader(this.rootURL+e,i);this.loadList.push(a)},i.prototype.addLoadAnimModel=function(e,i,a){var r=new t.ModeLoader(this.rootURL+e,i,a);this.loadList.push(r)},i.prototype.addLoadScene=function(e){var i=new t.SceneLoader(this.rootURL+e);this.loadList.push(i)},i.prototype.addLoadTexture=function(e){var i=new t.TextureLoader(this.rootURL+e);this.loadList.push(i)},i.prototype.checkComplete=function(e){var i=e.data;switch(i.type){case t.LoaderType.LOADER_MODEL_TYPE:var a=i;this.assets[a.url+a.esmFile]=a.mesh,this.assetsModel[a.url+a.esmFile]=a.mesh;break;case t.LoaderType.LOADER_SCENE_TYPE:this.assets[i.url]=i.meshList,this.assetsScene[i.url]=i.meshList;break;case t.LoaderType.LOADER_TEXTURE_TYPE:this.assets[i.url]=i.texture,this.assetsTexture[i.url]=i.texture}this.completeCount++,this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_PROGRESS,this)),this.completeCount>=this.loadList.length&&this.dispatchEvent(new t.Event3D(t.Event3D.EVENT_LOAD_COMPLETE,this))},i._instance=new i,i}(t.EventDispatcher);t.AssetsManager=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.pickObject3DList=function(e,i){var a=new Array,r=this.ray;r.CalculateAndTransformRay(t.Egret3DDrive.canvasRectangle.width,t.Egret3DDrive.canvasRectangle.height,e.modelMatrix,e.projectMatrix,t.Input.instance.mouseX,t.Input.instance.mouseY);for(var s=0;s<i.length;++s){var n=i[s];new t.Vector3D;switch(n.pickType){case t.PickType.BoundPick:if(null!=n.box&&r.IntersectMesh(n.box.vexData,n.box.indexData,3,n.box.indexData.length/3,0,n.modelMatrix,n.pickerData)){new t.PickResult;a.push(i[s])}break;case t.PickType.PositionPick:if(r.IntersectMeshEx(n,13,n.pickerData)){new t.PickResult;a.push(i[s])}break;case t.PickType.UVPick:if(r.IntersectMeshEx(n,13,n.pickerData)){new t.PickResult;a.push(i[s])}}}return a},e.ray=new t.Ray,e}();t.Picker=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===e&&(e=null),void 0===i&&(i=null),this._autoUpdate=!0,this._origin=new t.Vector3D(0,0,0),this._target=e,this._lookAtObject=i}return Object.defineProperty(e.prototype,"target",{get:function(){return this._target},set:function(t){this._target!=t&&(this._target=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){this._autoUpdate!=t&&(this._autoUpdate=t)},enumerable:!0,configurable:!0}),e.prototype.notifyUpdate=function(){},e.prototype.update=function(){},e}();t.ControllerBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){var r=this;void 0===i&&(i=null),void 0===a&&(a=null),e.call(this,i),this._origin=new t.Vector3D(0,0,0),this._lookAtPosition=new t.Vector3D,this._eyesPos=new t.Vector3D,this._up=t.Vector3D.Y_AXIS,this._eyesLength=0,this._rotaEyesLine=new t.Vector3D(0,0,1),this._rotaAngle=new t.Vector3D,this._matRot=new t.Matrix4_4,this._quaRot=new t.Quaternion,this._tempVec=new t.Vector3D,this._matTemp=new t.Matrix4_4,this._mouseDown=!1,this._mouseRightDown=!1,this._screenMoveStartDetail=new t.Point,this._screenMoveDelay=new t.Point,this._isUpdate=!1,this._elapsed=0,this._speed=3,this._xAngle=0,this._keyArray=new Array,this.lookAtOffset=new t.Vector3D(0,0,0),this.firstCamera=!1,this._keyArray.push(!1),this._keyArray.push(!1),this._keyArray.push(!1),this._keyArray.push(!1),a?this.lookAtObject=a:this.lookAtPosition=new t.Vector3D,this._eyesPos.copyFrom(i.position),this._lookAtPosition.copyFrom(a.position.add(this.lookAtOffset)),this._target.lookAt(this._eyesPos,this._lookAtPosition),t.Input.instance.addListenerMouseWheel(function(){return r.mouseWheel()}),t.Input.instance.addListenerMouseMove(function(){return r.mouseMove()}),t.Input.instance.addListenerKeyUp(function(t){return r.keyUp(t)}),t.Input.instance.addListenerKeyDown(function(t){return r.keyDown(t)}),t.Input.instance.addListenerSwipe(function(){return r.mouseMove()})}return __extends(i,e),i.prototype.mouseWheel=function(){this.setEyesLength(this._eyesLength-.1*t.Input.instance.wheelDelta)},i.prototype.mouseMove=function(){this._mouseDown&&(this._rotaAngle.y+=t.Input.instance.mouseOffsetX,this._rotaAngle.x+=t.Input.instance.mouseOffsetY,this._rotaAngle.y%=360,this._rotaAngle.x%=360)},Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtObject&&(this._lookAtObject=null),this._lookAtPosition.copyFrom(t.add(this.lookAtOffset)),this.notifyUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lookAtObject",{get:function(){return this._lookAtObject},set:function(t){this._lookAtObject!=t&&(this._lookAtObject=t,this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset)),this.notifyUpdate())},enumerable:!0,configurable:!0}),i.prototype.setEyesLength=function(t){this._eyesLength=t,this._eyesLength<1&&(this._eyesLength=1)},Object.defineProperty(i.prototype,"rotationX",{set:function(t){this._rotaAngle.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotationY",{set:function(t){this._rotaAngle.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotationZ",{set:function(t){this._rotaAngle.z=t},enumerable:!0,configurable:!0}),i.prototype.update=function(){if(this._target){if(0==this._target.isController)return;this._keyArray[0]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[1]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._matTemp.identity(),this._matTemp.appendRotation(90,t.Vector3D.Y_AXIS),this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec)),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[2]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[3]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._matTemp.identity(),this._matTemp.appendRotation(90,t.Vector3D.Y_AXIS),this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec)),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec)),this._lookAtObject.position=this._tempVec),this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._rotaEyesLine.copyFrom(this._quaRot.rotatePoint(t.Vector3D.Z_AXIS)),this._rotaEyesLine.normalize(),this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.scaleBy(this._eyesLength),this._eyesPos.copyFrom(this._lookAtPosition.subtract(this._tempVec)),this._lookAtObject&&this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset)),this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,this._rotaAngle.z),this._tempVec.copyFrom(this._up),this._tempVec.copyFrom(this._quaRot.rotatePoint(this._tempVec)),this._tempVec.normalize(),this.firstCamera&&(this._lookAtObject.rotationY=this._rotaAngle.y,this._lookAtObject.rotationX=this._rotaAngle.x),this._target.lookAt(this._eyesPos,this._lookAtPosition,this._tempVec)}},i.prototype.keyDown=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=!0;break;case t.KeyCode.Key_A:this._keyArray[1]=!0;break;case t.KeyCode.Key_S:this._keyArray[2]=!0;break;case t.KeyCode.Key_D:this._keyArray[3]=!0;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=!0;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=!0}},i.prototype.keyUp=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=!1;break;case t.KeyCode.Key_A:this._keyArray[1]=!1;break;case t.KeyCode.Key_S:this._keyArray[2]=!1;break;case t.KeyCode.Key_D:this._keyArray[3]=!1;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=!1;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=!1}},i}(t.ControllerBase);t.LookAtController=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,s,n,o,h,u,l,c,d,f){var p=this;void 0===i&&(i=null),void 0===a&&(a=null),void 0===r&&(r=0),void 0===s&&(s=90),void 0===n&&(n=100),void 0===o&&(o=-90),void 0===h&&(h=90),void 0===u&&(u=0/0),void 0===l&&(l=0/0),void 0===c&&(c=8),void 0===d&&(d=2),void 0===f&&(f=!1),e.call(this,i,a),this._currentPanAngle=0,this._currentTiltAngle=90,this._panAngle=0,this._tiltAngle=90,this._distance=1e3,this._minPanAngle=-(1/0),this._maxPanAngle=1/0,this._minTiltAngle=-90,this._maxTiltAngle=90,this._maxDistance=5e3,this._minDistance=-5e3,this._steps=8,this._yFactor=2,this._wrapPanAngle=!1,this._lookAtPosition=new t.Vector3D(0,0,0),this._mouseDown=!1,this._mouseRightDown=!1,this._keyArray=new Array,this.distance=n,this.panAngle=r,this.tiltAngle=s,this.minPanAngle=u||-(1/0),this.maxPanAngle=l||1/0,this.minTiltAngle=o,this.maxTiltAngle=h,this.steps=c,this.yFactor=d,this.wrapPanAngle=f,this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle,t.Input.instance.addListenerMouseMove(function(){return p.mouseMove()}),t.Input.instance.addListenerKeyUp(function(t){return p.keyUp(t)}),t.Input.instance.addListenerKeyDown(function(t){return p.keyDown(t)}),t.Input.instance.addListenerMouseWheel(function(){return p.mouseWheel()}),t.Input.instance.addListenerSwipe(function(){return p.mouseMove()})}return __extends(i,e),i.prototype.mouseWheel=function(){this._distance-=.1*t.Input.instance.wheelDelta,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))},i.prototype.keyDown=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=!0;break;case t.KeyCode.Key_A:this._keyArray[1]=!0;break;case t.KeyCode.Key_S:this._keyArray[2]=!0;break;case t.KeyCode.Key_D:this._keyArray[3]=!0;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=!0;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=!0}},i.prototype.keyUp=function(e){switch(e){case t.KeyCode.Key_W:this._keyArray[0]=!1;break;case t.KeyCode.Key_A:this._keyArray[1]=!1;break;case t.KeyCode.Key_S:this._keyArray[2]=!1;break;case t.KeyCode.Key_D:this._keyArray[3]=!1;break;case t.KeyCode.Key_Mouse_Left:this._mouseDown=!1;break;case t.KeyCode.Key_Mouse_Right:this._mouseRightDown=!1}},i.prototype.mouseMove=function(){this._mouseDown&&(this._tiltAngle+=.1*t.Input.instance.mouseOffsetY,this._tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)),this._panAngle+=.1*t.Input.instance.mouseOffsetX,this._panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtPosition=t,this.notifyUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"steps",{get:function(){return this._steps},set:function(t){t=1>t?1:t,this._steps!=t&&(this._steps=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"panAngle",{get:function(){return this._panAngle},set:function(t){t=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,t)),this._panAngle!=t&&(this._panAngle=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(t){t=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,t)),this._tiltAngle!=t&&(this._tiltAngle=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"distance",{get:function(){return this._distance},set:function(t){this._distance!=t&&(this._distance=this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,t)),this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(t){this._minPanAngle!=t&&(this._minPanAngle=t,this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(t){this._maxPanAngle!=t&&(this._maxPanAngle=t,this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(t){this._minTiltAngle!=t&&(this._minTiltAngle=t,this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(t){this._maxTiltAngle!=t&&(this._maxTiltAngle=t,this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance!=t&&(this._maxDistance=t,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._maxDistance},set:function(t){this._minDistance!=t&&(this._minDistance=t,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"yFactor",{get:function(){return this._yFactor},set:function(t){this._yFactor!=t&&(this._yFactor=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(t){this._wrapPanAngle!=t&&(this._wrapPanAngle=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),i.prototype.update=function(e){void 0===e&&(e=!0),(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle)&&(this.notifyUpdate(),this._wrapPanAngle&&(this._panAngle<0?this._panAngle=this._panAngle%360+360:this._panAngle=this._panAngle%360,this._panAngle-this._currentPanAngle<-180?this._currentPanAngle-=360:this._panAngle-this._currentPanAngle>180&&(this._currentPanAngle+=360)),e?(this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this.steps+1),this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this.steps+1)):(this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle),Math.abs(this._tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01&&(this._currentTiltAngle=this._tiltAngle,this._currentPanAngle=this._panAngle));var i=this._lookAtObject?this._lookAtObject.position:this._lookAtPosition?this._lookAtPosition:this._origin,a=new t.Vector3D;a.x=i.x+this.distance*Math.sin(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS),a.z=i.z+this.distance*Math.cos(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS),a.y=i.y+this.distance*Math.sin(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS)*this.yFactor,this._target&&this._lookAtPosition&&this._target.lookAt(a,this._lookAtPosition)},i}(t.ControllerBase);t.HoverController=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=null),this.cameraAnimationFrames=[],this._playing=!1,this._playTime=0,this._currentFrameIndex=0,this._loop=!0,this._smooth=!1,this._cameraAnimationFrame=new i,this._camera=e,this._cameraAnimationFrame.fov=45,this._cameraAnimationFrame.rotation=new t.Vector3D,this._cameraAnimationFrame.translation=new t.Vector3D}return e.prototype.bindCamera=function(t){this._camera=t},e.prototype.play=function(t){this.cameraAnimationFrames.length<=0||(this._loop=t,this._playTime=0,this._camera.isController=!1,this._playing=!0)},e.prototype.update=function(e,i){if(this._playing){this._playTime+=10*i;var a=this._playTime%(this.cameraAnimationFrames[this.cameraAnimationFrames.length-1].time-this.cameraAnimationFrames[0].time+160),r=Math.floor(a/160)%this.cameraAnimationFrames.length;!this._loop&&this._currentFrameIndex>r&&(this._playing=!1,this._camera.isController=!0),this._currentFrameIndex=r;var s=this.cameraAnimationFrames[r];if(this._smooth){var n=(r+1)%this.cameraAnimationFrames.length,o=this.cameraAnimationFrames[n],h=(a-s.time)/Math.abs(o.time-s.time);this._cameraAnimationFrame.fov=(o.fov-s.fov)*h+s.fov,this._cameraAnimationFrame.rotation.copyFrom(s.rotation),this._cameraAnimationFrame.translation.lerp(s.translation,o.translation,h)}else this._cameraAnimationFrame.fov=s.fov,this._cameraAnimationFrame.rotation.copyFrom(s.rotation),this._cameraAnimationFrame.translation.copyFrom(s.translation);this._camera.fieldOfView=this._cameraAnimationFrame.fov,this._camera.rotationX=this._cameraAnimationFrame.rotation.x*t.Matrix3DUtils.RADIANS_TO_DEGREES+90,this._camera.rotationY=this._cameraAnimationFrame.rotation.y*t.Matrix3DUtils.RADIANS_TO_DEGREES,this._camera.rotationZ=this._cameraAnimationFrame.rotation.z*t.Matrix3DUtils.RADIANS_TO_DEGREES,this._camera.position=this._cameraAnimationFrame.translation}},e}();t.CameraAnimationController=e;var i=function(){function t(){}return t}();t.CameraAnimationFrame=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._animation={}}return e.prototype.play=function(e,i,a){var r=this;if(void 0!=this._animation[e])this._animation[e].bindCamera(i),this._animation[e].play(a);else{var s=new t.URLLoader;s.onLoadComplete=function(t){return r.onCallback(t,e,i,a)},s.load(e)}},e.prototype.update=function(t,e){for(var i in this._animation)this._animation[i].update(t,e)},e.prototype.onCallback=function(t,e,i,a){this._animation[e]=t.data,this._animation[e].bindCamera(i),this._animation[e].play(a)},e}();t.CameraAnimationManager=e}(egret3d||(egret3d={}));var DeviceUtil=function(){function t(){}return t.getDeviceInfo=function(){return null},Object.defineProperty(t,"getGPUMode",{get:function(){return egret3d.Egret3DDrive.OpenGLES_2_0},enumerable:!0,configurable:!0}),t}(),egret3d;!function(t){var e=function(){function t(){}return t.LITTLE_ENDIAN="littleEndian",t.BIG_ENDIAN="bigEndian",t}();t.Endian=e;var i=function(){function t(t){this.BUFFER_EXT_SIZE=0,this.EOF_byte=-1,this.EOF_code_point=-1,this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE)),this.endian=e.BIG_ENDIAN}return t.prototype._setArrayBuffer=function(t){this.write_position=t.byteLength,this.data=new DataView(t),this._position=0},Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer},set:function(t){this.data=new DataView(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.data=t,this.write_position=t.byteLength},enumerable:!0,configurable:!0}),t.prototype.uncompress=function(t){void 0===t&&(t="7z")
},Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position<t&&!this.validate(t-this._position)||(this._position=t,this.write_position=t>this.write_position?t:this.write_position)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.validateBuffer(t,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))},t.prototype.readBoolean=function(){return this.validate(t.SIZE_OF_BOOLEAN)?0!=this.data.getUint8(this.position++):null},t.prototype.readByte=function(){return this.validate(t.SIZE_OF_INT8)?this.data.getInt8(this.position++):null},t.prototype.readBytes=function(e,i,a){if(void 0===i&&(i=0),void 0===a&&(a=0),0==a)a=this.bytesAvailable;else if(!this.validate(a))return null;e?e.validateBuffer(a):e=new t(new ArrayBuffer(a));for(var r=0;a>r;r++)e.data.setUint8(r+i,this.data.getUint8(this.position++))},t.prototype.readDouble=function(){if(!this.validate(t.SIZE_OF_FLOAT64))return null;var i=this.data.getFloat64(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT64,i},t.prototype.readFloat=function(){if(!this.validate(t.SIZE_OF_FLOAT32))return null;var i=this.data.getFloat32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT32,i},t.prototype.readInt=function(){if(!this.validate(t.SIZE_OF_INT32))return null;var i=this.data.getInt32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT32,i},t.prototype.readShort=function(){if(!this.validate(t.SIZE_OF_INT16))return null;var i=this.data.getInt16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT16,i},t.prototype.readUnsignedByte=function(){return this.validate(t.SIZE_OF_UINT8)?this.data.getUint8(this.position++):null},t.prototype.readUnsignedInt=function(){if(!this.validate(t.SIZE_OF_UINT32))return null;var i=this.data.getUint32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT32,i},t.prototype.readUnsignedShort=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,i},t.prototype.readUTF=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,i>0?this.readUTFBytes(i):""},t.prototype.readUTFBytes=function(t){if(!this.validate(t))return null;var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);return this.position+=t,this.decodeUTF8(e)},t.prototype.writeBoolean=function(e){this.validateBuffer(t.SIZE_OF_BOOLEAN),this.data.setUint8(this.position++,e?1:0)},t.prototype.writeByte=function(e){this.validateBuffer(t.SIZE_OF_INT8),this.data.setInt8(this.position++,e)},t.prototype.writeBytes=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var a;if(!(0>e)&&!(0>i)&&(a=0==i?t.length-e:Math.min(t.length-e,i),a>0)){this.validateBuffer(a);for(var r=new DataView(t.buffer),s=e;a+e>s;s++)this.data.setUint8(this.position++,r.getUint8(s))}},t.prototype.writeDouble=function(i){this.validateBuffer(t.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT64},t.prototype.writeFloat=function(i){this.validateBuffer(t.SIZE_OF_FLOAT32),this.data.setFloat32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT32},t.prototype.writeInt=function(i){this.validateBuffer(t.SIZE_OF_INT32),this.data.setInt32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT32},t.prototype.writeShort=function(i){this.validateBuffer(t.SIZE_OF_INT16),this.data.setInt16(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT16},t.prototype.writeUnsignedInt=function(i){this.validateBuffer(t.SIZE_OF_UINT32),this.data.setUint32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT32},t.prototype.writeUTF=function(i){var a=this.encodeUTF8(i),r=a.length;this.validateBuffer(t.SIZE_OF_UINT16+r),this.data.setUint16(this.position,r,this.endian===e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT16,this._writeUint8Array(a,!1)},t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))},t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable},t.prototype._writeUint8Array=function(t,e){void 0===e&&(e=!0),e&&this.validateBuffer(this.position+t.length);for(var i=0;i<t.length;i++)this.data.setUint8(this.position++,t[i])},t.prototype.validate=function(t){return this.data.byteLength>0&&this._position+t<=this.data.byteLength?!0:void 0},t.prototype.validateBuffer=function(t,e){if(void 0===e&&(e=!1),this.write_position=t>this.write_position?t:this.write_position,t+=this._position,this.data.byteLength<t||e){var i=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE)),a=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE);i.set(new Uint8Array(this.data.buffer,0,a)),this.buffer=i.buffer}},t.prototype.encodeUTF8=function(t){for(var e=0,i=this.stringToCodePoints(t),a=[];i.length>e;){var r=i[e++];if(this.inRange(r,55296,57343))this.encoderError(r);else if(this.inRange(r,0,127))a.push(r);else{var s,n;for(this.inRange(r,128,2047)?(s=1,n=192):this.inRange(r,2048,65535)?(s=2,n=224):this.inRange(r,65536,1114111)&&(s=3,n=240),a.push(this.div(r,Math.pow(64,s))+n);s>0;){var o=this.div(r,Math.pow(64,s-1));a.push(128+o%64),s-=1}}}return new Uint8Array(a)},t.prototype.decodeUTF8=function(t){for(var e,i=!1,a=0,r="",s=0,n=0,o=0,h=0;t.length>a;){var u=t[a++];if(u===this.EOF_byte)e=0!==n?this.decoderError(i):this.EOF_code_point;else if(0===n)this.inRange(u,0,127)?e=u:(this.inRange(u,194,223)?(n=1,h=128,s=u-192):this.inRange(u,224,239)?(n=2,h=2048,s=u-224):this.inRange(u,240,244)?(n=3,h=65536,s=u-240):this.decoderError(i),s*=Math.pow(64,n),e=null);else if(this.inRange(u,128,191))if(o+=1,s+=(u-128)*Math.pow(64,n-o),o!==n)e=null;else{var l=s,c=h;s=0,n=0,o=0,h=0,e=this.inRange(l,c,1114111)&&!this.inRange(l,55296,57343)?l:this.decoderError(i,u)}else s=0,n=0,o=0,h=0,a--,e=this.decoderError(i,u);null!==e&&e!==this.EOF_code_point&&(65535>=e?e>0&&(r+=String.fromCharCode(e)):(e-=65536,r+=String.fromCharCode(55296+(e>>10&1023)),r+=String.fromCharCode(56320+(1023&e))))}return r},t.prototype.encoderError=function(t){},t.prototype.decoderError=function(t,e){return e||65533},t.prototype.inRange=function(t,e,i){return t>=e&&i>=t},t.prototype.div=function(t,e){return Math.floor(t/e)},t.prototype.stringToCodePoints=function(t){for(var e=[],i=0,a=t.length;i<t.length;){var r=t.charCodeAt(i);if(this.inRange(r,55296,57343))if(this.inRange(r,56320,57343))e.push(65533);else if(i===a-1)e.push(65533);else{var s=t.charCodeAt(i+1);if(this.inRange(s,56320,57343)){var n=1023&r,o=1023&s;i+=1,e.push(65536+(n<<10)+o)}else e.push(65533)}else e.push(r);i+=1}return e},t.SIZE_OF_BOOLEAN=1,t.SIZE_OF_INT8=1,t.SIZE_OF_INT16=2,t.SIZE_OF_INT32=4,t.SIZE_OF_UINT8=1,t.SIZE_OF_UINT16=2,t.SIZE_OF_UINT32=4,t.SIZE_OF_FLOAT32=4,t.SIZE_OF_FLOAT64=8,t}();t.ByteArray=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.parseContent=function(t){for(var e=new Array,i="",a=";",r=-1,s=0;s<t.length;++s)if("{"==t.charAt(s)&&(r=i.indexOf("="),0>r&&(a="}")),(""!=i||" "!=t.charAt(s)&&"    "!=t.charAt(s))&&(i+=t.charAt(s),a==t.charAt(s))){if("}"==a){for(var n=0,o=0,h=0;h<i.length;++h)"{"==i.charAt(h)?n++:"}"==i.charAt(h)&&o++;if(n!=o)continue;if(i.indexOf("struct")>=0){a=";";continue}}i.length>0&&e.push(i),i="",a=";"}return e},t.parseLines=function(t){for(var e=new Array,i="",a=0;a<t.length;++a)if(" "!=t.charAt(a)&&"	"!=t.charAt(a)&&","!=t.charAt(a)&&"\r"!=t.charAt(a)&&"\n"!=t.charAt(a)){if(";"==t.charAt(a)){i.length>0&&(e.push(i),i=""),e.push(";");break}if("="==t.charAt(a)){i.length>0&&(e.push(i),i=""),e.push("=");continue}i+=t.charAt(a),a==t.length-1&&""!=t&&(e.push(i),i="")}else""!=i&&(e.push(i),i="");return e},t.hasString=function(t,e){for(var i=0;i<t.length;++i)if(t[i]==e)return!0;return!1},t.getVarName=function(t){var e=this.hasString(t,"=");return e?t.length-4>=0&&t.length-4<t.length?t[t.length-4]:"":t.length-2>=0&&t.length-2<t.length?t[t.length-2]:""},t.getVarValue=function(t){var e=this.hasString(t,"=");return e&&t.length-2>=0&&t.length-2<t.length?t[t.length-2]:""},t.getVarType=function(t){var e=this.hasString(t,"=");return e?t.length-5>=0&&t.length-5<t.length?t[t.length-5]:"":t.length-3>=0&&t.length-3<t.length?t[t.length-3]:""},t.getVarKey=function(t){var e=this.hasString(t,"=");return e?t.length>5?t[0]:"":t.length>3?t[0]:""},t.processShaderFile=function(t){var e=["\n","\r"];e=[];for(var i=t,a=i;;){var r=i.indexOf("//");if(0>r)break;var s=i.indexOf("\r\n",r);-1==s&&(s=i.indexOf("\n",r));var n=i.slice(r,s);if(i=i.replace(n,""),i==a)break;a=i}for(var o=0;o<e.length;++o)for(;;){if(a=i.replace(e[o],""),i==a)break;i=a}return i},t.colorRgb=function(t){var e=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,i=t.toLowerCase();if(i&&e.test(i)){if(4===i.length){for(var a="#",r=1;4>r;r+=1)a+=i.slice(r,r+1).concat(i.slice(r,r+1));i=a}for(var s=[],r=1;7>r;r+=2)s.push(parseInt("0x"+i.slice(r,r+2)));return"RGB("+s.join(",")+")"}return i},t}();t.StringUtil=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.isDebug=!1,this._console=document.createElement("console"),document.body.appendChild(this._console),this._console.style.color="red",this._console.style.zIndex="1000",this._console.style.position="absolute",this._console.style.top="10px",this._console.style.left="10px"}return t.prototype.trace=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(this.isDebug){this.reset();for(var i=t.length,a=0;i>a;a++)this._console.innerHTML+=t[a]+"</br>"}},t.prototype.reset=function(){this._console.innerHTML=""},Object.defineProperty(t,"instance",{get:function(){return null==this._instance&&(this._instance=new t),this._instance},enumerable:!0,configurable:!0}),t._instance=null,t}();t.Debug=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.vertexData=[.5,0,0,-.5,0,0],this.vertexCount=2,this.vertexLength=3,this.vertexBytes=12,this.isDrawLine=!0,this.isDrawPoint=!0,this.pointSize=1,this.pointColor=new t.Vector3D(1,1,1,1),this.lineColor=new t.Vector3D(1,1,1,1),this.usage=new t.MethodUsageData,this.vsShader=new t.GLSL.ShaderBase(null,this.usage),this.fsShader=new t.GLSL.ShaderBase(null,this.usage),this.setShader("wireframe_vertex","wireframe_fragment")}return __extends(i,e),i.prototype.createFromGeometry=function(t){},i.prototype.createFromData=function(t){},i.prototype.createFromArray=function(t){},i.prototype.setVertexPos=function(t,e){var i=t*this.vertexLength;i+2>=this.vertexData.length||(this.vertexData[i]=e.x,this.vertexData[i+1]=e.y,this.vertexData[i+2]=e.z)},i.prototype.setShader=function(t,e){this.vsShader.addShader(t),this.fsShader.addShader(e),this.vsShaderSource=this.vsShader.getShaderSource(),this.fsShaderSource=this.fsShader.getShaderSource()},i.prototype.draw=function(e,i){this.usage.program3D||this.rebuild(e),e.enbable(e.gl.DEPTH_TEST),e.setBlendFactors(t.Egret3DDrive.ONE,t.Egret3DDrive.ZERO),e.setProgram(this.usage.program3D),e.bindVertexBuffer(this.vertexBuffer3D),e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,this.vertexBytes,0),e.uniformMatrix4fv(this.usage.uniform_ModelMatrix.uniformIndex,!1,this.modelMatrix.rawData),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,i.viewProjectionMatrix.rawData),this.isDrawLine&&(e.uniform4fv(this.uniform_color,[this.lineColor.x,this.lineColor.y,this.lineColor.z,this.lineColor.w]),e.drawArrays(t.DrawMode.LINES,0,this.vertexCount)),this.isDrawPoint&&(e.uniform4fv(this.uniform_color,[this.pointColor.x,this.pointColor.y,this.pointColor.z,this.pointColor.w]),e.uniform1f(this.uniform_pointSize,this.pointSize),e.drawArrays(t.DrawMode.POINTS,0,this.vertexCount))},i.prototype.rebuild=function(t){var e=t.creatVertexShader(this.vsShaderSource),i=t.creatFragmentShader(this.fsShaderSource);this.usage.program3D=t.creatProgram(e,i),this.usage.program3D&&t.setProgram(this.usage.program3D),this.vertexBuffer3D||(this.vertexBuffer3D=t.creatVertexBuffer(this.vertexData)),this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(this.usage.program3D,"attribute_position"),this.usage.uniform_ModelMatrix.uniformIndex=t.getUniformLocation(this.usage.program3D,"uniform_ModelMatrix"),this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix"),this.uniform_color=t.getUniformLocation(this.usage.program3D,"uniform_color"),this.uniform_pointSize=t.getUniformLocation(this.usage.program3D,"uniform_pointSize")},i}(t.Object3D);t.WireframeBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.createFromData=function(t){return t.length%3!=0?void console.log("error: vertexData.length % 3 != 0"):(this.vertexData=[],this.vertexCount=0,this.vertexData=t.slice(0,t.length),void(this.vertexCount=this.vertexData.length/3))},e.prototype.createFromArray=function(t){if(t.length%3!=0)return void console.log("error: vertexData.length % 3 != 0");this.vertexData=[],this.vertexCount=0;for(var e=0;e<t.length;++e)this.vertexData.push(t[e].x),this.vertexData.push(t[e].y),this.vertexData.push(t[e].z);this.vertexCount=this.vertexData.length},e}(t.WireframeBase);t.WireframeLine=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this)}return __extends(i,e),i.prototype.createByMesh=function(t){this.createFromGeometry(t.geometry),t.addChild(this)},i.prototype.createFromGeometry=function(e){this.vertexData=[],this.vertexCount=0;for(var i=new t.Vector3D,a=new t.Vector3D,r=new t.Vector3D,s=0;s<e.indexData.length/3;++s){var n=e.indexData[3*s+0],o=e.indexData[3*s+1],h=e.indexData[3*s+2];i.x=e.verticesData[n*e.vertexAttLength],i.y=e.verticesData[n*e.vertexAttLength+1],i.z=e.verticesData[n*e.vertexAttLength+2],a.x=e.verticesData[o*e.vertexAttLength],a.y=e.verticesData[o*e.vertexAttLength+1],a.z=e.verticesData[o*e.vertexAttLength+2],r.x=e.verticesData[h*e.vertexAttLength],r.y=e.verticesData[h*e.vertexAttLength+1],r.z=e.verticesData[h*e.vertexAttLength+2],this.vertexData.push(i.x,i.y,i.z,a.x,a.y,a.z,a.x,a.y,a.z,r.x,r.y,r.z,r.x,r.y,r.z,i.x,i.y,i.z),this.vertexCount+=6}},i}(t.WireframeBase);t.WireframeMesh=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===e&&(e="postCanvas_vertex"),void 0===i&&(i="postCanvas_fragment"),this.rectangle=new t.Rectangle(0,0,0,0),this.distortion=!1,this.distortionK1=.5,this.uniformDistortionK=new t.Vector3D,this.transformChange=!0,this.position=new t.Vector3D,this.rotation=new t.Vector3D,this.scale=new t.Vector3D(1,1,1),this.px=0,this.py=0,this._viewMatrix=new t.Matrix4_4,this.setShader(e,i)}return Object.defineProperty(e.prototype,"x",{get:function(){return this.rectangle.x},set:function(t){this.rectangle.x!=t&&(this.rectangle.x=t,this.transformChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.rectangle.y},set:function(t){this.rectangle.y!=t&&(this.rectangle.y=t,this.transformChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.rectangle.width},set:function(t){this.rectangle.width!=t&&(this.rectangle.width=t,this.transformChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.rectangle.height},set:function(t){this.rectangle.height!=t&&(this.rectangle.height=t,this.transformChange=!0)},enumerable:!0,configurable:!0}),e.prototype.startWarped=function(){this.distortion=!0;var t=0,e=0,i=Math.sqrt(this.viewPort.height/2*(this.viewPort.height/2)+this.viewPort.width/2*(this.viewPort.width/2)),a=this.viewPort.height/2/i;e=a/(a+this.distortionK1*a*a*a);var r=this.viewPort.width/2/i;t=r/(r+this.distortionK1*r*r*r),this.uniformDistortionK.x=this.distortionK1,this.uniformDistortionK.y=t,this.uniformDistortionK.z=e},e.prototype.setShader=function(e,i){this.usage=new t.MethodUsageData,this.vsShader=new t.GLSL.ShaderBase(null,this.usage),this.fsShader=new t.GLSL.ShaderBase(null,this.usage),this.vsShader.addShader(e),this.fsShader.addShader(i),this.vsShaderSource=this.vsShader.getShaderSource(),this.fsShaderSource=this.fsShader.getShaderSource()},e.prototype.rebuild=function(t){var i=t.creatVertexShader(this.vsShaderSource),a=t.creatFragmentShader(this.fsShaderSource);this.usage.program3D=t.creatProgram(i,a),this.usage.program3D&&t.setProgram(this.usage.program3D),this.vertexBuffer3D||(this.vertexBuffer3D=t.creatVertexBuffer(e.singleQuadData),this.indexBuffer3D=t.creatIndexBuffer(e.singleQuadIndex)),this.usage.attribute_position.uniformIndex=t.getShaderAttribLocation(this.usage.program3D,"attribute_position"),this.usage.attribute_uv0.uniformIndex=t.getShaderAttribLocation(this.usage.program3D,"attribute_uv0"),this.usage.uniform_ProjectionMatrix.uniformIndex=t.getUniformLocation(this.usage.program3D,"uniform_ProjectionMatrix"),this.distortion&&(this.distortionK1Register=t.getUniformLocation(this.usage.program3D,"_K")),this.usage.uniform_sceneWidth&&(this.usage.uniform_sceneWidth.uniformIndex=t.getUniformLocation(this.usage.program3D,this.usage.uniform_sceneWidth.varName)),this.usage.uniform_sceneHeight&&(this.usage.uniform_sceneHeight.uniformIndex=t.getUniformLocation(this.usage.program3D,this.usage.uniform_sceneHeight.varName));var r;for(var s in this.usage.sampler2DList)r=this.usage.sampler2DList[s],r.uniformIndex=t.getUniformLocation(this.usage.program3D,r.varName);var n;for(var s in this.usage.sampler3DList)n=this.usage.sampler3DList[s],n.uniformIndex=t.getUniformLocation(this.usage.program3D,n.varName)},e.prototype.draw=function(e,i){this.viewPort=i,this.transformChange&&this.notifyUpdate(),this.usage.program3D||this.rebuild(e),e.viewPort(i.x,i.y,i.width,i.height),e.disable(e.gl.DEPTH_TEST),e.disable(e.gl.BLEND),e.setProgram(this.usage.program3D),e.bindVertexBuffer(this.vertexBuffer3D),e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_position.uniformIndex,3,t.Egret3DDrive.FLOAT,!1,20,0),e.vertexAttribPointer(this.usage.program3D,this.usage.attribute_uv0.uniformIndex,2,t.Egret3DDrive.FLOAT,!1,20,12),e.uniformMatrix4fv(this.usage.uniform_ProjectionMatrix.uniformIndex,!1,this._viewMatrix.rawData),this.distortion&&e.uniform3f(this.distortionK1Register,this.uniformDistortionK.x,this.uniformDistortionK.y,this.uniformDistortionK.z),this.usage.uniform_sceneWidth&&e.uniform1f(this.usage.uniform_sceneWidth.uniformIndex,this.viewPort.width),this.usage.uniform_sceneHeight&&e.uniform1f(this.usage.uniform_sceneHeight.uniformIndex,this.viewPort.height);var a;for(var r in this.usage.sampler2DList)a=this.usage.sampler2DList[r],"texture2D_1"==a.varName?e.setTexture2DAt(a.activeTextureIndex,a.uniformIndex,a.index,this.texture.texture):"texture2D_2"==a.varName&&e.setTexture2DAt(a.activeTextureIndex,a.uniformIndex,a.index,this.texture2.texture);e.drawElement(t.DrawMode.TRIANGLES,this.indexBuffer3D,0,6)},e.prototype.notifyUpdate=function(){this.transformChange=!1,this._viewMatrix.identity(),this.position.x=-1,this.position.y=1,this.scale.x=this.rectangle.width/this.viewPort.width*2,this.scale.y=this.rectangle.height/this.viewPort.height*2,this._viewMatrix.recompose([this.position,this.rotation,this.scale])},e.singleQuadData=[0,-1,0,0,0,1,-1,0,1,0,1,0,0,1,1,0,0,0,0,1],e.singleQuadIndex=[0,1,2,0,2,3],e}();t.PostCanvas=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.rectangle=new t.Rectangle(0,0,0,0),this.anchor=new t.Vector3D(.5,.5),this.rotation=new t.Vector3D,this.r=1,this.g=1,this.b=1,this.a=1,this.uvRectangle=new t.Rectangle(0,0,1,1),this.rectangle.x=0,this.rectangle.y=0,this.rectangle.width=100,this.rectangle.height=100,this._viewMatrix=new t.Matrix4_4,this.quadShader=new i}return Object.defineProperty(e.prototype,"x",{get:function(){return this.rectangle.x},set:function(t){this.rectangle.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.rectangle.y},set:function(t){this.rectangle.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.rectangle.width},set:function(t){this.rectangle.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.rectangle.height},set:function(t){this.rectangle.height=t},enumerable:!0,configurable:!0}),e.prototype.rebuild=function(t){var i=t.creatVertexShader(this.quadShader.vertexShaderSource),a=t.creatFragmentShader(this.quadShader.fragmentShaderSource);this.shaderProgram=t.creatProgram(i,a),this.shaderProgram&&t.setProgram(this.shaderProgram),this.vertexBuffer3D||(this.vertexBuffer3D=t.creatVertexBuffer(e.singleQuadData),this.indexBuffer3D=t.creatIndexBuffer(e.singleQuadIndex)),this.posAtt=t.getShaderAttribLocation(this.shaderProgram,"aVertexPosition"),this.uvAtt=t.getShaderAttribLocation(this.shaderProgram,"aTextureCoord"),this.viewMatIndex=t.getUniformLocation(this.shaderProgram,"viewProjectionMatrix"),this.uiDataIndex=t.getUniformLocation(this.shaderProgram,"uiDatas"),this.textureIndex=t.getUniformLocation(this.shaderProgram,"diffuseTexture"),this.materialDataIndex=t.getUniformLocation(this.shaderProgram,"materialData")},e.prototype.draw=function(e){this.shaderProgram||this.rebuild(e),this.viewPort=t.Egret3DDrive.canvasRectangle,this._viewMatrix.identity();var i=new t.Matrix4_4;this._viewMatrix.appendRotation(this.rotation.z,t.Vector3D.Z_AXIS),i.appendScale(this.rectangle.width/this.viewPort.width*2,this.rectangle.height/this.viewPort.height*2,1),this._viewMatrix.append(i);var a=(this.viewPort.width-2*(this.rectangle.x+this.rectangle.width/2))*(1/this.viewPort.width),r=(this.viewPort.height-2*(this.rectangle.y+this.rectangle.height/2))*(1/this.viewPort.height);this._viewMatrix.appendTranslation(-a,r,0),e.setProgram(this.shaderProgram),e.bindVertexBuffer(this.vertexBuffer3D),e.vertexAttribPointer(this.shaderProgram,this.posAtt,3,t.Egret3DDrive.FLOAT,!1,20,0),e.vertexAttribPointer(this.shaderProgram,this.uvAtt,2,t.Egret3DDrive.FLOAT,!1,20,12),e.uniformMatrix4fv(this.viewMatIndex,!1,this._viewMatrix.rawData),this.texture.upload(e),e.setTexture2DAt(t.ContextSamplerType.TEXTURE_0,this.textureIndex,0,this.texture.texture),e.uniform4fv(this.materialDataIndex,[this.r,this.g,this.b,this.a]),e.enbable(t.Egret3DDrive.BLEND),e.setBlendFactors(t.Egret3DDrive.SRC_ALPHA,t.Egret3DDrive.ONE_MINUS_SRC_ALPHA),e.drawElement(t.DrawMode.TRIANGLES,this.indexBuffer3D,0,6),e.gl.clear(t.Egret3DDrive.DEPTH_BUFFER_BIT)},e.singleQuadData=[-.5,-.5,0,0,1,.5,-.5,0,1,1,.5,.5,0,1,0,-.5,.5,0,0,0],e.singleQuadIndex=[0,1,2,0,2,3],e}();t.HUD=e;var i=function(){function t(){this.vertexShaderSource="",this.fragmentShaderSource="",this.vertexShaderSource="precision mediump float; \n",this.vertexShaderSource+=" attribute vec3 aVertexPosition;                                                                       \n ",this.vertexShaderSource+=" attribute vec2 aTextureCoord;                                                                         \n ",this.vertexShaderSource+="                                                                                                       \n ",this.vertexShaderSource+=" varying  vec2 vTextureCoord;                                                                      \n ",this.vertexShaderSource+=" uniform  mat4 viewProjectionMatrix;                                                                      \n ",this.vertexShaderSource+=" uniform  vec4 uiDatas[116];                                                                      \n ",this.vertexShaderSource+="  void main(void) {                                                                                      \n ",this.vertexShaderSource+="     vec4 pos = vec4(aVertexPosition.xyz, 1.0) ;                                    \n ",this.vertexShaderSource+="     gl_Position = viewProjectionMatrix * pos;                                    \n ",this.vertexShaderSource+="     vTextureCoord = aTextureCoord ;                                                                       \n ",this.vertexShaderSource+=" }                                                                                                     \n ",this.fragmentShaderSource=" precision mediump float; \n",this.fragmentShaderSource+=" varying  vec2 vTextureCoord;                                                                      \n ",this.fragmentShaderSource+=" uniform sampler2D diffuseTexture;                                                                      \n ",this.fragmentShaderSource+=" uniform vec4 materialData;                                                                      \n ",this.fragmentShaderSource+="  void main(void) {                                                                                      \n ",this.fragmentShaderSource+="      vec4 color  = texture2D(diffuseTexture,vTextureCoord) * materialData ;                                    \n ",this.fragmentShaderSource+="      gl_FragColor  = color;                                    \n ",this.fragmentShaderSource+="}                        \n "}return t}()}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.rec=new t.Rectangle}return e.prototype.init=function(e,i,a){this.nextFrameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.defaultFrameBuffer,e,i,a,t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this.rec.width=i,this.rec.height=a},e.prototype.drawToTarget=function(t,e,i,a){},e}();t.PostEffectBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.postCanvas=new t.PostCanvas("postCanvas_vertex","BrightPassFilter")}return __extends(i,e),i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,!0,0),this.postCanvas.width=this.rec.width,this.postCanvas.height=this.rec.height,this.postCanvas.texture=e.texture,this.postCanvas.draw(i,this.rec)},i}(t.PostEffectBase);t.BrightPost=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.postCanvas=new t.PostCanvas("postCanvas_vertex","GaussianBlurHorizontal")}return __extends(i,e),i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,!0,0),this.postCanvas.width=this.rec.width,this.postCanvas.height=this.rec.height,this.postCanvas.texture=e.texture,this.postCanvas.draw(i,this.rec)},i}(t.PostEffectBase);t.GaussianBlurHorizontalPost=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.postCanvas=new t.PostCanvas("postCanvas_vertex","GaussianBlurVertical")}return __extends(i,e),i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,!0,0),this.postCanvas.width=this.rec.width,this.postCanvas.height=this.rec.height,this.postCanvas.texture=e.texture,this.postCanvas.draw(i,this.rec)},i}(t.PostEffectBase);t.GaussianBlurVerticalPost=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.postCanvas=new t.PostCanvas("postCanvas_vertex","Composition")}return __extends(i,e),i.prototype.drawToTarget=function(t,e,i,a){i.setRenderToTexture(this.nextFrameBuffer.texture.texture,!0,0),this.postCanvas.width=this.rec.width,this.postCanvas.height=this.rec.height,this.postCanvas.texture=e.texture,this.postCanvas.texture2=t.texture,this.postCanvas.draw(i,this.rec)},i}(t.PostEffectBase);t.Composition=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.postCanvas=new t.PostCanvas("postCanvas_vertex","Tonemaping")}return __extends(i,e),i.prototype.drawToTarget=function(t,e,i,a){this.postCanvas.width=this.rec.width,this.postCanvas.height=this.rec.height,this.postCanvas.texture=t.texture,this.postCanvas.texture2=e.texture,this.postCanvas.draw(i,this.rec)},i}(t.PostEffectBase);t.Tonemaping=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.lumAdapt=0,this.lum=1,this.brightPost=new t.BrightPost,this.gaussianBlurHorizontalPost=new t.GaussianBlurHorizontalPost,this.gaussianBlurVerticalPost=new t.GaussianBlurVerticalPost,this.composition=new t.Composition,this.toneMap=new t.Tonemaping}return __extends(i,e),i.prototype.init=function(t,e,i){this.brightPost.init(t,e,i),this.gaussianBlurHorizontalPost.init(t,e,i),this.gaussianBlurVerticalPost.init(t,e,i),this.composition.init(t,e,i),this.toneMap.init(t,e,i)},i.prototype.drawToTarget=function(t,e,i,a){this.lumAdapt+=(this.lum-this.lumAdapt)*(1-Math.pow(.98,480));var r=t;this.brightPost.drawToTarget(t,r,i,a),r=this.brightPost.nextFrameBuffer,this.nextFrameBuffer=this.brightPost.nextFrameBuffer,this.gaussianBlurHorizontalPost.drawToTarget(t,r,i,a),r=this.gaussianBlurHorizontalPost.nextFrameBuffer,this.gaussianBlurVerticalPost.drawToTarget(t,r,i,a),r=this.gaussianBlurVerticalPost.nextFrameBuffer,this.nextFrameBuffer=r,this.composition.drawToTarget(t,r,i,a),this.nextFrameBuffer=this.composition.nextFrameBuffer,i.setRenderToBackBuffer()},i}(t.PostEffectBase);t.HDR=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===i&&(i=null),this._width=0,this._height=0,this._x=0,this._y=0,this._localPos=new t.Point,this._globalPos=new t.Point,this._aspectRatio=1,this._scissorRectDirty=!0,this._viewportDirty=!0,this._viewPortMatrix=new t.Matrix4_4,this._useShadow=!1,this._isDeferred=!1,this._resizeFuncs=new Array,this._wireframeList=new Array,this._hudList=new Array,this._context3D=t.Egret3DDrive.context3D,this._camera=i||new t.Camera3D(t.CameraType.perspective),this._scissorRect=new t.Rectangle,this._viewPort=e,this._scene=new t.Scene3D,this._render=t.RenderManager.getRender(t.RenderType.defaultRender),this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this._mouseEventManager=new t.Mouse3DManager(this._camera)}return Object.defineProperty(e.prototype,"root",{get:function(){return this._scene},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,i,a,r){this.x=this.viewPort.x=e,this.y=this.viewPort.y=i,this.width=this.viewPort.width=a,this.height=this.viewPort.height=r,t.Egret3DDrive.canvas.width=this.viewPort.width,t.Egret3DDrive.canvas.height=this.viewPort.height,t.Egret3DDrive.canvasRectangle.x=this.x,t.Egret3DDrive.canvasRectangle.y=this.y,t.Egret3DDrive.canvasRectangle.width=this.width,t.Egret3DDrive.canvasRectangle.height=this.height,this._backImg&&(this._backImg.x=e,this._backImg.y=i,this._backImg.width=a,this._backImg.height=r),this.updateViewSizeData()},Object.defineProperty(e.prototype,"render",{set:function(t){this._render=t,"GBufferRender"==typeof t?this._isDeferred=!0:this._isDeferred=!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useShadow",{get:function(){return this._useShadow},set:function(e){this._useShadow=e,e&&(this._shadowRender=new t.ShadowRender)},enumerable:!0,configurable:!0}),e.prototype.requestFrameBuffer=function(){this._isDeferred||(this._postCanvas=new t.PostCanvas)},e.prototype.addListenerResize=function(t){this._resizeFuncs.push(t)},Object.defineProperty(e.prototype,"viewPort",{get:function(){return this._viewPort
},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sky",{get:function(){return this._sky},set:function(t){this._sky=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sphereSky",{set:function(t){this._sphereSky=t},enumerable:!0,configurable:!0}),e.prototype.addHUD=function(t){-1==this._hudList.indexOf(t)&&this._hudList.push(t)},e.prototype.delHUD=function(t){var e=this._hudList.indexOf(t);this._hudList.splice(e,1)},e.prototype.addWireframe=function(t){this._wireframeList.push(t)},e.prototype.delWireframe=function(t){var e=this._wireframeList.indexOf(t);this._wireframeList.splice(e,1)},Object.defineProperty(e.prototype,"backImageTexture",{set:function(e){this._backImg||(this._backImg=new t.HUD,this._backImg.x=0,this._backImg.y=0,this._backImg.width=this.width,this._backImg.height=this.height),e.upload(this._context3D),this._backImg.texture=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"postEffect",{set:function(e){if(e){this._postCanvas=this._postCanvas||new t.PostCanvas,this._postList=e;for(var i=0;i<this._postList.length;i++)this._postList[i].init(this._context3D,512,512);this._sourceFrameBuffer=this._sourceFrameBuffer||t.RttManager.creatFrameBuffer(t.FrameBufferType.defaultFrameBuffer,this._context3D,512,512,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"camera3D",{get:function(){return this._camera},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context3D",{get:function(){return this._context3D},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t,this._aspectRatio=this._width/this._height,this._camera.aspectRatio=this._aspectRatio,this._scissorRect.width=t,this._scissorRectDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t,this._aspectRatio=this._width/this._height,this._camera.aspectRatio=this._aspectRatio,this._scissorRect.height=t,this._scissorRectDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(t){this._x!=t&&(this._localPos.x=this._x=t,this._globalPos.x=t,this._globalPosDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(t){this._y!=t&&(this._localPos.y=t,this._globalPos.y=t,this._globalPosDirty=!0)},enumerable:!0,configurable:!0}),e.prototype.addChild3D=function(t){this._scene.addChild(t)},e.prototype.update=function(e,i){if(this.updateViewSizeData(),this._scene.collect.update(this._camera),this._mouseEventManager.update(this._scene.collect),this._context3D.gl.enable(t.Egret3DDrive.BLEND),this._context3D.gl.enable(t.Egret3DDrive.CULL_FACE),this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._context3D.clear(0,0,0,1),this._backImg&&this._backImg.draw(this._context3D),this._context3D.clearDepth(1),this._context3D.clearStencil(0),this._isDeferred)this._context3D.clearDepth(1),this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort);else if(this._postList){this._useShadow&&t.RttManager.drawToTexture(e,i,t.ShadowRender.frameBuffer.texture.texture,this._context3D,this._shadowRender,this._scene.collect,this._camera,this.viewPort),this._sky?this._sky.draw(this._context3D,this.camera3D):this._sphereSky&&this._sphereSky.draw(this._context3D,this.camera3D),t.RttManager.drawToTexture(e,i,this._sourceFrameBuffer.texture.texture,this._context3D,this._render,this._scene.collect,this._camera,this.viewPort),this._context3D.clearDepth(1);for(var a=this._sourceFrameBuffer,r=0;r<this._postList.length;r++)this._postList[r].drawToTarget(this._sourceFrameBuffer,a,this._context3D,this._viewPort),a=this._postList[r].nextFrameBuffer;this._postCanvas.width=this._viewPort.width,this._postCanvas.height=this._viewPort.height,this._postCanvas.texture=a.texture,this._postCanvas.draw(this._context3D,this._viewPort)}else this._sky?this._sky.draw(this._context3D,this.camera3D):this._sphereSky&&this._sphereSky.draw(this._context3D,this.camera3D),this._useShadow&&t.RttManager.drawToTexture(e,i,t.ShadowRender.frameBuffer.texture.texture,this._context3D,this._shadowRender,this._scene.collect,this._camera,this.viewPort),this._context3D.clearDepth(1),this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort);for(var r=0;r<this._wireframeList.length;r++)this._wireframeList[r].draw(this._context3D,this.camera3D);for(var r=0;r<this._hudList.length;r++)this._hudList[r].draw(this._context3D);this._context3D.gl.finish()},e.prototype.updateViewSizeData=function(){this._camera.aspectRatio=this._aspectRatio,this._scissorRectDirty&&(this._scissorRectDirty=!1,this._camera.updateScissorRect(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height)),this._viewportDirty&&(this._viewportDirty=!1,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height))},e.prototype.setTags=function(t,e){this._scene.collect.setTags(t,e)},e.prototype.setTagsItem=function(t,e){this._scene.collect.setTagsItem(t,e)},e.prototype.getTagLayer=function(t,e){return void 0===t&&(t="default"),void 0===e&&(e="layer_0"),this._scene.collect.getTagLayer(t,e)},e.prototype.getTag=function(t){return void 0===t&&(t="default"),this._scene.collect.getTag(t)},e}();t.View3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this,i,new t.Camera3D(t.CameraType.VR)),this.leftViewPort=new t.Rectangle,this.rightViewPort=new t.Rectangle,this.tab=!1,this.eyeMatrix=new t.EyesMatrix,this.leftViewPort.x=this.viewPort.x,this.leftViewPort.y=this.viewPort.y,this.leftViewPort.width=this.viewPort.width,this.leftViewPort.height=this.viewPort.height,this.rightViewPort.x=this.leftViewPort.width,this.rightViewPort.y=this.viewPort.y,this.rightViewPort.width=.5*this.viewPort.width,this.rightViewPort.height=this.viewPort.height,this.setupVR()}return __extends(i,e),i.prototype.requestFrameBuffer=function(){},i.prototype.setupVR=function(){this._isDeferred||(this._leftCanvas=new t.PostCanvas("postCanvas_vertex","warpedImage_fragment"),this._rightCanvas=new t.PostCanvas("postCanvas_vertex","warpedImage_fragment"),this._leftCanvas.rectangle.x=0,this._leftCanvas.rectangle.y=0,this._leftCanvas.rectangle.width=480,this._leftCanvas.rectangle.height=.9375*this.viewPort.height,this._rightCanvas.rectangle.x=510,this._rightCanvas.rectangle.y=0,this._rightCanvas.rectangle.width=480,this._rightCanvas.rectangle.height=.9375*this.viewPort.height,this._leftCanvas.startWarped(),this._rightCanvas.startWarped(),this._leftFrameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.leftEyeFrameBuffer,this._context3D,1024,1024,t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this._rightFrameBuffer=t.RttManager.creatFrameBuffer(t.FrameBufferType.rightEyeFrameBuffer,this._context3D,1024,1024,t.FrameBufferFormat.UNSIGNED_BYTE_RGB))},i.prototype.setEyesSpace=function(t){this._leftCanvas.x=75,this._leftCanvas.y=0,this._leftCanvas.width=512,this._leftCanvas.height=512,this._rightCanvas.x=75,this._rightCanvas.y=512+t,this._rightCanvas.width=512,this._rightCanvas.height=512},i.prototype.update=function(i,a){e.prototype.updateViewSizeData.call(this),this._scene.collect.update(this._camera),this._context3D.gl.enable(t.Egret3DDrive.BLEND),this._context3D.gl.enable(t.Egret3DDrive.CULL_FACE),this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._context3D.clear(0,0,0,1),this.leftEye(i,a),this.rightEye(i,a),this._context3D.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._leftCanvas.texture=this._leftFrameBuffer.texture,this._rightCanvas.texture=this._leftFrameBuffer.texture,this._leftCanvas.draw(this._context3D,this._viewPort),this._rightCanvas.draw(this._context3D,this._viewPort);for(var r=0;r<this._hudList.length;r++)this._hudList[r].draw(this._context3D);this._context3D.gl.finish()},i.prototype.leftEye=function(e,i){this._context3D.viewPort(this.leftViewPort.x,this.leftViewPort.y,this.leftViewPort.width,this.leftViewPort.height),this._camera.tap(t.CameraType.VR,t.VRType.left),this._context3D.setRenderToTexture(this._leftFrameBuffer.texture.texture,!0,0),this._sky&&this._sky.draw(this._context3D,this.camera3D),this._sphereSky&&this._sphereSky.draw(this._context3D,this.camera3D),this._context3D.clearDepth(1),this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort),this._context3D.setRenderToBackBuffer()},i.prototype.rightEye=function(e,i){this._context3D.viewPort(this.rightViewPort.x,this.rightViewPort.y,this.rightViewPort.width,this.rightViewPort.height),this._camera.tap(t.CameraType.VR,t.VRType.right),this._context3D.setRenderToTexture(this._rightFrameBuffer.texture.texture,!0,0),this._sky&&this._sky.draw(this._context3D,this.camera3D),this._sphereSky&&this._sphereSky.draw(this._context3D,this.camera3D),this._context3D.clearDepth(1),this._render.draw(e,i,this._context3D,this._scene.collect,this._camera,this._viewPort),this._context3D.setRenderToBackBuffer()},i}(t.View3D);t.VRView3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.Key_BackSpace=8]="Key_BackSpace",t[t.Key_Tab=9]="Key_Tab",t[t.Key_Clear=10]="Key_Clear",t[t.Key_Enter=11]="Key_Enter",t[t.Key_Shift_L=12]="Key_Shift_L",t[t.Key_Control_L=13]="Key_Control_L",t[t.Key_Alt_L=14]="Key_Alt_L",t[t.Key_Pause=15]="Key_Pause",t[t.Key_CapsLock=16]="Key_CapsLock",t[t.Key_Escape=17]="Key_Escape",t[t.Key_Space=18]="Key_Space",t[t.Key_Prior=19]="Key_Prior",t[t.Key_Next=20]="Key_Next",t[t.Key_End=21]="Key_End",t[t.Key_Home=22]="Key_Home",t[t.Key_Left=23]="Key_Left",t[t.Key_Up=24]="Key_Up",t[t.Key_Right=25]="Key_Right",t[t.Key_Down=26]="Key_Down",t[t.Key_Select=27]="Key_Select",t[t.Key_Print=28]="Key_Print",t[t.Key_Execute=29]="Key_Execute",t[t.Key_Insert=30]="Key_Insert",t[t.Key_Delete=31]="Key_Delete",t[t.Key_Help=32]="Key_Help",t[t.Key_0=48]="Key_0",t[t.Key_1=49]="Key_1",t[t.Key_2=50]="Key_2",t[t.Key_3=51]="Key_3",t[t.Key_4=52]="Key_4",t[t.Key_5=53]="Key_5",t[t.Key_6=54]="Key_6",t[t.Key_7=55]="Key_7",t[t.Key_8=56]="Key_8",t[t.Key_9=57]="Key_9",t[t.Key_A=65]="Key_A",t[t.Key_B=66]="Key_B",t[t.Key_C=67]="Key_C",t[t.Key_D=68]="Key_D",t[t.Key_E=69]="Key_E",t[t.Key_F=70]="Key_F",t[t.Key_G=71]="Key_G",t[t.Key_H=72]="Key_H",t[t.Key_I=73]="Key_I",t[t.Key_J=74]="Key_J",t[t.Key_K=75]="Key_K",t[t.Key_L=76]="Key_L",t[t.Key_M=77]="Key_M",t[t.Key_N=78]="Key_N",t[t.Key_O=79]="Key_O",t[t.Key_P=80]="Key_P",t[t.Key_Q=81]="Key_Q",t[t.Key_R=82]="Key_R",t[t.Key_S=83]="Key_S",t[t.Key_T=84]="Key_T",t[t.Key_U=85]="Key_U",t[t.Key_V=86]="Key_V",t[t.Key_W=87]="Key_W",t[t.Key_X=88]="Key_X",t[t.Key_Y=89]="Key_Y",t[t.Key_Z=90]="Key_Z",t[t.Key_KP_0=96]="Key_KP_0",t[t.Key_KP_1=97]="Key_KP_1",t[t.Key_KP_2=98]="Key_KP_2",t[t.Key_KP_3=99]="Key_KP_3",t[t.Key_KP_4=100]="Key_KP_4",t[t.Key_KP_5=101]="Key_KP_5",t[t.Key_KP_6=102]="Key_KP_6",t[t.Key_KP_7=103]="Key_KP_7",t[t.Key_KP_8=104]="Key_KP_8",t[t.Key_KP_9=105]="Key_KP_9",t[t.Key_Multiply=106]="Key_Multiply",t[t.Key_Add=107]="Key_Add",t[t.Key_Separator=108]="Key_Separator",t[t.Key_Subtract=109]="Key_Subtract",t[t.Key_Decimal=110]="Key_Decimal",t[t.Key_Divide=111]="Key_Divide",t[t.Key_F1=112]="Key_F1",t[t.Key_F2=113]="Key_F2",t[t.Key_F3=114]="Key_F3",t[t.Key_F4=115]="Key_F4",t[t.Key_F5=116]="Key_F5",t[t.Key_F6=117]="Key_F6",t[t.Key_F7=118]="Key_F7",t[t.Key_F8=119]="Key_F8",t[t.Key_F9=120]="Key_F9",t[t.Key_F10=121]="Key_F10",t[t.Key_F11=122]="Key_F11",t[t.Key_F12=123]="Key_F12",t[t.Key_F13=124]="Key_F13",t[t.Key_F14=125]="Key_F14",t[t.Key_F15=126]="Key_F15",t[t.Key_F16=127]="Key_F16",t[t.Key_F17=128]="Key_F17",t[t.Key_F18=129]="Key_F18",t[t.Key_F19=130]="Key_F19",t[t.Key_F20=131]="Key_F20",t[t.Key_F21=132]="Key_F21",t[t.Key_F22=133]="Key_F22",t[t.Key_F23=134]="Key_F23",t[t.Key_F24=135]="Key_F24",t[t.Key_Num_Lock=136]="Key_Num_Lock",t[t.Key_Scroll_Lock=137]="Key_Scroll_Lock",t[t.Key_Mouse_Left=256]="Key_Mouse_Left",t[t.Key_Mouse_Right=257]="Key_Mouse_Right",t[t.Key_Mouse_Mid=258]="Key_Mouse_Mid"}(t.KeyCode||(t.KeyCode={}));var e=t.KeyCode,i=function(){function i(){var e=this;this.mouseX=0,this.mouseY=0,this.wheelDelta=0,this.mouseOffsetX=0,this.mouseOffsetY=0,this.mouseLastX=0,this.mouseLastY=0,this._time=0,this._keyStatus={},this._listenerKeyClick=new Array,this._listenerKeyUp=new Array,this._listenerKeyDown=new Array,this._listenerSwipe=null,this._mouseMoveFunc=new Array,this._mouseWheelFunc=new Array,this._ondeviceorientation=new Array,this._ondevicemotion=new Array,this._listenerGamepadButtons=new Array,this._touchStartCallback=new Array,this._touchEndCallback=new Array,this._touchMoveCallback=new Array,this.onGamepadStick1=null,this.onGamepadStick2=null,this.rotation=new t.Vector3D,this._acceleration=new t.Vector3D,this.gravity=new t.Vector3D,this.quadrant=0,this._gp=!1,this._first=!0,this._initAngle=new t.Vector3D,this._oldPosition1=null,this._oldPosition2=null,window.onmousewheel=function(t){return e.mouseWheel(t)},window.onmousedown=function(t){return e.mouseStart(t)},window.onmouseup=function(t){return e.mouseEnd(t)},window.onmousemove=function(t){return e.mouseMove(t)},window.onkeydown=function(t){return e.keyDown(t)},window.onkeyup=function(t){return e.keyUp(t)},this.canGame()&&(window.addEventListener("gamepadconnected",function(t){return e.ongamepadconnected(t)}),window.addEventListener("gamepaddisconnected",function(t){return e.ongamepaddisconnected(t)})),window.ontouchstart=function(t){return e.touchStart(t)},window.ontouchend=function(t){return e.touchEnd(t)},window.ontouchmove=function(t){return e.touchMove(t)},window.ontouchcancel=function(t){return e.touchEnd(t)},window.addEventListener("deviceorientation",function(t){return e.ondeviceorientation(t)}),window.addEventListener("devicemotion",function(t){return e.detectShake(t)})}return Object.defineProperty(i,"instance",{get:function(){return null==this._instance&&(this._instance=new i),this._instance},enumerable:!0,configurable:!0}),i.prototype.addTouchStartCallback=function(t){this._touchStartCallback.push(t)},i.prototype.addTouchEndCallback=function(t){this._touchEndCallback.push(t)},i.prototype.addTouchMoveCallback=function(t){this._touchMoveCallback.push(t)},i.prototype.ongamepaddisconnected=function(e){t.Debug.instance.trace("Gamepad disconnected!"),this._gp=!1},i.prototype.ongamepadconnected=function(e){t.Debug.instance.trace("Gamepad connected!"),this._gp=!0},i.prototype.getGamepadButtonState=function(t){return navigator.getGamepads()[0].buttons[t].pressed},i.prototype.getGamepadStick1=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[0],navigator.getGamepads()[0].axes[1],0)},i.prototype.getGamepadStick2=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[2],navigator.getGamepads()[0].axes[3],0)},i.prototype.canGame=function(){return"getGamepads"in navigator},i.prototype.reportOnGamepad=function(){if(this.canGame()&&this._gp){null!=this.onGamepadStick1&&this.onGamepadStick1(this.getGamepadStick1()),null!=this.onGamepadStick2&&this.onGamepadStick2(this.getGamepadStick2());for(var t=0;t<this._listenerGamepadButtons.length;++t)this._listenerGamepadButtons[t](this.getGamepadButtonState(t))}},i.prototype.printout=function(){var e="";e+="id: "+navigator.getGamepads()[0].id+"<br/>";for(var i=navigator.getGamepads()[0].buttons.length,a=0;i>a;a++)e+="Button "+(a+1)+": ",this.getGamepadButtonState(a)&&(e+=" pressed"),e+="<br/>";var r=this.getGamepadStick1();e+="Stick 1: "+r.x+","+r.y+"<br/>",r=this.getGamepadStick2(),e+="Stick 2: "+r.x+","+r.y+"<br/>",t.Debug.instance.trace(e)},i.prototype.detectShake=function(t){var e=t.acceleration;if(e.x>1.5||e.y>1.5||e.z>1.5,this._ondevicemotion&&this._ondevicemotion.length>0){var i=Math.ceil(1e3*e.x)/1e3,a=Math.ceil(1e3*e.y)/1e3,r=Math.ceil(1e3*e.z)/1e3;this._ondevicemotion[0](i,a,r)}},i.prototype.ondeviceorientation=function(t){if(this._ondeviceorientation&&this._ondeviceorientation.length>0){var e=.01*Math.round(100*t.alpha),i=.01*Math.round(100*t.beta),a=.01*Math.round(100*t.gamma);this._first&&(this._initAngle.x=e,this._initAngle.y=i,this._initAngle.z=a),this._delayX=e-this._caheX,this._delayY=i-this._caheY,this._delayZ=a-this._caheZ,this._caheX=e,this._caheY=i,this._caheZ=a,this._initAngle.x+=this._delayX,this._initAngle.y+=this._delayY,this._initAngle.z+=this._delayZ,this._ondeviceorientation[0](this._initAngle)}},i.prototype.onorientationchange=function(t){},i.prototype.onPinch=function(e,i,a,r){this._oldPosition1=new t.Point(e,i),this._oldPosition2=new t.Point(a,r)},i.prototype.onSwipe=function(t,i){this.mouseX=t,this.mouseY=i,this._oldPosition1=null,this._oldPosition2=null,this._time=(new Date).getTime();for(var a=0;a<this._listenerKeyDown.length;++a)this._listenerKeyDown[a](e.Key_Mouse_Left)},i.prototype.touchStart=function(e){e.preventDefault();var i=e.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left,a=e.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top;if(2==e.targetTouches.length){var r=e.targetTouches[1].clientX-t.Egret3DDrive.clientRect.left,s=e.targetTouches[1].clientY-t.Egret3DDrive.clientRect.top;this.onPinch(i,a,r,s)}else 1==e.targetTouches.length&&this.onSwipe(i,a);for(var n=0;n<this._touchStartCallback.length;n++)this._touchStartCallback[n](e)},i.prototype.touchEnd=function(i){if(i.targetTouches.length>1){var a=i.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left,r=i.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top,s=i.targetTouches[1].clientX-t.Egret3DDrive.clientRect.left,n=i.targetTouches[1].clientY-t.Egret3DDrive.clientRect.top;this.onPinch(a,r,s,n)}else if(1==i.targetTouches.length)this.onSwipe(i.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left,i.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top);else{this._oldPosition1=null,this._oldPosition2=null,this._time=0;for(var o=0;o<this._listenerKeyUp.length;++o)this._listenerKeyUp[o](e.Key_Mouse_Left)}for(var o=0;o<this._touchEndCallback.length;o++)this._touchEndCallback[o](i)},i.prototype.touchMove=function(e){if(this.mouseLastX=this.mouseX,this.mouseLastY=this.mouseY,this.mouseX=e.targetTouches[0].clientX-t.Egret3DDrive.clientRect.left,this.mouseY=e.targetTouches[0].clientY-t.Egret3DDrive.clientRect.top,this.mouseOffsetX=this.mouseX-this.mouseLastX,this.mouseOffsetY=this.mouseY-this.mouseLastY,e.preventDefault(),e.targetTouches.length>1){var i=new t.Point(this.mouseX,this.mouseY),a=new t.Point(e.targetTouches[1].clientX-t.Egret3DDrive.clientRect.left,e.targetTouches[1].clientY-t.Egret3DDrive.clientRect.top);null==this._oldPosition1&&(this._oldPosition1=i),null==this._oldPosition2&&(this._oldPosition2=a),this.isEnlarge(this._oldPosition1,this._oldPosition2,i,a)?this.wheelDelta=120:this.wheelDelta=-120,this._oldPosition1=i,this._oldPosition2=a;for(var r=0;r<this._mouseWheelFunc.length;++r)this._mouseWheelFunc[r]()}else this._listenerSwipe();for(var r=0;r<this._touchMoveCallback.length;r++)this._touchMoveCallback[r](e)},i.prototype.addListenerMouseMove=function(t){this._mouseMoveFunc.push(t)},i.prototype.addListenerMouseWheel=function(t){this._mouseWheelFunc.push(t)},i.prototype.addListenerKeyClick=function(t){this._listenerKeyClick.push(t)},i.prototype.addListenerKeyUp=function(t){this._listenerKeyUp.push(t)},i.prototype.addListenerKeyDown=function(t){this._listenerKeyDown.push(t)},i.prototype.addListenerSwipe=function(t){this._listenerSwipe=t},i.prototype.addListenerDeviceorientation=function(t){this._ondeviceorientation.push(t)},i.prototype.addListenerDevicemotion=function(t){this._ondevicemotion.push(t)},i.prototype.addListenerGamePadButtons=function(t){this._listenerGamepadButtons.push(t)},i.prototype.mouseEnd=function(i){this.mouseX=i.clientX-t.Egret3DDrive.clientRect.left,this.mouseY=i.clientY-t.Egret3DDrive.clientRect.top;var a=0;switch(i.button){case 0:a=e.Key_Mouse_Left;break;case 2:a=e.Key_Mouse_Right;break;case 1:a=e.Key_Mouse_Mid}if(0!=a){if(this._keyStatus[a])for(var r=0;r<this._listenerKeyClick.length;++r)this._listenerKeyClick[r](a);this._keyStatus[a]=!1;for(var r=0;r<this._listenerKeyUp.length;++r)this._listenerKeyUp[r](a)}},i.prototype.mouseStart=function(i){this.mouseX=i.clientX-t.Egret3DDrive.clientRect.left,this.mouseY=i.clientY-t.Egret3DDrive.clientRect.top;var a=0;switch(i.button){case 0:a=e.Key_Mouse_Left;break;case 2:a=e.Key_Mouse_Right;break;case 1:a=e.Key_Mouse_Mid}if(0!=a){this._keyStatus[a]=!0;for(var r=0;r<this._listenerKeyDown.length;++r)this._listenerKeyDown[r](a)}},i.prototype.mouseMove=function(e){this.mouseLastX=this.mouseX,this.mouseLastY=this.mouseY,this.mouseX=e.clientX-t.Egret3DDrive.clientRect.left,this.mouseY=e.clientY-t.Egret3DDrive.clientRect.top,this.mouseOffsetX=this.mouseX-this.mouseLastX,this.mouseOffsetY=this.mouseY-this.mouseLastY;for(var i=0;i<this._mouseMoveFunc.length;++i)this._mouseMoveFunc[i](e)},i.prototype.mouseWheel=function(t){this.wheelDelta=t.wheelDelta;for(var e=0;e<this._mouseWheelFunc.length;++e)this._mouseWheelFunc[e]()},i.prototype.keyDown=function(t){this._keyStatus[t.keyCode]=!0;for(var e=0;e<this._listenerKeyDown.length;++e)this._listenerKeyDown[e](t.keyCode)},i.prototype.keyUp=function(t){if(this._keyStatus[t.keyCode])for(var e=0;e<this._listenerKeyClick.length;++e)this._listenerKeyClick[e](t.keyCode);this._keyStatus[t.keyCode]=!1;for(var e=0;e<this._listenerKeyUp.length;++e)this._listenerKeyUp[e](t.keyCode)},i.prototype.GetSlideAngle=function(t,e){return 180*Math.atan2(e,t)/Math.PI},i.prototype.GetSlideDirection=function(t,e,i,a){var r=e-a,s=i-t,n=0;if(Math.abs(s)<2&&Math.abs(r)<2)return n;var o=this.GetSlideAngle(s,r);return o>=-45&&45>o?n=4:o>=45&&135>o?n=1:o>=-135&&-45>o?n=2:(o>=135&&180>=o||o>=-180&&-135>o)&&(n=3),n},i.prototype.isEnlarge=function(t,e,i,a){var r=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)),s=Math.sqrt((i.x-a.x)*(i.x-a.x)+(i.y-a.y)*(i.y-a.y));return s>r?!0:!1},i._instance=null,i}();t.Input=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.orientation=new t.Vector3D,this.screenOrientation=0,this.openDebug=!1,this.offsetRotation=new t.Vector3D,this.fixOritation=new t.Vector3D,this.state=-1,this.degtorad=Math.PI/180,this.q=new t.Quaternion,this.q1=new t.Quaternion,this.outQ=new t.Quaternion,this.front=new t.Vector3D(0,0,200),this.test=new t.Vector3D,this.openDebug&&(this.accDiv=document.createElement("div"),this.accGravityDiv=document.createElement("div"),this.rotationRateDiv=document.createElement("div"),this.orientationRateDiv=document.createElement("div"),this.stateDiv=document.createElement("div"),this.accDiv.style.color="red",this.accGravityDiv.style.color="red",this.rotationRateDiv.style.color="red",this.orientationRateDiv.style.color="red",this.stateDiv.style.color="red",this.stateDiv.style.fontSize="52",document.body.appendChild(this.accDiv),document.body.appendChild(this.accGravityDiv),document.body.appendChild(this.rotationRateDiv),document.body.appendChild(this.orientationRateDiv),document.body.appendChild(this.stateDiv))}return e.prototype.start=function(){var t=this;this.orientationchangeHandler(),window.addEventListener("orientationchange",function(){return t.orientationchangeHandler()}),window.addEventListener("devicemotion",function(e){return t.motionHandler(e)}),window.addEventListener("deviceorientation",function(e){return t.orientationHandler(e)})},e.prototype.stop=function(){var t=this;window.removeEventListener("orientationchange",function(){return t.orientationchangeHandler()}),window.removeEventListener("devicemotion",function(e){return t.motionHandler(e)}),window.removeEventListener("deviceorientation",function(e){return t.orientationHandler(e)})},e.prototype.orientationchangeHandler=function(){},e.prototype.motionHandler=function(t){this.acc=t.acceleration,this.accGravity=t.accelerationIncludingGravity,this.rotationRate=t.rotationRate},e.prototype.orientationHandler=function(t){this.orientation.x=t.alpha,this.orientation.y=t.beta,this.orientation.z=t.gamma,this.openDebug&&this.debug()},e.prototype.debug=function(){this.accGravityDiv.innerHTML="<br><br> Gravity-x:"+this.orientation.x*t.Matrix3DUtils.RADIANS_TO_DEGREES+"<br>Gravity-y:"+this.orientation.y+"<br>Gravity-z:"+this.orientation.z,this.orientationRateDiv.innerHTML="<br> orientation-x:"+this.fixOritation.x+"<br>orientation-y:"+this.fixOritation.y+"<br>orientation-z:"+this.fixOritation.z,this.stateDiv.innerHTML="<br> state: "+this.state},e.prototype.getOrientation=function(){switch(window.screen.msOrientation){case"landscape-primary":return-90;case"landscape-secondary":return 90;case"portrait-secondary":return 180;case"portrait-primary":return 0}return 0},e.prototype.getQuaternion=function(e,i,a){var r=i?i*this.degtorad:0,s=a?a*this.degtorad:0,n=e?e*this.degtorad:0,o=-this.getOrientation()*this.degtorad;this.state=this.getOrientation();var h=Math.cos(r/2),u=Math.cos(s/2),l=Math.cos(n/2),c=Math.sin(r/2),d=Math.sin(s/2),f=Math.sin(n/2);this.q.w=h*u*l-c*d*f,this.q.x=c*u*l-h*d*f,this.q.y=h*d*l+c*u*f,this.q.z=h*u*f+c*d*l;var p=new t.Vector3D(0,0,1),g=new t.Quaternion;return g.fromAxisAngle(p,o/t.Matrix3DUtils.DEGREES_TO_RADIANS),this.q.multiply(this.q,g),p.setTo(-1,0,0),g.fromAxisAngle(p,90*this.degtorad/t.Matrix3DUtils.DEGREES_TO_RADIANS),this.q.multiply(this.q,g),this.q},e.prototype.update=function(t){this.getQuaternion(this.orientation.x,this.orientation.y,this.orientation.z),this.q.toEulerAngles(this.fixOritation),t.rotationX=-this.fixOritation.x+this.offsetRotation.x,t.rotationZ=-this.fixOritation.y+this.offsetRotation.z,t.rotationY=-this.fixOritation.z+this.offsetRotation.y},e}();t.OrientationController=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.volume=1,this.codecs={},this.hasAudioContext()&&"undefined"!=typeof AudioContext&&(this.context=new AudioContext)}return e.prototype.hasAudio=function(){return"undefined"!=typeof Audio},e.prototype.hasAudioContext=function(){return!("undefined"==typeof AudioContext)},e.prototype.isSupported=function(t,e){null==this.codecs&&(null==e&&(e=new Audio),this.codecs={mp3:!!e.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!e.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")});var i=t.match(/^data:audio\/([^;,]+);/i);return i||(i=t.split("?",1)[0].match(/\.([^.]+)$/)),i&&(i=i[1].toLowerCase()),this.codecs[i]},e.prototype.createSound=function(e,i,a){return void 0===i&&(i=null),void 0===a&&(a=null),new t.Sound(e,i,a)},e.prototype.playSound=function(e,i){i=i||{};var a=new t.Channel(e,i);return a.play(),a},e.prototype.playSound3d=function(e,i,a){a=a||{};var r=new t.Channel3d(e,a);return r.position=i,a.volume&&(r.volume=a.volume),a.loop&&(r.loop=a.loop),a.maxDistance&&(r.maxDistance=a.maxDistance),a.minDistance&&(r.minDistance=a.minDistance),a.rollOffFactor&&(r.rollOffFactor=a.rollOffFactor),r.play(),r},Object.defineProperty(e,"instance",{get:function(){return null==this._instance&&(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),e}();t.AudioManager=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){this.volume=1,this.loop=!1,this.pitch=1,i=i||{},i.volume&&(this.volume=i.volume),i.loop&&(this.loop=i.loop),i.pitch&&(this.pitch=i.pitch),this.sound=e,this.paused=!1,t.AudioManager.instance.hasAudioContext()?(this.context=t.AudioManager.instance.context,this.startTime=0,this.startOffset=0,this.source=null,this.gain=this.context.createGain()):t.AudioManager.instance.hasAudio()&&this.sound.audio&&(this.source=this.sound.audio.cloneNode(!1),this.source.pause())}return e.prototype.play=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source)throw new Error("Call stop() before calling play()");if(this.createSource(),!this.source)return;this.startTime=this.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration)}else t.AudioManager.instance.hasAudio&&(this.paused=!1,this.source.play());this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch)},e.prototype.pause=function(){t.AudioManager.instance.hasAudioContext()?this.source&&(this.startOffset+=this.context.currentTime-this.startTime,this.source.stop(0),this.source=null):t.AudioManager.instance.hasAudio()&&this.source&&this.source.pause(),this.paused=!0},e.prototype.unpause=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source||!this.paused)throw new Error("Call pause() before unpausing.");if(this.createSource(),!this.source)return;this.startTime=this.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch)}else t.AudioManager.instance.hasAudio()&&this.source.play();this.paused=!1},e.prototype.stop=function(){t.AudioManager.instance.hasAudioContext()?this.source&&(this.source.stop(0),this.startOffset=0,this.source=null):t.AudioManager.instance.hasAudio()&&this.source&&(this.source.pause(),this.source.currentTime=0)},e.prototype.setLoop=function(t){this.source&&(this.source.loop=t)},e.prototype.setVolume=function(e){this.gain?this.gain.gain.value=e*t.AudioManager.instance.volume:this.source&&(this.source.volume=e*t.AudioManager.instance.volume)},e.prototype.setPitch=function(e){t.AudioManager.instance.hasAudioContext()?this.source&&(this.source.playbackRate.value=e):t.AudioManager.instance.hasAudio()&&this.source&&(this.source.playbackRate=e)},e.prototype.isPlaying=function(){return t.AudioManager.instance.hasAudioContext()?!this.paused:t.AudioManager.instance.hasAudio()?!this.source.paused:void 0},e.prototype.getDuration=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source)return this.source.buffer.duration}else if(t.AudioManager.instance.hasAudio()&&this.source){var e=this.source.duration;if(e===e)return e}return 0},e.prototype.createSource=function(){var t=this;this.sound.buffer&&(this.source=this.context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(this.context.destination),this.loop&&(this.source.onended=function(){return t.play()}))},e}();t.Channel=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){e.call(this,i,a),this._position=new t.Vector3D,this._velocity=new t.Vector3D,t.AudioManager.instance.hasAudioContext()&&(this._panner=this.context.createPanner()),this._maxDistance=1e4,this._minDistance=1,this._rollOffFactor=1,this._listener=new t.Vector3D}return __extends(i,e),Object.defineProperty(i.prototype,"listener",{get:function(){return this._listener},set:function(t){this._listener.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copyFrom(e),t.AudioManager.instance.hasAudioContext()&&this._panner.setPosition(e.x,e.y,e.z),t.AudioManager.instance.hasAudio()&&this.source){var i=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*i}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"velocity",{get:function(){return this._velocity
},set:function(e){this._velocity.copyFrom(e),t.AudioManager.instance.hasAudioContext()&&this._panner.setVelocity(e.x,e.y,e.z)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,t.AudioManager.instance.hasAudioContext()&&(this._panner.maxDistance=e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._minDistance},set:function(e){this._minDistance=e,t.AudioManager.instance.hasAudioContext()&&(this._panner.refDistance=e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t,this._panner&&(this._panner.rolloffFactor=t)},enumerable:!0,configurable:!0}),i.prototype.createSource=function(){this.source=this.context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this._panner),this._panner.connect(this.gain),this.gain.connect(this.context.destination)},i.prototype.fallOff=function(e,i,a,r,s){var n=t.Vector3D.distance(e,i);if(a>n)return 1;if(n>r)return 0;var o=a+s*(n-a);return 0!==o?a/o:1},i}(t.Channel);t.Channel3d=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i,a){var r=this;if(void 0===i&&(i=null),void 0===a&&(a=null),this.audio=null,this._success=i,this._error=a,this.isLoaded=!1,t.AudioManager.instance.hasAudioContext())t.AudioManager.instance.isSupported(e,this.audio)?(console.warn("Audio format not supported"),a(this)):t.AudioManager.instance.context&&this.loadAudioFile(e);else if(t.AudioManager.instance.hasAudio()){try{this.audio=new Audio}catch(s){return console.warn("No support for Audio element"),void(a&&a(this))}t.AudioManager.instance.isSupported(e,this.audio)?(console.warn("Audio format not supported"),a&&a(this)):(this.audio.src=e,this.audio.addEventListener("canplaythrough",function(t){return r.oncanplaythrough(t)}),this.audio.addEventListener("ended",function(t){return r.onended(t)}),this.audio.load())}}return Object.defineProperty(e.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),e.prototype.loadAudioFile=function(t){var e=this;null==this.xhr&&(this.xhr=new XMLHttpRequest),this.xhr.open("GET",t,!0),this.xhr.responseType="arraybuffer",this.xhr.onload=function(t){return e.audioLoadend(t)},this.xhr.send()},e.prototype.audioLoadend=function(e){var i=this;t.AudioManager.instance.context.decodeAudioData(this.xhr.response,function(t){return i.decodeSuccessCallback(t)})},e.prototype.decodeSuccessCallback=function(t){this._buffer=t,this._success&&this._success(this)},e.prototype.onended=function(t){},e.prototype.oncanplaythrough=function(t){this.isLoaded||(this.isLoaded=!0,this._success&&this._success(this))},e}();t.Sound=e}(egret3d||(egret3d={}));var egret3d;!function(egret3d){var Egret3DEngine=function(){function Egret3DEngine(){}return Egret3DEngine.getXHR=function(){var t=null;return t=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")},Egret3DEngine.preload=function(t){return this._complete=t,null==this._xhr&&(this._xhr=this.getXHR()),null==this._xhr?void alert("Your browser does not support XMLHTTP."):(this._xhr.readyState>0&&this._xhr.abort(),this._xhr.open("GET",this._libUrl,!0),this._xhr.addEventListener("progress",function(t){return Egret3DEngine.onProgress(t)},!1),this._xhr.addEventListener("readystatechange",function(t){return Egret3DEngine.onReadyStateChange(t)},!1),this._xhr.addEventListener("error",function(t){return Egret3DEngine.onError(t)},!1),this._xhr.responseType="text",void this._xhr.send())},Egret3DEngine.onReadyStateChange=function(t){4==this._xhr.readyState&&(this._xhr.status>=400||0==this._xhr.status?console.log(this._libUrl,"load fail"):this.loadComplete())},Egret3DEngine.loadComplete=function(){var t=this._xhr.responseText;this.applyClass(t)},Egret3DEngine.onProgress=function(t){var e=t.loaded.toString()+t.total;console.log("progress event```"+e)},Egret3DEngine.onError=function(t){console.log("load error",t)},Egret3DEngine.applyClass=function(source){for(var obj=eval("("+source+")"),i=0;i<obj.files.length;++i)this.importList[i]="/js/Egret3D/",this.importList[i]+=obj.files[i],this.importList[i]=this.importList[i].replace(".ts",".js");this.startLoadScript(null)},Egret3DEngine.startLoadScript=function(t){var e=this;if(this.importList.length>0){var i=document.createElement("script");i.src=this.importList.shift(),i.onload=function(t){return e.startLoadScript(t)},i.onerror=function(t){return e.loadScriptError(t)},document.head.appendChild(i)}else console.log("all complete"),this._complete()},Egret3DEngine.loadScriptError=function(t){var e="load Script Error \r\n no file:"+t.srcElement.src;alert(e),this.startLoadScript(null)},Egret3DEngine.djs="",Egret3DEngine.importList=new Array,Egret3DEngine._libUrl="/Egret3D/tsconfig.json",Egret3DEngine}();egret3d.Egret3DEngine=Egret3DEngine}(egret3d||(egret3d={}));